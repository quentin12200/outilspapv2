{% extends "base.html" %}
{% block title %}Accueil ‚Äî PAP/CSE{% endblock %}
{% block content %}
{% if request.query_params.get('retour') == '1' %}
  <div style="text-align:center;margin:2rem 0;">
    <a href="/" class="button secondary" style="font-size:1.2em;padding:.7em 2em;">‚¨Ö Retour √† l‚Äôaccueil</a>
  </div>
{% endif %}
<form method="get" action="/" style="display:flex;gap:.5rem;align-items:center">
  <input name="q" value="{{ q or '' }}" placeholder="Rechercher SIRET / Raison sociale" />
  <button type="submit" class="secondary">Rechercher</button>
</form>

<form method="post" action="/api/ingest/invit" enctype="multipart/form-data" style="margin:1rem 0;display:flex;gap:.5rem;align-items:center">
  <label for="invitfile"><strong>Importer invitations PAP (cycle 5) :</strong></label>
  <input type="file" name="file" id="invitfile" required />
  <button type="submit">Envoyer</button>
</form>

<form method="post" action="/api/ingest/pv" enctype="multipart/form-data" style="margin:1rem 0;display:flex;gap:.5rem;align-items:center">
  <label for="pvfile"><strong>Importer PV (Excel, initial) :</strong></label>
  <input type="file" name="file" id="pvfile" required />
  <button type="submit">Envoyer</button>
</form>

<form method="post" action="/api/build/summary" style="margin:1rem 0;display:flex;gap:.5rem;align-items:center">
  <button type="submit"><strong>Mettre √† jour le tableau</strong></button>
</form>

<article>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;"><strong>Derni√®res invitations re√ßues (C5)</strong>
  <button type="button" class="secondary" onclick="toggleFullscreenTable()" style="font-size:1em;padding:.4em 1.2em;">üñµ Voir tableau plein √©cran</button>
</header>
<div style="margin-bottom:1rem;display:flex;gap:.5rem;align-items:center">
  <form method="get" action="/">
    <input type="hidden" name="sort" value="date_pap_c5" />
    <button type="submit" class="secondary">Trier par date PAP la plus r√©cente</button>
  </form>
  <form method="get" action="/">
    <input type="hidden" name="sort" value="inscrits_c3" />
    <button type="submit" class="secondary">Trier par inscrits C3</button>
  </form>
  <form method="get" action="/">
    <input type="hidden" name="sort" value="inscrits_c4" />
    <button type="submit" class="secondary">Trier par inscrits C4</button>
  </form>
</div>
<section style="margin-bottom:1rem">
  <strong>Tableau de synth√®se¬†: PAP les plus r√©cents avec beaucoup d'inscrits</strong>
  <table role="grid" style="font-size:0.95em">
    <thead>
      <tr>
        <th>SIRET</th><th>Raison sociale</th><th>D√©partement</th><th>FD C3</th><th>FD C4</th><th>Date PAP C5</th><th>Inscrits C3</th><th>Inscrits C4</th><th>Pr√©sence CGT</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows|sort(attribute='date_pap_c5', reverse=True) if r.date_pap_c5 %}
      {% if (r.inscrits_c3 or 0) > 100 or (r.inscrits_c4 or 0) > 100 %}
      <tr>
        <td><a href="/siret/{{ r.siret }}">{{ r.siret }}</a></td>
        <td>{{ r.raison_sociale or '' }}</td>
        <td>{{ r.dep or '' }}</td>
        <td>{{ r.fd_c3 or '' }}</td>
        <td>{{ r.fd_c4 or '' }}</td>
        <td>{{ r.date_pap_c5 or '' }}</td>
        <td>{{ r.inscrits_c3 or '' }}</td>
        <td>{{ r.inscrits_c4 or '' }}</td>
        <td>{% if r.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</section>
  <table role="grid">
    <thead>
      <tr>
        <th>SIRET</th><th>Raison sociale</th><th>IDCC</th>
        <th>Date PV C3</th><th>Inscrits C3</th><th>Date PV C4</th><th>Inscrits C4</th>
        <th>Statut</th><th>Date PV max</th><th>Date PAP C5</th>
        <th>Implantation CGT</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td><a href="/siret/{{ r.siret }}">{{ r.siret }}</a></td>
        <td>{{ r.raison_sociale or '' }}</td>
        <td>{{ r.idcc or '' }}</td>
        <td>{{ r.date_pv_c3 or '' }}</td>
        <td>{{ r.inscrits_c3 or '' }}</td>
        <td>{{ r.date_pv_c4 or '' }}</td>
        <td>{{ r.inscrits_c4 or '' }}</td>
        <td>{{ r.statut_pap or '' }}</td>
        <td>{{ r.date_pv_max or '' }}</td>
        <td>{{ r.date_pap_c5 or '' }}</td>
        <td>{% if r.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</article>

<section>
  <details>
    <summary>API rapide</summary>
    <ul>
      <li>POST <code>/api/ingest/pv</code> (upload Excel PV)</li>
      <li>POST <code>/api/ingest/invit</code> (upload Excel invit PAP)</li>
      <li>POST <code>/api/build/summary</code></li>
      <li>GET <code>/api/siret?q=...</code></li>
      <li>GET <code>/api/siret/{siret}</code></li>
    </ul>
  </details>
</section>
{% endblock %}
