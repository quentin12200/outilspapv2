{% extends "base.html" %}
{% block title %}Accueil — PAP/CSE{% endblock %}
{% block content %}
<header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:1.5rem;">
  <div>
    <h1 style="margin:0;font-size:2.1rem;">Correspondances PAP C5 ↔ PV C3/C4</h1>
    <p style="margin:.3rem 0;color:#555;max-width:760px;">
      Analysez les entreprises ayant reçu une invitation PAP (cycle 5) et disposant d’au moins un PV C3 ou C4.
      Ajustez les filtres pour cibler vos priorités syndicales puis exportez depuis l’espace administration.
    </p>
  </div>
  <a href="/admin" class="secondary" style="white-space:nowrap;">⚙️ Administration</a>
</header>

<section style="margin-bottom:1.5rem;">
  <form method="get" class="filters" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;align-items:end;">
    <input type="hidden" name="page" value="1" />
    <input type="hidden" name="per_page" value="{{ pagination.page_size }}" />
    <div>
      <label for="q">Recherche</label>
      <input type="search" id="q" name="q" value="{{ q or '' }}" placeholder="SIRET, raison sociale" />
    </div>
    <div>
      <label for="fd">Fédération (FD)</label>
      <select id="fd" name="fd" multiple size="4">
        {% for option in fd_options %}
        <option value="{{ option }}" {% if option in selected_fd %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="dep">Département</label>
      <select id="dep" name="dep" multiple size="4">
        {% for option in dep_options %}
        <option value="{{ option }}" {% if option in selected_dep %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="presence">Présence C3/C4</label>
      <select id="presence" name="presence" multiple size="4">
        {% for option in presence_options %}
        <option value="{{ option }}" {% if option in selected_presence %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="os">Organisations syndicales</label>
      <input type="text" id="os" name="os" value="{{ selected_os or '' }}" placeholder="CGT, CFDT…" />
    </div>
    <div>
      <label for="date_pv_from">Date PV (du)</label>
      <input type="date" id="date_pv_from" name="date_pv_from" value="{{ date_pv_from or '' }}" />
    </div>
    <div>
      <label for="date_pv_to">Date PV (au)</label>
      <input type="date" id="date_pv_to" name="date_pv_to" value="{{ date_pv_to or '' }}" />
    </div>
    <div>
      <label for="date_pap_from">Date PAP C5 (du)</label>
      <input type="date" id="date_pap_from" name="date_pap_from" value="{{ date_pap_from or '' }}" />
    </div>
    <div>
      <label for="date_pap_to">Date PAP C5 (au)</label>
      <input type="date" id="date_pap_to" name="date_pap_to" value="{{ date_pap_to or '' }}" />
    </div>
    <div style="grid-column:1/-1;display:flex;flex-wrap:wrap;gap:1rem;align-items:center;">
      <label style="display:flex;align-items:center;gap:.5rem;">
        <input type="checkbox" name="all" value="1" {% if show_all %}checked{% endif %} />
        Inclure les SIRET sans correspondance PAP ↔ PV
      </label>
      <div style="margin-left:auto;display:flex;gap:.5rem;align-items:center;">
        <button type="submit">Appliquer les filtres</button>
        <a href="/" class="secondary" style="padding:.5rem 1.1rem;">Réinitialiser</a>
      </div>
    </div>
  </form>
</section>

<section style="margin-bottom:2rem;">
  <h2 style="margin-bottom:.8rem;">Indicateurs globaux</h2>
  <div class="metrics" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;">
    <article class="metric" data-stat="structures_distinct">
      <div class="metric-value">—</div>
      <div class="metric-label">Structures recensées</div>
    </article>
    <article class="metric" data-stat="pap_c5_rows">
      <div class="metric-value">—</div>
      <div class="metric-label">Invitations PAP (C5)</div>
    </article>
    <article class="metric" data-stat="pv_c3_rows">
      <div class="metric-value">—</div>
      <div class="metric-label">PV C3 recensés</div>
    </article>
    <article class="metric" data-stat="pv_c4_rows">
      <div class="metric-value">—</div>
      <div class="metric-label">PV C4 recensés</div>
    </article>
    <article class="metric" data-stat="match_c5_c3_sirets">
      <div class="metric-value">—</div>
      <div class="metric-label">Correspondances PAP ↔ PV C3</div>
    </article>
    <article class="metric" data-stat="match_c5_c4_sirets">
      <div class="metric-value">—</div>
      <div class="metric-label">Correspondances PAP ↔ PV C4</div>
    </article>
  </div>
</section>

<section>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;margin-bottom:1rem;">
    <div>
      <h2 style="margin:0;">Tableau des correspondances</h2>
      {% if not show_all %}
      <small style="color:#666;">Affichage limité aux SIRET disposant d’au moins une invitation PAP C5 et d’un PV C3/C4. Cochez la case ci-dessus pour tout afficher.</small>
      {% else %}
      <small style="color:#666;">Affichage élargi à l’ensemble des SIRET présents dans les invitations ou PV.</small>
      {% endif %}
    </div>
    <div style="text-align:right;color:#444;">
      {% if pagination.total_rows %}
      <div><strong>{{ pagination.total_rows }}</strong> structures</div>
      <div>Résultats {{ pagination.start }} – {{ pagination.end }} (page {{ pagination.page }} / {{ pagination.total_pages }})</div>
      {% endif %}
    </div>
  </header>

  {% if rows %}
  <div style="overflow-x:auto;">
    <table role="grid" style="min-width:960px;">
      <thead>
        <tr>
          <th>SIRET</th>
          <th>Raison sociale</th>
          <th>Département</th>
          <th>FD</th>
          <th>Présence</th>
          <th>OS / scores C3</th>
          <th>OS / scores C4</th>
          <th>Dernier PV</th>
          <th>Date PAP C5</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
        <tr>
          <td><a href="/siret/{{ row.siret }}">{{ row.siret }}</a></td>
          <td>{{ row.raison_sociale or '—' }}</td>
          <td style="text-align:center;">{{ row.departement or '—' }}</td>
          <td style="text-align:center;">{{ row.fd or '—' }}</td>
          <td style="text-align:center;">
            {% if row.presence %}<span class="badge {% if row.presence == 'C3+C4' %}ok{% endif %}">{{ row.presence }}</span>{% else %}—{% endif %}
          </td>
          <td>{{ row.os_c3 or '—' }}</td>
          <td>{{ row.os_c4 or '—' }}</td>
          <td style="text-align:center;">{{ row.date_pv_last or '—' }}</td>
          <td style="text-align:center;">{{ row.date_pap_c5 or '—' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div style="display:flex;flex-wrap:wrap;gap:.8rem;align-items:center;justify-content:space-between;margin-top:1rem;">
    <form method="get" style="margin:0;display:flex;gap:.5rem;align-items:center;">
      {% for key, value in request.query_params.multi_items() %}
        {% if key not in ['page'] %}
        <input type="hidden" name="{{ key }}" value="{{ value }}" />
        {% endif %}
      {% endfor %}
      <input type="hidden" name="page" value="{{ pagination.page - 1 }}" />
      <button type="submit" class="secondary" {% if not pagination.has_prev %}disabled{% endif %}>⟵ Page précédente</button>
    </form>
    <form method="get" style="margin:0;display:flex;gap:.5rem;align-items:center;">
      {% for key, value in request.query_params.multi_items() %}
        {% if key not in ['page'] %}
        <input type="hidden" name="{{ key }}" value="{{ value }}" />
        {% endif %}
      {% endfor %}
      <input type="hidden" name="page" value="{{ pagination.page + 1 }}" />
      <button type="submit" class="secondary" {% if not pagination.has_next %}disabled{% endif %}>Page suivante ⟶</button>
    </form>
    <form method="get" style="margin:0;display:flex;gap:.5rem;align-items:center;">
      {% for key, value in request.query_params.multi_items() %}
        {% if key not in ['per_page','page'] %}
        <input type="hidden" name="{{ key }}" value="{{ value }}" />
        {% endif %}
      {% endfor %}
      <label>Résultats / page
        <select name="per_page" onchange="this.form.submit()">
          {% for size in pagination.sizes %}
          <option value="{{ size }}" {% if size == pagination.page_size %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </label>
    </form>
  </div>
  {% else %}
  <p style="color:#666;">Aucun SIRET ne correspond aux filtres sélectionnés pour le moment.</p>
  {% endif %}
</section>

<script>
(async function loadGlobalStats(){
  try {
    const resp = await fetch('/api/stats/global');
    if (!resp.ok) return;
    const data = await resp.json();
    const tooltips = {
      pap_c5_rows: data.pap_c5_sirets ? `Entreprises distinctes invitées : ${data.pap_c5_sirets}` : '',
      pv_c3_rows: data.pv_c3_sirets ? `SIRET distincts avec PV C3 : ${data.pv_c3_sirets}` : '',
      pv_c4_rows: data.pv_c4_sirets ? `SIRET distincts avec PV C4 : ${data.pv_c4_sirets}` : ''
    };
    document.querySelectorAll('.metric').forEach((metric)=>{
      const key = metric.dataset.stat;
      if (!key || !(key in data)) return;
      const rawValue = data[key];
      const valueNode = metric.querySelector('.metric-value');
      if (valueNode) {
        const numberValue = typeof rawValue === 'number' ? rawValue : Number(rawValue || 0);
        valueNode.textContent = Number.isFinite(numberValue) ? numberValue.toLocaleString('fr-FR') : rawValue;
      }
      if (tooltips[key]) {
        metric.title = tooltips[key];
      }
    });
  } catch (err) {
    console.warn('Impossible de charger les statistiques globales', err);
  }
})();
</script>
{% endblock %}
