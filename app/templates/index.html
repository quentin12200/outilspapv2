{% extends "base.html" %}
{% block title %}Accueil — PAP/CSE{% endblock %}

{% block head %}
<style>
  .stat-card {
    transition: all 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
  }
</style>
{% endblock %}

{% block content %}

<!-- Bouton retour si paramètre retour=1 -->
{% if request.query_params.get('retour') == '1' %}
<div class="mb-6 text-center">
  <a href="/" class="inline-flex items-center px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition shadow-md">
    <i class="fas fa-arrow-left mr-2"></i> Retour à l'accueil
  </a>
</div>
{% endif %}

<!-- Dashboard Stats Section -->
<section class="mb-8" x-data="dashboardData()" x-init="loadStats()">
  <div class="flex items-center justify-between mb-6">
    <h2 class="text-3xl font-bold text-gray-800">
      <i class="fas fa-chart-line text-cgt-red mr-2"></i>
      Tableau de bord
    </h2>
    <button @click="loadStats()" class="px-4 py-2 bg-cgt-red text-white rounded-lg hover:bg-cgt-darkred transition flex items-center space-x-2">
      <i class="fas fa-sync-alt"></i>
      <span>Actualiser</span>
    </button>
  </div>

  <!-- Stats Cards Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- Card 1: Cible audience SIRET -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1">
          <p class="text-sm text-gray-500 uppercase font-semibold">SIRET ≥ <span x-text="stats.audience_threshold || 1000"></span> inscrits (Cycle 4)</p>
          <p class="text-3xl font-bold text-gray-800 mt-2" x-text="stats.audience_siret ? stats.audience_siret.toLocaleString('fr-FR') : '0'">0</p>
        </div>
        <div class="bg-blue-100 rounded-full p-4">
          <i class="fas fa-building text-blue-500 text-2xl"></i>
        </div>
      </div>
      <div class="pt-3 border-t border-gray-100 space-y-1 text-xs">
        <p class="text-gray-600">
          <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 &amp; carences C4 uniquement
        </p>
        <p class="text-gray-500">
          PV tenus C4 : <span x-text="stats.audience_siret_c4_pv ? stats.audience_siret_c4_pv.toLocaleString('fr-FR') : '0'"></span> SIRET
        </p>
        <p class="text-gray-500">
          Carences C4 : <span x-text="stats.audience_siret_c4_carence ? stats.audience_siret_c4_carence.toLocaleString('fr-FR') : '0'"></span> SIRET
        </p>
        <p class="text-gray-500">Part du fichier SIRET : <span x-text="(stats.audience_share_percent || 0) + '%'"></span></p>
        <p class="text-gray-500">Audience cumulée : <span x-text="stats.audience_inscrits ? stats.audience_inscrits.toLocaleString('fr-FR') : '0'"></span> inscrit·es</p>
      </div>
    </div>

    <!-- Card 2: Invitations PAP sur la cible -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1">
          <p class="text-sm text-gray-500 uppercase font-semibold">Invitations PAP C5 ciblées</p>
          <p class="text-3xl font-bold text-gray-800 mt-2" x-text="stats.audience_invitations ? stats.audience_invitations.toLocaleString('fr-FR') : '0'">0</p>
        </div>
        <div class="bg-green-100 rounded-full p-4">
          <i class="fas fa-envelope text-green-500 text-2xl"></i>
        </div>
      </div>
      <div class="pt-3 border-t border-gray-100 space-y-1 text-xs">
        <p class="text-gray-600">
          <i class="fas fa-envelope mr-1"></i><strong>Source :</strong> Invitations C5 filtrées sur la cible ≥ <span x-text="stats.audience_threshold || 1000"></span>
        </p>
        <p class="text-gray-500">Couverture : <span x-text="(stats.audience_invitations_percent || 0) + '%'"></span> des SIRET prioritaires</p>
        <p class="text-gray-500">Restant à inviter : <span x-text="stats.audience_non_invites ? stats.audience_non_invites.toLocaleString('fr-FR') : '0'"></span> SIRET</p>
      </div>
    </div>

    <!-- Card 3: CGT implantée sur la cible -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-cgt-red">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1">
          <p class="text-sm text-gray-500 uppercase font-semibold">CGT implantée (cible)</p>
          <p class="text-3xl font-bold text-gray-800 mt-2">
            <span x-text="stats.audience_cgt_implantee ? stats.audience_cgt_implantee.toLocaleString('fr-FR') : '0'"></span>
            <span class="text-sm text-gray-500 ml-2" x-text="'(' + (stats.audience_cgt_implantee_percent || 0) + '%)'"></span>
          </p>
        </div>
        <div class="bg-red-100 rounded-full p-4">
          <i class="fas fa-flag text-cgt-red text-2xl"></i>
        </div>
      </div>
      <div class="pt-3 border-t border-gray-100 space-y-1 text-xs">
        <p class="text-gray-600">
          <i class="fas fa-vote-yea mr-1"></i><strong>Source :</strong> PV C4 (incl. carences ≥ seuil)
        </p>
        <p class="text-gray-500">SIRET sans implantation : <span x-text="stats.audience_sans_cgt ? stats.audience_sans_cgt.toLocaleString('fr-FR') : '0'"></span></p>
      </div>
    </div>

    <!-- Card 4: Voix CGT sur la cible -->
    <div class="stat-card bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500">
      <div class="flex items-center justify-between mb-3">
        <div class="flex-1">
          <p class="text-sm text-gray-500 uppercase font-semibold">Part des voix CGT (cible)</p>
          <p class="text-3xl font-bold text-gray-800 mt-2" x-text="(stats.audience_voix_percent || 0) + '%'"></p>
        </div>
        <div class="bg-purple-100 rounded-full p-4">
          <i class="fas fa-chart-pie text-purple-500 text-2xl"></i>
        </div>
      </div>
      <div class="pt-3 border-t border-gray-100 space-y-1 text-xs">
        <p class="text-gray-600">
          <i class="fas fa-calendar-alt mr-1"></i><strong>Source :</strong> PV C4
        </p>
        <p class="text-gray-500">
          <span x-text="stats.audience_voix_cgt ? stats.audience_voix_cgt.toLocaleString('fr-FR') : '0'"></span> voix CGT /
          <span x-text="stats.audience_inscrits ? stats.audience_inscrits.toLocaleString('fr-FR') : '0'"></span> inscrit·es
        </p>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Departments Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-gray-800">
          <i class="fas fa-map-marked-alt text-cgt-red mr-2"></i>
          Top 10 départements (C4 ≥ <span x-text="stats.audience_threshold || 1000"></span> inscrit·es)
        </h3>
        <p class="text-xs text-gray-600 mt-1">
          <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 • SIRET prioritaires par département
        </p>
      </div>
      <div style="height: 300px; position: relative;">
        <canvas id="departmentsChart"></canvas>
      </div>
    </div>

    <!-- Monthly Invitations Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-gray-800">
          <i class="fas fa-calendar-alt text-cgt-red mr-2"></i>
          Invitations mensuelles (cible)
        </h3>
        <p class="text-xs text-gray-600 mt-1">
          <i class="fas fa-envelope mr-1"></i><strong>Source :</strong> Invitations C5 • SIRET ≥ <span x-text="stats.audience_threshold || 1000"></span>
        </p>
      </div>
      <div style="height: 300px; position: relative;">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Statut PAP Stats -->
  <div class="bg-white rounded-xl shadow-md p-6 mb-8">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 class="text-xl font-bold text-gray-800">
          <i class="fas fa-info-circle text-cgt-red mr-2"></i>
          Statut PAP des SIRET C4 ≥ <span x-text="stats.audience_threshold || 1000"></span>
        </h3>
        <p class="text-xs text-gray-600 mt-2">
          <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 • SIRET ≥ <span x-text="stats.audience_threshold || 1000"></span> par statut
        </p>
      </div>
    </div>

    <!-- Légende explicative -->
    <div class="mb-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
      <p class="text-xs text-gray-700">
        <i class="fas fa-lightbulb text-blue-600 mr-1"></i>
        <strong>Explication :</strong>
        Les statuts indiquent pour quels cycles un SIRET ≥ <span x-text="stats.audience_threshold || 1000"></span> a eu des Procès-Verbaux :
      </p>
      <ul class="mt-2 ml-4 text-xs text-gray-600 space-y-1">
        <li>• <strong>C4</strong> : PV tenu ou carence enregistrée au Cycle 4 (2021-2024)</li>
        <li>• <strong>C3+C4</strong> : Historique C3 mais C4 prioritaire</li>
        <li>• <strong>Aucun</strong> : Pas de PV enregistré</li>
      </ul>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <template x-for="stat in stats.statut_stats || []" :key="stat.statut">
        <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition">
          <p class="text-2xl font-bold text-cgt-red" x-text="stat.count">0</p>
          <p class="text-sm text-gray-600 mt-1 font-semibold" x-text="stat.statut">-</p>
          <p class="text-xs text-gray-500 mt-1">SIRET</p>
        </div>
      </template>
    </div>
  </div>
</section>

<!-- Search Section -->
<section class="bg-white rounded-xl shadow-md p-6 mb-8">
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
    <h3 class="text-2xl font-bold text-gray-800">
      <i class="fas fa-search text-cgt-red mr-2"></i>
      Recherche
    </h3>
    <a href="/admin" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition shadow-md flex items-center space-x-2">
      <i class="fas fa-cog"></i>
      <span>Accéder à l'Administration</span>
    </a>
  </div>

  <!-- Search and Filter Form -->
  <form method="get" action="/"
        x-data="{
          showFilters: {{ 'true' if (fd or dep or statut or cgt_implantee) else 'false' }},
          searchQuery: '{{ q or '' }}',
          searchResults: [],
          showResults: false,
          async searchAutocomplete() {
            if (this.searchQuery.length < 2) {
              this.searchResults = [];
              this.showResults = false;
              return;
            }
            try {
              const response = await fetch(`/api/search/autocomplete?q=${encodeURIComponent(this.searchQuery)}`);
              this.searchResults = await response.json();
              this.showResults = this.searchResults.length > 0;
            } catch (error) {
              console.error('Erreur autocomplete:', error);
            }
          },
          selectResult(result) {
            window.location.href = `/siret/${result.siret}`;
          }
        }">
    <!-- Search Bar -->
    <div class="flex flex-col md:flex-row gap-3 mb-4">
      <div class="flex-1 relative">
        <input name="q"
               x-model="searchQuery"
               @input.debounce.300ms="searchAutocomplete"
               @focus="if (searchQuery.length >= 2) searchAutocomplete()"
               @click.away="showResults = false"
               placeholder="Rechercher SIRET / Raison sociale..."
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent" />

        <!-- Autocomplete Results -->
        <div x-show="showResults"
             x-transition
             class="absolute z-50 w-full mt-2 bg-white border border-gray-300 rounded-lg shadow-xl max-h-96 overflow-y-auto">
          <template x-for="result in searchResults" :key="result.siret">
            <div @click="selectResult(result)"
                 class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="font-semibold text-gray-800" x-text="result.raison_sociale"></p>
                  <p class="text-sm text-gray-600 mt-1">
                    <span class="font-mono text-blue-600" x-text="result.siret"></span>
                    <span x-show="result.ville" class="ml-2">
                      • <span x-text="result.ville"></span>
                    </span>
                    <span x-show="result.dep" class="ml-2 px-2 py-0.5 bg-gray-200 rounded text-xs" x-text="result.dep"></span>
                  </p>
                </div>
                <div x-show="result.date_pap_c5" class="ml-4 text-xs text-gray-500">
                  <i class="fas fa-envelope mr-1"></i>
                  <span x-text="result.date_pap_c5"></span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <button type="submit" class="px-6 py-3 bg-cgt-red text-white rounded-lg hover:bg-cgt-darkred transition flex items-center justify-center space-x-2">
        <i class="fas fa-search"></i>
        <span>Rechercher</span>
      </button>
    </div>

    <!-- Toggle Filters Button -->
    <div class="mb-4">
      <button type="button" @click="showFilters = !showFilters"
              class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition flex items-center space-x-2">
        <i class="fas" :class="showFilters ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        <span>Filtres avancés</span>
        {% if fd or dep or statut or cgt_implantee %}
        <span class="ml-2 px-2 py-1 bg-cgt-red text-white text-xs rounded-full">Actifs</span>
        {% endif %}
      </button>
    </div>

    <!-- Advanced Filters -->
    <div x-show="showFilters" x-transition class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
      <!-- Filtre FD -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-building text-blue-500 mr-1"></i>
          Fédération (FD)
        </label>
        <select name="fd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes les FD</option>
          {% for f in all_fds %}
          <option value="{{ f }}" {% if fd == f %}selected{% endif %}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre Département -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-map-marker-alt text-green-500 mr-1"></i>
          Département
        </label>
        <select name="dep" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous les départements</option>
          {% for d in all_deps %}
          <option value="{{ d }}" {% if dep == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre Statut PAP -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-info-circle text-purple-500 mr-1"></i>
          Statut PAP
        </label>
        <select name="statut" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous les statuts</option>
          <option value="C3" {% if statut == 'C3' %}selected{% endif %}>C3</option>
          <option value="C4" {% if statut == 'C4' %}selected{% endif %}>C4</option>
          <option value="C3+C4" {% if statut == 'C3+C4' %}selected{% endif %}>C3+C4</option>
          <option value="Aucun" {% if statut == 'Aucun' %}selected{% endif %}>Aucun</option>
        </select>
      </div>

      <!-- Filtre CGT Implantée -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-flag text-cgt-red mr-1"></i>
          CGT Implantée
        </label>
        <select name="cgt_implantee" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous</option>
          <option value="oui" {% if cgt_implantee == 'oui' %}selected{% endif %}>Oui</option>
          <option value="non" {% if cgt_implantee == 'non' %}selected{% endif %}>Non</option>
        </select>
      </div>

      <!-- Hidden field to preserve sort -->
      <input type="hidden" name="sort" value="{{ sort }}">

      <!-- Action Buttons -->
      <div class="col-span-1 md:col-span-2 lg:col-span-4 flex gap-3 justify-end">
        <a href="/" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition flex items-center space-x-2">
          <i class="fas fa-times"></i>
          <span>Réinitialiser</span>
        </a>
        <button type="submit" class="px-6 py-2 bg-cgt-red text-white rounded-lg hover:bg-cgt-darkred transition flex items-center space-x-2">
          <i class="fas fa-filter"></i>
          <span>Appliquer les filtres</span>
        </button>
      </div>
    </div>
  </form>
</section>

<!-- PAP Table with Filters and Sorting -->
<section class="bg-white rounded-xl shadow-md p-6">
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
    <h3 class="text-2xl font-bold text-gray-800">
      <i class="fas fa-table text-cgt-red mr-2"></i>
      Invitations PAP - Cycle 5
    </h3>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3">
      <button onclick="toggleFullscreenTable('pap-table')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
        <i class="fas fa-expand mr-2"></i>
        Plein écran
      </button>
    </div>
  </div>

  <!-- Sort Buttons -->
  <div class="flex flex-wrap gap-3 mb-6">
    <a href="/?sort=date_pap_c5{% if q %}&q={{ q }}{% endif %}{% if fd %}&fd={{ fd }}{% endif %}{% if dep %}&dep={{ dep }}{% endif %}{% if statut %}&statut={{ statut }}{% endif %}{% if cgt_implantee %}&cgt_implantee={{ cgt_implantee }}{% endif %}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'date_pap_c5' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-calendar mr-2"></i>Trier par Date PAP
    </a>
    <a href="/?sort=inscrits_c3{% if q %}&q={{ q }}{% endif %}{% if fd %}&fd={{ fd }}{% endif %}{% if dep %}&dep={{ dep }}{% endif %}{% if statut %}&statut={{ statut }}{% endif %}{% if cgt_implantee %}&cgt_implantee={{ cgt_implantee }}{% endif %}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'inscrits_c3' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-sort-numeric-down mr-2"></i>Trier par Inscrits C3
    </a>
    <a href="/?sort=inscrits_c4{% if q %}&q={{ q }}{% endif %}{% if fd %}&fd={{ fd }}{% endif %}{% if dep %}&dep={{ dep }}{% endif %}{% if statut %}&statut={{ statut }}{% endif %}{% if cgt_implantee %}&cgt_implantee={{ cgt_implantee }}{% endif %}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'inscrits_c4' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-sort-numeric-down mr-2"></i>Trier par Inscrits C4
    </a>
  </div>

  <!-- Top departments by invitations -->
  <div class="mb-8">
    <h4 class="text-lg font-bold text-gray-700 mb-4">Top 10 des départements par invitations PAP C5</h4>
    {% if top_departments %}
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200" data-sortable="true">
        <thead class="bg-gradient-to-r from-cgt-red to-cgt-darkred text-white">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Rang</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Département</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Invitations PAP C5</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for entry in top_departments %}
          <tr class="table-row-hover hover:bg-cgt-lightred">
            <td class="px-4 py-3 font-semibold text-gray-700" data-rank-cell data-sort-value="{{ loop.index }}">#{{ loop.index }}</td>
            <td class="px-4 py-3 whitespace-nowrap">{{ entry.dep }}</td>
            <td class="px-4 py-3" data-sort-value="{{ entry.count }}">
              <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                {{ entry.count }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-sm text-gray-500">Aucune invitation PAP C5 n'a été enregistrée.</p>
    {% endif %}
  </div>

  <!-- Full Table -->
  <div>
    <h4 class="text-lg font-bold text-gray-700 mb-4">Toutes les invitations (100 premières)</h4>
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table id="pap-table" class="min-w-full divide-y divide-gray-200" data-sortable="true">
        <thead class="bg-gradient-to-r from-cgt-red to-cgt-darkred text-white">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">SIRET</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Raison sociale</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">IDCC</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV C3</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Inscrits C3</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV C4</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Inscrits C4</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Statut</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV Max</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PAP C5</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">CGT</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for r in rows %}
          <tr class="table-row-hover hover:bg-cgt-lightred">
            <td class="px-4 py-3 whitespace-nowrap">
              <a href="/siret/{{ r.siret }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ r.siret }}</a>
            </td>
            <td class="px-4 py-3">{{ r.raison_sociale or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap">{{ r.idcc or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pv_c3 or '' }}">{{ r.date_pv_c3 or '' }}</td>
            <td class="px-4 py-3 text-center" data-sort-value="{{ r.inscrits_c3 if r.inscrits_c3 is not none else '' }}">{{ r.inscrits_c3 or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pv_c4 or '' }}">{{ r.date_pv_c4 or '' }}</td>
            <td class="px-4 py-3 text-center" data-sort-value="{{ r.inscrits_c4 if r.inscrits_c4 is not none else '' }}">{{ r.inscrits_c4 or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap">{{ r.statut_pap or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pv_max or '' }}">{{ r.date_pv_max or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pap_c5 or '' }}">{{ r.date_pap_c5 or '' }}</td>
            <td class="px-4 py-3 text-center">
              {% if r.cgt_implantee %}
              <span class="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-bold">OUI</span>
              {% else %}
              <span class="px-3 py-1 bg-gray-300 text-gray-700 rounded-full text-xs font-bold">NON</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- API Quick Reference -->
<section class="bg-gray-100 rounded-xl p-6 mt-8">
  <details>
    <summary class="cursor-pointer text-lg font-bold text-gray-800 hover:text-cgt-red transition">
      <i class="fas fa-code mr-2"></i>API Rapide - Documentation
    </summary>
    <div class="mt-4 space-y-2 text-sm">
      <div class="flex items-start space-x-3 bg-white p-3 rounded-lg">
        <span class="px-2 py-1 bg-green-600 text-white rounded text-xs font-bold">POST</span>
        <code class="flex-1 text-gray-700">/api/ingest/pv</code>
        <span class="text-gray-500">Upload Excel PV</span>
      </div>
      <div class="flex items-start space-x-3 bg-white p-3 rounded-lg">
        <span class="px-2 py-1 bg-green-600 text-white rounded text-xs font-bold">POST</span>
        <code class="flex-1 text-gray-700">/api/ingest/invit</code>
        <span class="text-gray-500">Upload Excel invitations PAP</span>
      </div>
      <div class="flex items-start space-x-3 bg-white p-3 rounded-lg">
        <span class="px-2 py-1 bg-green-600 text-white rounded text-xs font-bold">POST</span>
        <code class="flex-1 text-gray-700">/api/build/summary</code>
        <span class="text-gray-500">Recalculer le tableau de synthèse</span>
      </div>
      <div class="flex items-start space-x-3 bg-white p-3 rounded-lg">
        <span class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">GET</span>
        <code class="flex-1 text-gray-700">/api/siret?q=...</code>
        <span class="text-gray-500">Rechercher SIRET</span>
      </div>
      <div class="flex items-start space-x-3 bg-white p-3 rounded-lg">
        <span class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">GET</span>
        <code class="flex-1 text-gray-700">/api/siret/{siret}</code>
        <span class="text-gray-500">Détails d'un SIRET</span>
      </div>
      <div class="flex items-start space-x-3 bg-white p-3 rounded-lg">
        <span class="px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">GET</span>
        <code class="flex-1 text-gray-700">/api/stats/dashboard</code>
        <span class="text-gray-500">Statistiques du tableau de bord</span>
      </div>
    </div>
  </details>
</section>

<!-- Alpine.js Dashboard Data -->
<script>
  function dashboardData() {
    return {
      stats: {},
      loading: false,

      async loadStats() {
        this.loading = true;
        try {
          const response = await fetch('/api/stats/dashboard');
          this.stats = await response.json();

          // Render charts after stats are loaded
          this.$nextTick(() => {
            this.renderDepartmentsChart();
            this.renderMonthlyChart();
          });
        } catch (error) {
          console.error('Error loading stats:', error);
          showToast('Erreur lors du chargement des statistiques', 'error');
        } finally {
          this.loading = false;
        }
      },

      renderDepartmentsChart() {
        const ctx = document.getElementById('departmentsChart');
        if (!ctx || !this.stats.departments) return;

        const threshold = this.stats.audience_threshold || 1000;

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: this.stats.departments.map(d => d.dep),
            datasets: [{
              label: `SIRET ≥ ${threshold} inscrits`,
              data: this.stats.departments.map(d => d.count),
              backgroundColor: '#d5001c',
              borderColor: '#ab0015',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      },

      renderMonthlyChart() {
        const ctx = document.getElementById('monthlyChart');
        if (!ctx || !this.stats.monthly_invitations) return;

        const threshold = this.stats.audience_threshold || 1000;

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: this.stats.monthly_invitations.map(m => m.month),
            datasets: [{
              label: `Invitations (≥ ${threshold})`,
              data: this.stats.monthly_invitations.map(m => m.count),
              borderColor: '#d5001c',
              backgroundColor: 'rgba(213, 0, 28, 0.1)',
              fill: true,
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      }
    }
  }

  // Fullscreen table toggle
  function toggleFullscreenTable(id) {
    const table = document.getElementById(id);
    if (!table) return;
    if (table.requestFullscreen) {
      table.requestFullscreen();
    } else if (table.webkitRequestFullscreen) {
      table.webkitRequestFullscreen();
    }
  }
</script>

{% endblock %}
