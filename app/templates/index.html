{% extends "base.html" %}
{% block title %}Accueil — PAP/CSE{% endblock %}

{% block head %}
<style>
  [x-cloak] {
    display: none !important;
  }
  .stat-card {
    transition: all 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
  }
</style>
{% endblock %}

{% block content %}

<!-- Bouton retour si paramètre retour=1 -->
{% if request.query_params.get('retour') == '1' %}
<div class="mb-6 text-center">
  <a href="/" class="inline-flex items-center px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition shadow-md">
    <i class="fas fa-arrow-left mr-2"></i> Retour à l'accueil
  </a>
</div>
{% endif %}

<!-- Dashboard Stats Section -->
<section class="mb-8 relative" x-data="dashboardData()" x-init="loadStats()">
  <div
    x-cloak
    x-show="loading"
    x-transition.opacity.duration.300ms
    class="absolute inset-0 z-20 flex items-center justify-center bg-white/80"
  >
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md space-y-6 text-center border border-gray-200">
      <div class="flex justify-center">
        <span class="w-16 h-16 border-4 border-cgt-red border-t-transparent rounded-full animate-spin"></span>
      </div>
      <div>
        <p class="text-lg font-semibold text-gray-800">Chargement des données…</p>
        <p class="text-sm text-gray-500">Merci de patienter, les indicateurs se préparent.</p>
      </div>
      <div class="space-y-2">
        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
          <div
            class="bg-cgt-red h-2 transition-all duration-200 ease-out"
            :style="`width: ${loadingProgress}%`"
          ></div>
        </div>
        <p class="text-sm font-medium text-gray-600" x-text="`${loadingProgress}%`"></p>
      </div>
    </div>
  </div>

  <div :class="{ 'pointer-events-none select-none opacity-60': loading }" class="space-y-10">
    <div class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-cgt-red via-cgt-darkred to-gray-900 text-white shadow-2xl">
      <div class="absolute inset-0 opacity-30 bg-[radial-gradient(circle_at_top_right,rgba(255,255,255,0.8),transparent_60%)]"></div>
      <div class="relative px-8 py-12 lg:px-16 flex flex-col lg:flex-row gap-10 lg:items-center lg:justify-between">
        <div class="space-y-6 max-w-2xl">
          <div class="flex flex-wrap items-center gap-3">
            <span class="inline-flex items-center px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] rounded-full bg-white/10">Tableau de bord</span>
            <button @click="loadStats()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/15 hover:bg-white/25 transition text-sm font-semibold">
              <i class="fas fa-sync-alt"></i>
              Actualiser
            </button>
          </div>
          <h2 class="text-3xl lg:text-4xl font-black leading-tight">Piloter les invitations PAP et les scrutins C5 prioritaires</h2>
          <p class="text-white/80 text-base">
            Visualisez la cible ≥ <span x-text="stats.audience_threshold || 1000">1000</span> inscrit·es, contrôlez les invitations PAP C5 et mesurez les correspondances avec les historiques C3/C4 pour préparer au mieux le cycle 5.
          </p>
          <template x-if="$store.globalFilter.hasActiveFilter()">
            <div class="inline-flex items-center gap-2 px-3 py-2 bg-white/20 border border-white/30 rounded-full text-sm font-semibold text-white">
              <i class="fas fa-filter"></i>
              <span>Filtre appliqué :</span>
              <span x-text="stats.global_filter?.label || $store.globalFilter.getActiveFilterLabel()"></span>
            </div>
          </template>
          <div class="flex flex-wrap gap-3">
            <a href="/calendrier" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-white text-cgt-red font-semibold shadow-lg hover:bg-gray-100 transition">
              <i class="fas fa-calendar-alt"></i>
              Calendrier C5 +1000
            </a>
            <a href="/recherche-siret" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl border border-white/60 text-white font-semibold hover:bg-white/10 transition">
              <i class="fas fa-search"></i>
              Recherche SIRET
            </a>
            <a href="/admin" class="inline-flex items-center gap-2 px-5 py-3 rounded-xl border border-white/60 text-white font-semibold hover:bg-white/10 transition">
              <i class="fas fa-cogs"></i>
              Administration
            </a>
          </div>
        </div>
        <div class="w-full lg:w-auto grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="backdrop-blur bg-white/10 border border-white/20 rounded-2xl p-5 space-y-3">
            <p class="text-xs font-semibold uppercase tracking-widest text-white/70">Aperçu des statuts PAP</p>
            <template x-if="!stats.statut_stats || stats.statut_stats.length === 0">
              <p class="text-sm text-white/70">Les statuts seront affichés dès qu'ils seront disponibles.</p>
            </template>
            <template x-if="stats.statut_stats && stats.statut_stats.length">
              <div class="space-y-2">
                <template x-for="entry in stats.statut_stats.slice(0, 5)" :key="entry.statut || 'inconnu'">
                  <div class="flex items-center justify-between gap-3 bg-white/10 rounded-xl px-3 py-2">
                    <span class="inline-flex items-center gap-2 text-sm font-semibold text-white">
                      <span class="inline-flex items-center justify-center w-2 h-2 rounded-full bg-white/60"></span>
                      <span x-text="entry.statut || 'Sans statut'"></span>
                    </span>
                    <span class="text-sm font-bold text-white/80" x-text="entry.count != null ? entry.count.toLocaleString('fr-FR') : '—'"></span>
                  </div>
                </template>
              </div>
            </template>
            <p class="text-xs text-white/60">Top 5 des statuts observés sur la cible ≥ <span x-text="stats.audience_threshold || 1000"></span> inscrit·es.</p>
          </div>
          <div class="backdrop-blur bg-white/10 border border-white/20 rounded-2xl p-5 space-y-2">
            <p class="text-xs font-semibold uppercase tracking-widest text-white/70">Autres possessions</p>
            <p class="text-3xl font-bold" x-text="stats.autres_possessions_total != null ? stats.autres_possessions_total.toLocaleString('fr-FR') : '—'">—</p>
            <p class="text-sm text-white/70">SIRET disposant d'un historique C3 et/ou C4 (carence comprise)</p>
            <p class="text-xs text-white/60">
              C3 : <span class="font-semibold" x-text="stats.autres_possessions_c3 != null ? stats.autres_possessions_c3.toLocaleString('fr-FR') : '—'"></span>
              · C4 : <span class="font-semibold" x-text="stats.autres_possessions_c4 != null ? stats.autres_possessions_c4.toLocaleString('fr-FR') : '—'"></span>
            </p>
          </div>
          <div class="backdrop-blur bg-white/10 border border-white/20 rounded-2xl p-5 space-y-2">
            <p class="text-xs font-semibold uppercase tracking-widest text-white/70">Invitations PAP reçues</p>
            <p class="text-3xl font-bold" x-text="stats.invitations_period_total != null ? stats.invitations_period_total.toLocaleString('fr-FR') : '—'">—</p>
            <p class="text-sm text-white/70">
              Période :
              <span x-text="stats.invitations_period_start_display || '—'"></span>
              →
              <span x-text="stats.invitations_period_end_display || '—'"></span>
            </p>
            <p class="text-xs text-white/60">Total invitations C5 :
              <span class="font-semibold" x-text="stats.global_stats && stats.global_stats.invit_total != null ? stats.global_stats.invit_total.toLocaleString('fr-FR') : '—'"></span>
            </p>
          </div>
          <div class="backdrop-blur bg-white/10 border border-white/20 rounded-2xl p-5 space-y-2">
            <p class="text-xs font-semibold uppercase tracking-widest text-white/70">Correspondances PAP ↔ PV</p>
            <p class="text-3xl font-bold" x-text="stats.pap_pv_overlap != null ? stats.pap_pv_overlap.toLocaleString('fr-FR') : '—'">—</p>
            <p class="text-sm text-white/70">SIRET invités PAP C5 retrouvés dans la base PV (C3 + C4)</p>
            <p class="text-xs text-white/60">Couverture invitations :
              <span class="font-semibold" x-text="stats.pap_pv_overlap_percent != null ? stats.pap_pv_overlap_percent.toLocaleString('fr-FR') + ' %' : '—'"></span>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.4em] text-gray-500">Statistiques consolidées</p>
        <p class="text-sm text-gray-600">Synthèse alignée sur le module d'administration</p>
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
      <div class="stat-card bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 border border-blue-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-blue-600">PV enregistrés</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.pv_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl"><i class="fas fa-poll"></i></span>
        </div>
        <p class="text-xs text-gray-600">SIRET distincts : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.pv_sirets || 0).toLocaleString('fr-FR') : '0'"></span></p>
      </div>
      <div class="stat-card bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 border border-green-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-green-600">Résumé SIRET</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.summary_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl"><i class="fas fa-database"></i></span>
        </div>
        <p class="text-xs text-gray-600">Dernier PV enregistré : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.last_summary || '—') : '—'"></span></p>
      </div>
      <div class="stat-card bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 border border-red-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-cgt-red">Invitations PAP C5</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.invit_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-red-100 text-cgt-red flex items-center justify-center text-xl"><i class="fas fa-envelope-open-text"></i></span>
        </div>
        <p class="text-xs text-gray-600">Dernière invitation : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.last_invitation || '—') : '—'"></span></p>
      </div>
      <div class="stat-card bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 border border-purple-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-purple-600">Élections C5 ≥ <span x-text="stats.global_stats ? (stats.global_stats.upcoming_threshold || 1000).toLocaleString('fr-FR') : 1000"></span></p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.upcoming_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl"><i class="fas fa-calendar-day"></i></span>
        </div>
        <p class="text-xs text-gray-600">Prochaine échéance : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.upcoming_next || '—') : '—'"></span></p>
        <p class="text-xs text-gray-600">Période cycle 5 :
          <span class="font-semibold"
                x-text="formatUpcomingPeriod(stats.audience_upcoming_period_start_display, stats.audience_upcoming_period_end_display)"></span>
        </p>
        <p class="text-xs text-gray-600">Fenêtre déclarée :
          <span class="font-semibold"
                x-text="formatUpcomingPeriod(stats.audience_upcoming_coverage_start_display, stats.audience_upcoming_coverage_end_display)"></span>
        </p>
        <p class="text-xs text-gray-600">Part de la cible :
          <span class="font-semibold"
                x-text="stats.audience_upcoming_declared_percent != null ? stats.audience_upcoming_declared_percent.toLocaleString('fr-FR') + ' %' : '—'"></span>
        </p>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Departments Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="mb-4 flex items-start justify-between gap-3">
        <div>
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-map-marked-alt text-cgt-red mr-2"></i>
            Top 10 départements (C4 ≥ <span x-text="stats.audience_threshold || 1000"></span> inscrit·es)
          </h3>
          <p class="text-xs text-gray-600 mt-1">
            <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 • SIRET prioritaires par département
          </p>
        </div>
        <button
          type="button"
          class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 hover:text-cgt-red hover:border-cgt-red transition disabled:opacity-40 disabled:cursor-not-allowed"
          @click="openChartModal('departments')"
          :disabled="!stats.departments || !stats.departments.length"
          title="Agrandir le graphique"
          aria-label="Agrandir le graphique des départements"
          aria-haspopup="dialog"
        >
          <i class="fas fa-up-right-and-down-left-from-center"></i>
        </button>
      </div>
      <div style="height: 300px; position: relative;">
        <canvas id="departmentsChart"></canvas>
      </div>
    </div>

    <!-- Monthly Invitations Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="mb-4 flex items-start justify-between gap-3">
        <div>
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-calendar-alt text-cgt-red mr-2"></i>
            Invitations mensuelles (cible)
          </h3>
          <p class="text-xs text-gray-600 mt-1">
            <i class="fas fa-envelope mr-1"></i><strong>Source :</strong> Invitations C5 (toutes entrées)
          </p>
        </div>
        <button
          type="button"
          class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 hover:text-cgt-red hover:border-cgt-red transition disabled:opacity-40 disabled:cursor-not-allowed"
          @click="openChartModal('monthly')"
          :disabled="!stats.monthly_invitations || !stats.monthly_invitations.length"
          title="Agrandir le graphique"
          aria-label="Agrandir le graphique des invitations mensuelles"
          aria-haspopup="dialog"
        >
          <i class="fas fa-up-right-and-down-left-from-center"></i>
        </button>
      </div>
      <div style="height: 300px; position: relative;">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>

    <!-- Upcoming Elections Chart -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <div class="mb-4 flex items-start justify-between gap-3">
        <div>
          <h3 class="text-xl font-bold text-gray-800">
            <i class="fas fa-hourglass-half text-cgt-red mr-2"></i>
            Prochaines élections C5 (2025-2028 · par trimestre)
          </h3>
          <p class="text-xs text-gray-600 mt-1">
            <i class="fas fa-calendar-day mr-1"></i><strong>Source :</strong> Dates prévisionnelles C5 (tous effectifs)
          </p>
        </div>
        <button
          type="button"
          class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 hover:text-cgt-red hover:border-cgt-red transition disabled:opacity-40 disabled:cursor-not-allowed"
          @click="openChartModal('quarters')"
          :disabled="!stats.upcoming_quarters || !stats.upcoming_quarters.length"
          title="Agrandir le graphique"
          aria-label="Agrandir le graphique des élections C5"
          aria-haspopup="dialog"
        >
          <i class="fas fa-up-right-and-down-left-from-center"></i>
        </button>
      </div>
      <div style="height: 300px; position: relative;">
        <canvas id="quartersChart"></canvas>
      </div>
    </div>
  </div>

    <div
      x-cloak
      x-show="expandedChart"
      x-transition.opacity
      class="fixed inset-0 z-40 flex items-center justify-center bg-black/60 px-4"
      @keydown.escape.window="closeChartModal()"
      role="dialog"
      aria-modal="true"
      aria-labelledby="chartModalTitle"
      aria-describedby="chartModalSource"
    >
      <div class="absolute inset-0" @click="closeChartModal()"></div>
      <div class="relative z-10 w-full max-w-6xl bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 space-y-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h2
              id="chartModalTitle"
              class="text-base font-semibold uppercase tracking-widest text-cgt-red"
              x-text="getChartTitle(expandedChart)"
            ></h2>
            <p
              id="chartModalSource"
              class="text-xs text-gray-500 mt-1"
              x-text="getChartSource(expandedChart)"
            ></p>
          </div>
          <button
            type="button"
            class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 text-gray-600 hover:bg-cgt-red hover:text-white transition"
            @click="closeChartModal()"
            title="Fermer"
          >
            <i class="fas fa-xmark text-lg"></i>
          </button>
        </div>
        <div class="h-[70vh]">
          <canvas id="expandedChartCanvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Statut PAP Stats -->
    <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg border border-gray-200 p-6 mb-4">
    <div class="flex items-start justify-between mb-4">
      <div>
        <h3 class="text-xl font-bold text-gray-800">
          <i class="fas fa-info-circle text-cgt-red mr-2"></i>
          Statut PAP des SIRET C4 ≥ <span x-text="stats.audience_threshold || 1000"></span>
        </h3>
        <p class="text-xs text-gray-600 mt-2">
          <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 • SIRET ≥ <span x-text="stats.audience_threshold || 1000"></span> par statut
        </p>
      </div>
    </div>

    <!-- Légende explicative -->
    <div class="mb-4 rounded-xl border border-blue-200 bg-blue-50/70 p-4">
      <p class="text-xs text-blue-900 font-semibold flex items-center gap-2">
        <i class="fas fa-lightbulb"></i>
        Comprendre les statuts PAP
      </p>
      <ul class="mt-2 text-xs text-blue-900/80 space-y-1">
        <li><strong>C4</strong> : PV tenu ou carence enregistrée (2021-2024)</li>
        <li><strong>C3+C4</strong> : Historique C3 mais C4 prioritaire</li>
        <li><strong>Aucun</strong> : Aucun PV consolidé</li>
      </ul>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <template x-for="stat in stats.statut_stats || []" :key="stat.statut">
        <div class="text-center p-4 bg-gray-50 rounded-lg border border-gray-200 hover:shadow-md transition">
          <p class="text-2xl font-bold text-cgt-red" x-text="stat.count">0</p>
          <p class="text-sm text-gray-600 mt-1 font-semibold" x-text="stat.statut">-</p>
          <p class="text-xs text-gray-500 mt-1">SIRET</p>
        </div>
      </template>
    </div>
  </div>
  </div>
</section>

<!-- Search Section -->
<section class="bg-white rounded-xl shadow-md p-6 mb-8">
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 mb-6">
    <h3 class="text-2xl font-bold text-gray-800">
      <i class="fas fa-search text-cgt-red mr-2"></i>
      Recherche
    </h3>
    <a href="/admin" class="px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition shadow-md flex items-center space-x-2">
      <i class="fas fa-cog"></i>
      <span>Accéder à l'Administration</span>
    </a>
  </div>

  <!-- Search and Filter Form -->
  <form method="get" action="/"
        x-data="{
          showFilters: {{ 'true' if (fd or dep or statut or cgt_implantee) else 'false' }},
          searchQuery: '{{ q or '' }}',
          searchResults: [],
          showResults: false,
          async searchAutocomplete() {
            if (this.searchQuery.length < 2) {
              this.searchResults = [];
              this.showResults = false;
              return;
            }
            try {
              const response = await fetch(`/api/search/autocomplete?q=${encodeURIComponent(this.searchQuery)}`);
              this.searchResults = await response.json();
              this.showResults = this.searchResults.length > 0;
            } catch (error) {
              console.error('Erreur autocomplete:', error);
            }
          },
          selectResult(result) {
            window.location.href = `/siret/${result.siret}`;
          }
        }">
    <!-- Search Bar -->
    <div class="flex flex-col md:flex-row gap-3 mb-4">
      <div class="flex-1 relative">
        <input name="q"
               x-model="searchQuery"
               @input.debounce.300ms="searchAutocomplete"
               @focus="if (searchQuery.length >= 2) searchAutocomplete()"
               @click.away="showResults = false"
               placeholder="Rechercher SIRET / Raison sociale..."
               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent" />

        <!-- Autocomplete Results -->
        <div x-show="showResults"
             x-transition
             class="absolute z-50 w-full mt-2 bg-white border border-gray-300 rounded-lg shadow-xl max-h-96 overflow-y-auto">
          <template x-for="result in searchResults" :key="result.siret">
            <div @click="selectResult(result)"
                 class="px-4 py-3 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="font-semibold text-gray-800" x-text="result.raison_sociale"></p>
                  <p class="text-sm text-gray-600 mt-1">
                    <span class="font-mono text-blue-600" x-text="result.siret"></span>
                    <span x-show="result.ville" class="ml-2">
                      • <span x-text="result.ville"></span>
                    </span>
                    <span x-show="result.dep" class="ml-2 px-2 py-0.5 bg-gray-200 rounded text-xs" x-text="result.dep"></span>
                  </p>
                </div>
                <div x-show="result.date_pap_c5" class="ml-4 text-xs text-gray-500">
                  <i class="fas fa-envelope mr-1"></i>
                  <span x-text="result.date_pap_c5"></span>
                </div>
              </div>
            </div>
          </template>
        </div>
      </div>

      <button type="submit" class="px-6 py-3 bg-cgt-red text-white rounded-lg hover:bg-cgt-darkred transition flex items-center justify-center space-x-2">
        <i class="fas fa-search"></i>
        <span>Rechercher</span>
      </button>
    </div>

    <!-- Toggle Filters Button -->
    <div class="mb-4">
      <button type="button" @click="showFilters = !showFilters"
              class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition flex items-center space-x-2">
        <i class="fas" :class="showFilters ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
        <span>Filtres avancés</span>
        {% if fd or dep or ud or idcc or statut or cgt_implantee %}
        <span class="ml-2 px-2 py-1 bg-cgt-red text-white text-xs rounded-full">Actifs</span>
        {% endif %}
      </button>
    </div>

    <!-- Advanced Filters -->
    <div x-show="showFilters" x-transition class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4 mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
      <!-- Filtre FD -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-building text-blue-500 mr-1"></i>
          Fédération (FD)
        </label>
        <select name="fd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes les FD</option>
          {% for f in all_fds %}
          <option value="{{ f }}" {% if fd == f %}selected{% endif %}>{{ f }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre Département -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-map-marker-alt text-green-500 mr-1"></i>
          Département
        </label>
        <select name="dep" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous les départements</option>
          {% for d in all_deps %}
          <option value="{{ d }}" {% if dep == d %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre UD -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-flag-checkered text-red-500 mr-1"></i>
          Union Départementale (UD)
        </label>
        <select name="ud" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes les UD</option>
          {% for value in all_uds %}
          <option value="{{ value }}" {% if ud == value %}selected{% endif %}>{{ value }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre IDCC -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-file-contract text-indigo-500 mr-1"></i>
          IDCC
        </label>
        <select name="idcc" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes les IDCC</option>
          {% for code in all_idccs %}
          <option value="{{ code }}" {% if idcc == code %}selected{% endif %}>{{ code }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Filtre Statut PAP -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-info-circle text-purple-500 mr-1"></i>
          Statut PAP
        </label>
        <select name="statut" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous les statuts</option>
          <option value="C3" {% if statut == 'C3' %}selected{% endif %}>C3</option>
          <option value="C4" {% if statut == 'C4' %}selected{% endif %}>C4</option>
          <option value="C3+C4" {% if statut == 'C3+C4' %}selected{% endif %}>C3+C4</option>
          <option value="Aucun" {% if statut == 'Aucun' %}selected{% endif %}>Aucun</option>
        </select>
      </div>

      <!-- Filtre CGT Implantée -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2">
          <i class="fas fa-flag text-cgt-red mr-1"></i>
          CGT Implantée
        </label>
        <select name="cgt_implantee" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous</option>
          <option value="oui" {% if cgt_implantee == 'oui' %}selected{% endif %}>Oui</option>
          <option value="non" {% if cgt_implantee == 'non' %}selected{% endif %}>Non</option>
        </select>
      </div>

      <!-- Hidden field to preserve sort -->
      <input type="hidden" name="sort" value="{{ sort }}">

      <!-- Action Buttons -->
      <div class="col-span-1 md:col-span-2 lg:col-span-4 flex gap-3 justify-end">
        <a href="/" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded-lg transition flex items-center space-x-2">
          <i class="fas fa-times"></i>
          <span>Réinitialiser</span>
        </a>
        <button type="submit" class="px-6 py-2 bg-cgt-red text-white rounded-lg hover:bg-cgt-darkred transition flex items-center space-x-2">
          <i class="fas fa-filter"></i>
          <span>Appliquer les filtres</span>
        </button>
      </div>
    </div>
  </form>
</section>

<!-- PAP Table with Filters and Sorting -->
<section class="bg-white rounded-xl shadow-md p-6">
  <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-6 gap-4">
    <h3 class="text-2xl font-bold text-gray-800">
      <i class="fas fa-table text-cgt-red mr-2"></i>
      Invitations PAP - Cycle 5
    </h3>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3">
      <button onclick="toggleFullscreenTable('pap-table')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
        <i class="fas fa-expand mr-2"></i>
        Plein écran
      </button>
    </div>
  </div>

  <!-- Sort Buttons -->
  <div class="flex flex-wrap gap-3 mb-6">
    <a href="{{ build_url(sort='date_pap_c5', page=1) }}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'date_pap_c5' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-calendar mr-2"></i>Trier par Date PAP
    </a>
    <a href="{{ build_url(sort='inscrits_c3', page=1) }}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'inscrits_c3' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-sort-numeric-down mr-2"></i>Trier par Inscrits C3
    </a>
    <a href="{{ build_url(sort='inscrits_c4', page=1) }}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'inscrits_c4' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-sort-numeric-down mr-2"></i>Trier par Inscrits C4
    </a>
    <a href="{{ build_url(sort='fd', page=1) }}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'fd' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-sitemap mr-2"></i>Trier par FD
    </a>
    <a href="{{ build_url(sort='ud', page=1) }}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'ud' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-map mr-2"></i>Trier par UD
    </a>
    <a href="{{ build_url(sort='idcc', page=1) }}"
       class="px-4 py-2 rounded-lg transition {% if sort == 'idcc' %}bg-cgt-red text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %}">
      <i class="fas fa-file-signature mr-2"></i>Trier par IDCC
    </a>
  </div>

  <!-- Top departments by invitations -->
  <div class="mb-8">
    <h4 class="text-lg font-bold text-gray-700 mb-4">Top 10 des départements par invitations PAP C5</h4>
    {% if top_departments %}
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table class="min-w-full divide-y divide-gray-200" data-sortable="true">
        <thead class="bg-gradient-to-r from-cgt-red to-cgt-darkred text-white">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Rang</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Département</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Invitations PAP C5</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for entry in top_departments %}
          <tr class="table-row-hover hover:bg-cgt-lightred">
            <td class="px-4 py-3 font-semibold text-gray-700" data-rank-cell data-sort-value="{{ loop.index }}">#{{ loop.index }}</td>
            <td class="px-4 py-3 whitespace-nowrap">{{ entry.dep }}</td>
            <td class="px-4 py-3" data-sort-value="{{ entry.count }}">
              <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-semibold">
                {{ entry.count }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-sm text-gray-500">Aucune invitation PAP C5 n'a été enregistrée.</p>
    {% endif %}
  </div>

  <!-- Full Table -->
  <div>
    <h4 class="text-lg font-bold text-gray-700 mb-4">Toutes les invitations (100 premières)</h4>
    <div class="overflow-x-auto rounded-lg border border-gray-200">
      <table id="pap-table" class="min-w-full divide-y divide-gray-200" data-sortable="true">
        <thead class="bg-gradient-to-r from-cgt-red to-cgt-darkred text-white">
          <tr>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">SIRET</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Raison sociale</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">FD</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">UD</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">IDCC</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV C3</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Inscrits C3</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV C4</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="numeric">Inscrits C4</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">Statut</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV Max</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PAP C5</th>
            <th class="px-4 py-3 text-left text-xs font-bold uppercase">CGT</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for r in rows %}
          <tr class="table-row-hover hover:bg-cgt-lightred">
            <td class="px-4 py-3 whitespace-nowrap">
              {% if r.detail_available %}
              <a href="/siret/{{ r.siret }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ r.siret }}</a>
              {% else %}
              <span class="text-gray-400 font-medium" title="Détail indisponible">{{ r.siret }}</span>
              {% endif %}
            </td>
            <td class="px-4 py-3">{{ r.raison_sociale or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.display_fd or '' }}">{{ r.display_fd or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.display_ud or '' }}">{{ r.display_ud or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.display_idcc or '' }}">{{ r.display_idcc or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pv_c3_sort or '' }}">{{ r.date_pv_c3_display or '' }}</td>
            <td class="px-4 py-3 text-center" data-sort-value="{{ r.inscrits_c3 if r.inscrits_c3 is not none else '' }}">{{ r.inscrits_c3 or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pv_c4_sort or '' }}">{{ r.date_pv_c4_display or '' }}</td>
            <td class="px-4 py-3 text-center" data-sort-value="{{ r.inscrits_c4 if r.inscrits_c4 is not none else '' }}">{{ r.inscrits_c4 or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap">{{ r.statut_pap or '' }}</td>
            <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ r.date_pv_max_sort or '' }}">{{ r.date_pv_max_display or '' }}</td>
            {% set pap_label = r.date_pap_c5_label %}
            {% set pap_value = r.date_pap_c5_display or r.date_pap_c5 %}
            {% set pap_sort = r.date_pap_c5_sort or '' %}
            <td class="px-4 py-3 whitespace-nowrap text-center" data-sort-value="{{ pap_sort }}">
              {% if pap_label %}
              <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
                <i class="fas fa-calendar-check mr-1"></i>
                {{ pap_label }}
              </span>
              {% elif pap_value %}
              <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
                <i class="fas fa-calendar-check mr-1"></i>
                {{ pap_value }}
              </span>
              {% else %}
              <span class="text-gray-400 text-sm">—</span>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-center">
              {% if r.cgt_implantee %}
              <span class="px-3 py-1 bg-green-500 text-white rounded-full text-xs font-bold">OUI</span>
              {% else %}
              <span class="px-3 py-1 bg-gray-300 text-gray-700 rounded-full text-xs font-bold">NON</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="flex flex-col md:flex-row items-center justify-between mt-6 gap-3">
      <div class="text-sm text-gray-600">
        {% if total_count %}
          Affichage {{ start_index }}–{{ end_index }} sur {{ total_count }} invitations ({{ page_size }} par page)
        {% else %}
          Aucune invitation à afficher
        {% endif %}
      </div>
      <div class="flex items-center gap-2">
        {% if page > 1 %}
        <a href="{{ build_url(page=1) }}" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
          <i class="fas fa-angle-double-left mr-1"></i>Première
        </a>
        <a href="{{ build_url(page=page-1) }}" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
          <i class="fas fa-angle-left mr-1"></i>Précédent
        </a>
        {% else %}
        <span class="px-3 py-1.5 bg-gray-100 text-gray-400 rounded-lg text-sm cursor-not-allowed">
          <i class="fas fa-angle-double-left mr-1"></i>Première
        </span>
        <span class="px-3 py-1.5 bg-gray-100 text-gray-400 rounded-lg text-sm cursor-not-allowed">
          <i class="fas fa-angle-left mr-1"></i>Précédent
        </span>
        {% endif %}

        <span class="text-sm font-semibold text-gray-700">
          Page {{ page }} / {{ total_pages }}
        </span>

        {% if page < total_pages %}
        <a href="{{ build_url(page=page+1) }}" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
          Suivant<i class="fas fa-angle-right ml-1"></i>
        </a>
        <a href="{{ build_url(page=total_pages) }}" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm">
          Dernière<i class="fas fa-angle-double-right ml-1"></i>
        </a>
        {% else %}
        <span class="px-3 py-1.5 bg-gray-100 text-gray-400 rounded-lg text-sm cursor-not-allowed">
          Suivant<i class="fas fa-angle-right ml-1"></i>
        </span>
        <span class="px-3 py-1.5 bg-gray-100 text-gray-400 rounded-lg text-sm cursor-not-allowed">
          Dernière<i class="fas fa-angle-double-right ml-1"></i>
        </span>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- Alpine.js Dashboard Data -->
<script>
    function dashboardData() {
      return {
        stats: {},
        loading: false,
        loadingProgress: 0,
        progressTimer: null,
        charts: {},
        expandedChart: null,

        beginProgress() {
          this.loadingProgress = 5;
          this.clearProgressTimer();
          this.progressTimer = setInterval(() => {
            if (this.loadingProgress >= 90) {
              return;
            }
            const remaining = 90 - this.loadingProgress;
            const step = Math.max(1, Math.round(remaining * 0.2));
            this.loadingProgress = Math.min(90, this.loadingProgress + step);
          }, 250);
        },

        clearProgressTimer() {
          if (this.progressTimer) {
            clearInterval(this.progressTimer);
            this.progressTimer = null;
          }
        },

        finishProgress() {
          this.clearProgressTimer();
          this.loadingProgress = 100;
          setTimeout(() => {
            this.loading = false;
            this.loadingProgress = 0;
          }, 400);
        },

        async loadStats() {
          if (this.loading) {
            return;
          }
          this.loading = true;
          this.closeChartModal();
          this.beginProgress();
          try {
            const params = Alpine.store('globalFilter').getQueryParams();
            const url = params ? `/api/stats/dashboard?${params}` : '/api/stats/dashboard';
            const response = await fetch(url);
            if (!response.ok) {
              throw new Error('Réponse invalide du serveur');
            }
            this.stats = await response.json();

            // Render charts after stats are loaded
            this.$nextTick(() => {
              this.renderDepartmentsChart();
              this.renderMonthlyChart();
              this.renderQuarterChart();
            });
          } catch (error) {
            console.error('Error loading stats:', error);
            showToast('Erreur lors du chargement des statistiques', 'error');
          } finally {
            this.finishProgress();
          }
        },

        formatUpcomingPeriod(start, end) {
          if (start && end) {
            if (start === end) {
              return start;
            }
            return `${start} → ${end}`;
          }
          return start || end || '—';
        },

      renderDepartmentsChart() {
        const canvas = document.getElementById('departmentsChart');
        if (!canvas) return;

        if (!this.stats.departments || !this.stats.departments.length) {
          this.destroyChart('departments');
          return;
        }

        const config = this.getChartConfig('departments');
        this.createOrUpdateChart('departments', canvas, config);
      },

      renderMonthlyChart() {
        const canvas = document.getElementById('monthlyChart');
        if (!canvas) return;

        if (!this.stats.monthly_invitations || !this.stats.monthly_invitations.length) {
          this.destroyChart('monthly');
          return;
        }

        const config = this.getChartConfig('monthly');
        this.createOrUpdateChart('monthly', canvas, config);
      },

      renderQuarterChart() {
        const canvas = document.getElementById('quartersChart');
        if (!canvas) return;

        if (!this.stats.upcoming_quarters || !this.stats.upcoming_quarters.length) {
          this.destroyChart('quarters');
          return;
        }

        const config = this.getChartConfig('quarters');
        this.createOrUpdateChart('quarters', canvas, config);
      },

      createOrUpdateChart(key, canvas, config) {
        if (!canvas || !config) {
          return;
        }

        this.destroyChart(key);
        this.charts[key] = new Chart(canvas, config);
      },

      destroyChart(key) {
        if (this.charts[key]) {
          this.charts[key].destroy();
          delete this.charts[key];
        }
      },

      getSharedChartOptions() {
        return {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        };
      },

      getChartConfig(key, expanded = false) {
        if (!this.stats) {
          return null;
        }

        const options = this.getSharedChartOptions();

        if (expanded) {
          options.plugins = options.plugins || {};
          options.plugins.title = {
            display: true,
            text: this.getChartTitle(key),
            font: {
              size: 18,
              weight: 'bold'
            }
          };
        }

        switch (key) {
          case 'departments': {
            if (!this.stats.departments || !this.stats.departments.length) {
              return null;
            }
            const threshold = this.stats.audience_threshold || 1000;
            return {
              type: 'bar',
              data: {
                labels: this.stats.departments.map(d => d.dep),
                datasets: [{
                  label: `SIRET ≥ ${threshold} inscrits`,
                  data: this.stats.departments.map(d => d.count),
                  backgroundColor: '#d5001c',
                  borderColor: '#ab0015',
                  borderWidth: 1
                }]
              },
              options
            };
          }
          case 'monthly': {
            if (!this.stats.monthly_invitations || !this.stats.monthly_invitations.length) {
              return null;
            }
            return {
              type: 'line',
              data: {
                labels: this.stats.monthly_invitations.map(m => m.label || m.month),
                datasets: [{
                  label: 'Invitations PAP C5',
                  data: this.stats.monthly_invitations.map(m => m.count),
                  borderColor: '#d5001c',
                  backgroundColor: 'rgba(213, 0, 28, 0.1)',
                  fill: true,
                  tension: 0.4
                }]
              },
              options
            };
          }
          case 'quarters': {
            if (!this.stats.upcoming_quarters || !this.stats.upcoming_quarters.length) {
              return null;
            }
            return {
              type: 'bar',
              data: {
                labels: this.stats.upcoming_quarters.map(q => q.label),
                datasets: [{
                  label: "Nombre d'élections C5 déclarées",
                  data: this.stats.upcoming_quarters.map(q => q.count),
                  backgroundColor: '#f97316',
                  borderColor: '#ea580c',
                  borderWidth: 1
                }]
              },
              options
            };
          }
          default:
            return null;
        }
      },

      openChartModal(key) {
        const config = this.getChartConfig(key, true);
        if (!config) {
          return;
        }

        this.expandedChart = key;
        document.body.classList.add('overflow-hidden');

        this.$nextTick(() => {
          const canvas = document.getElementById('expandedChartCanvas');
          if (!canvas) {
            return;
          }
          this.createOrUpdateChart('expanded', canvas, config);
        });
      },

      closeChartModal() {
        this.destroyChart('expanded');
        this.expandedChart = null;
        document.body.classList.remove('overflow-hidden');
      },

      getChartTitle(key) {
        const threshold = this.stats?.audience_threshold || 1000;
        switch (key) {
          case 'departments':
            return `Top 10 départements (C4 ≥ ${threshold} inscrit·es)`;
          case 'monthly':
            return 'Invitations mensuelles (toutes PAP C5)';
          case 'quarters':
            return 'Déclarations d\'élections C5 (2025-2028)';
          default:
            return 'Graphique';
        }
      },

      getChartSource(key) {
        const threshold = this.stats?.audience_threshold || 1000;
        switch (key) {
          case 'departments':
            return 'Source : PV C4 — SIRET prioritaires par département';
          case 'monthly':
            return 'Source : Invitations C5 (toutes entrées)';
          case 'quarters':
            return 'Source : Dates prévisionnelles C5 (cycle complet)';
          default:
            return '';
        }
      }
    }
  }

  // Fullscreen table toggle
  function toggleFullscreenTable(id) {
    const table = document.getElementById(id);
    if (!table) return;
    if (table.requestFullscreen) {
      table.requestFullscreen();
    } else if (table.webkitRequestFullscreen) {
      table.webkitRequestFullscreen();
    }
  }
</script>

{% endblock %}
