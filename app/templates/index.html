{% extends "base.html" %}
{% block title %}Accueil ‚Äî PAP/CSE{% endblock %}
{% block content %}
{% if request.query_params.get('retour') == '1' %}
  <div style="text-align:center;margin:2rem 0;">
    <a href="/" class="button secondary" style="font-size:1.2em;padding:.7em 2em;">‚¨Ö Retour √† l‚Äôaccueil</a>
  </div>
{% endif %}
<form method="get" action="/" style="display:flex;gap:.5rem;align-items:center">
  <input name="q" value="{{ q or '' }}" placeholder="Rechercher SIRET / Raison sociale" />
  <button type="submit" class="secondary">Rechercher</button>
</form>

<section style="margin:1.5rem 0;">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
    <h2 style="margin:0;">Synth√®se invitations &amp; PV</h2>
    <a href="/admin" style="display:inline-block;font-size:0.95em;padding:.4rem .9rem;border-radius:.4rem;background:#181818;color:#fff;">‚öôÔ∏è Gestion des imports</a>
  </header>
  <p style="margin:.4rem 0 1rem 0;color:#555;">Vue globale des structures disponibles¬†: nombre d'invitations PAP re√ßues, pr√©sence de PV C3/C4 et organisations syndicales identifi√©es.</p>
  {% if global_totals %}
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.2rem;">
    <div style="border:1px solid #e0e0e0;border-radius:.6rem;padding:.9rem;background:#fafafa;">
      <div style="font-size:2rem;font-weight:700;line-height:1;">{{ global_totals.structures }}</div>
      <div style="color:#555;margin-top:.3rem;font-size:0.9rem;">Structures recens√©es</div>
    </div>
    <div style="border:1px solid #e0e0e0;border-radius:.6rem;padding:.9rem;background:#fafafa;">
      <div style="font-size:2rem;font-weight:700;line-height:1;">{{ global_totals.pap_total }}</div>
      <div style="color:#555;margin-top:.3rem;font-size:0.9rem;">Invitations PAP (C5)</div>
    </div>
    <div style="border:1px solid #e0e0e0;border-radius:.6rem;padding:.9rem;background:#fafafa;">
      <div style="font-size:2rem;font-weight:700;line-height:1;">{{ global_totals.pv_c3_total }}</div>
      <div style="color:#555;margin-top:.3rem;font-size:0.9rem;">PV C3 recens√©s</div>
    </div>
    <div style="border:1px solid #e0e0e0;border-radius:.6rem;padding:.9rem;background:#fafafa;">
      <div style="font-size:2rem;font-weight:700;line-height:1;">{{ global_totals.pv_c4_total }}</div>
      <div style="color:#555;margin-top:.3rem;font-size:0.9rem;">PV C4 recens√©s</div>
    </div>
    <div style="border:1px solid #e0e0e0;border-radius:.6rem;padding:.9rem;background:#fafafa;">
      <div style="font-size:2rem;font-weight:700;line-height:1;">{{ global_totals.match_c3 }}</div>
      <div style="color:#555;margin-top:.3rem;font-size:0.9rem;">Correspondances PAP ‚Üî PV C3</div>
    </div>
    <div style="border:1px solid #e0e0e0;border-radius:.6rem;padding:.9rem;background:#fafafa;">
      <div style="font-size:2rem;font-weight:700;line-height:1;">{{ global_totals.match_c4 }}</div>
      <div style="color:#555;margin-top:.3rem;font-size:0.9rem;">Correspondances PAP ‚Üî PV C4</div>
    </div>
  </div>
  {% endif %}

  {% if summary_rows %}
  <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:center;margin-bottom:1rem;">
    <div style="flex:1 1 240px;">
      <strong>Affichage</strong>
      <div style="color:#555;">{{ pagination.start }} ‚Äì {{ pagination.end }} sur {{ pagination.total_rows }} r√©sultats</div>
      <div style="color:#555;">Page {{ pagination.page }} / {{ pagination.total_pages }}</div>
    </div>
    <div style="display:flex;gap:.5rem;align-items:center;">
      {% if pagination.has_prev %}
      <form method="get" style="margin:0;">
        {% if q %}<input type="hidden" name="q" value="{{ q }}" />{% endif %}
        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
        <input type="hidden" name="page_size" value="{{ pagination.page_size }}" />
        <input type="hidden" name="page" value="{{ pagination.page - 1 }}" />
        <button type="submit" class="secondary">‚üµ Pr√©c√©dent</button>
      </form>
      {% endif %}
      {% if pagination.has_next %}
      <form method="get" style="margin:0;">
        {% if q %}<input type="hidden" name="q" value="{{ q }}" />{% endif %}
        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
        <input type="hidden" name="page_size" value="{{ pagination.page_size }}" />
        <input type="hidden" name="page" value="{{ pagination.page + 1 }}" />
        <button type="submit" class="secondary">Suivant ‚ü∂</button>
      </form>
      {% endif %}
    </div>
    <form method="get" style="margin:0;display:flex;align-items:center;gap:.5rem;">
      {% if q %}<input type="hidden" name="q" value="{{ q }}" />{% endif %}
      {% if sort %}<input type="hidden" name="sort" value="{{ sort }}" />{% endif %}
      <input type="hidden" name="page" value="1" />
      <label style="display:flex;align-items:center;gap:.4rem;">R√©sultats / page
        <select name="page_size" onchange="this.form.submit()">
          {% for size in pagination.sizes %}
          <option value="{{ size }}" {% if size == pagination.page_size %}selected{% endif %}>{{ size }}</option>
          {% endfor %}
        </select>
      </label>
    </form>
  </div>

  {% if page_totals %}
  <div style="display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem;color:#333;">
    <span><strong>{{ page_totals.structures }}</strong> structures sur cette page</span>
    <span><strong>{{ page_totals.pap_total }}</strong> invitations PAP</span>
    <span><strong>{{ page_totals.pv_c3_total }}</strong> PV C3</span>
    <span><strong>{{ page_totals.pv_c4_total }}</strong> PV C4</span>
    <span><strong>{{ page_totals.match_c3 }}</strong> correspondances PAP ‚Üî PV C3</span>
    <span><strong>{{ page_totals.match_c4 }}</strong> correspondances PAP ‚Üî PV C4</span>
  </div>
  {% endif %}

  <div style="overflow-x:auto;">
    <table role="grid" style="min-width:700px;">
      <thead>
        <tr>
          <th>SIRET</th>
          <th>Raison sociale</th>
          <th>D√©partement</th>
          <th>PAP re√ßus</th>
          <th>PV C3</th>
          <th>PV C4</th>
          <th>PAP ‚Üî PV C3</th>
          <th>PAP ‚Üî PV C4</th>
          <th>Organisations syndicales pr√©sentes</th>
        </tr>
      </thead>
      <tbody>
        {% for info in summary_rows %}
        <tr>
          <td><a href="/siret/{{ info.siret }}">{{ info.siret }}</a></td>
          <td>{{ info.raison_sociale or '' }}</td>
          <td>{{ info.departement or '' }}</td>
          <td style="text-align:center;">{{ info.pap_count }}</td>
          <td style="text-align:center;">{{ info.pv_c3_count }}</td>
          <td style="text-align:center;">{{ info.pv_c4_count }}</td>
          <td style="text-align:center;">{% if info.match_c3 %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
          <td style="text-align:center;">{% if info.match_c4 %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
          <td>{{ info.organisations|join(', ') if info.organisations else '‚Äî' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="margin:1rem 0;color:#666;">Aucune structure √† afficher pour le moment.</p>
  {% endif %}
</section>

<article>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;"><strong>Derni√®res invitations re√ßues (C5)</strong>
  <button type="button" class="secondary" onclick="toggleFullscreenTable()" style="font-size:1em;padding:.4em 1.2em;">üñµ Voir tableau plein √©cran</button>
</header>
<div style="margin-bottom:1rem;display:flex;gap:.5rem;align-items:center">
  <form method="get" action="/">
    <input type="hidden" name="sort" value="date_pap_c5" />
    <button type="submit" class="secondary">Trier par date PAP la plus r√©cente</button>
  </form>
  <form method="get" action="/">
    <input type="hidden" name="sort" value="inscrits_c3" />
    <button type="submit" class="secondary">Trier par inscrits C3</button>
  </form>
  <form method="get" action="/">
    <input type="hidden" name="sort" value="inscrits_c4" />
    <button type="submit" class="secondary">Trier par inscrits C4</button>
  </form>
</div>
<section style="margin-bottom:1rem">
  <strong>Tableau de synth√®se¬†: PAP les plus r√©cents avec beaucoup d'inscrits</strong>
  <table role="grid" style="font-size:0.95em">
    <thead>
      <tr>
        <th>SIRET</th><th>Raison sociale</th><th>D√©partement</th><th>FD C3</th><th>FD C4</th><th>Date PAP C5</th><th>Inscrits C3</th><th>Inscrits C4</th><th>Pr√©sence CGT</th>
      </tr>
    </thead>
    <tbody>
      {% for r in highlight_rows %}
      <tr>
        <td><a href="/siret/{{ r.siret }}">{{ r.siret }}</a></td>
        <td>{{ r.raison_sociale or '' }}</td>
        <td>{{ r.dep or '' }}</td>
        <td>{{ r.fd_c3 or '' }}</td>
        <td>{{ r.fd_c4 or '' }}</td>
        <td>{{ r.date_pap_c5 or '' }}</td>
        <td>{{ r.inscrits_c3 or '' }}</td>
        <td>{{ r.inscrits_c4 or '' }}</td>
        <td>{% if r.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
  <table role="grid">
    <thead>
      <tr>
        <th>SIRET</th><th>Raison sociale</th><th>IDCC</th>
        <th>Date PV C3</th><th>Inscrits C3</th><th>Date PV C4</th><th>Inscrits C4</th>
        <th>Statut</th><th>Date PV max</th><th>Date PAP C5</th>
        <th>Implantation CGT</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td><a href="/siret/{{ r.siret }}">{{ r.siret }}</a></td>
        <td>{{ r.raison_sociale or '' }}</td>
        <td>{{ r.idcc or '' }}</td>
        <td>{{ r.date_pv_c3 or '' }}</td>
        <td>{{ r.inscrits_c3 or '' }}</td>
        <td>{{ r.date_pv_c4 or '' }}</td>
        <td>{{ r.inscrits_c4 or '' }}</td>
        <td>{{ r.statut_pap or '' }}</td>
        <td>{{ r.date_pv_max or '' }}</td>
        <td>{{ r.date_pap_c5 or '' }}</td>
        <td>{% if r.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</article>

<section>
  <details>
    <summary>API rapide</summary>
    <ul>
      <li>POST <code>/api/ingest/pv</code> (upload Excel PV)</li>
      <li>POST <code>/api/ingest/invit</code> (upload Excel invit PAP)</li>
      <li>POST <code>/api/build/summary</code></li>
      <li>GET <code>/api/siret?q=...</code></li>
      <li>GET <code>/api/siret/{siret}</code></li>
    </ul>
  </details>
</section>
{% endblock %}
