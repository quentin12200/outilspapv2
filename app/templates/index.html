{% extends "base.html" %}
{% block title %}Accueil — Plateforme interne{% endblock %}

{% block content %}
{% if current_user %}
<!-- Menu pour utilisateurs connectés -->
<style>
  :root {
    /* Largeur réutilisable pour le panneau central */
    --orbit-center-width: clamp(22rem, 36vw, 32rem);
  }

  .homepage-shell {
    display: flex;
    justify-content: center;
    padding: 4rem 1.5rem 6rem;
  }

  .orbit-layout {
    position: relative;
    display: grid;
    place-items: center;
    width: clamp(680px, 70vw, 880px);
    aspect-ratio: 1 / 1;
    gap: 2rem;
    --bubble-size: clamp(7.5rem, 11vw, 9.75rem);
    /* Rayon = demi scène - demi centre - demi bulle - marge de respiration */
    --r: calc(
      (min(70vw, 55rem) / 2)
      - (var(--orbit-center-width) / 2)
      - (var(--bubble-size) / 2)
      - 1.25rem
    );
  }

  .orbit-center-card {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    width: var(--orbit-center-width);
    padding: 2.5rem;
    border-radius: 1.75rem;
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.08), rgba(124, 58, 237, 0.12));
    border: 1px solid rgba(220, 38, 38, 0.18);
    text-align: center;
    box-shadow: 0 32px 70px -48px rgba(15, 23, 42, 0.55);
    backdrop-filter: blur(4px);
  }

  .orbit-center-card h1 {
    font-size: clamp(2rem, 4.5vw, 2.65rem);
    font-weight: 700;
    color: #111827;
    margin-bottom: 0.75rem;
  }

  .orbit-center-card p {
    color: #374151;
    line-height: 1.6;
  }

  .orbit-ring {
    position: relative;
    width: 100%;
    height: 100%;
  }

  .orbit-bubble {
    --bubble-bg: #ffffff;
    --bubble-fg: #1f2937;
    --bubble-border: rgba(209, 213, 219, 0.55);
    --delay: 0s;
    --angle: calc((var(--i) / var(--count)) * 1turn);
    --lift: 0px;
    --distance: 1;
    position: absolute;
    top: 50%;
    left: 50%;
    width: var(--bubble-size);
    aspect-ratio: 1 / 1;
    text-decoration: none;
    color: inherit;
    transform: translate(-50%, -50%)
      translate(
        calc(cos(var(--angle)) * (var(--r) + var(--lift)) * var(--distance)),
        calc(sin(var(--angle)) * (var(--r) + var(--lift)) * var(--distance))
      );
    transition: transform 0.35s ease;
  }

  button.orbit-bubble {
    border: none;
    background: transparent;
    cursor: pointer;
    padding: 0;
  }

  .bubble-inner {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    text-align: center;
    background: var(--bubble-bg);
    color: var(--bubble-fg);
    border: 2px solid var(--bubble-border);
    box-shadow: 0 25px 60px -40px rgba(15, 23, 42, 0.45);
    transition: box-shadow 0.35s ease, transform 0.35s ease;
    animation: float 7s ease-in-out infinite;
    animation-delay: var(--delay);
  }

  .bubble-title {
    font-size: 1.05rem;
    font-weight: 600;
  }

  .bubble-description {
    font-size: 0.8rem;
    line-height: 1.35;
    color: inherit;
  }

  .bubble-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.35);
    color: inherit;
  }

  .orbit-bubble:hover .bubble-inner,
  .orbit-bubble:focus-visible .bubble-inner {
    animation-play-state: paused;
    transform: translateY(-6px) scale(1.05);
    box-shadow: 0 40px 90px -45px rgba(91, 33, 182, 0.5);
  }

  .orbit-bubble:hover,
  .orbit-bubble:focus-visible {
    --lift: 4px;
  }

  .orbit-bubble:focus-visible {
    outline: none;
  }

  .orbit-bubble:focus-visible .bubble-inner {
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.35);
  }

  @keyframes float {
    0%,
    100% {
      transform: translate3d(0, 0, 0);
    }
    50% {
      transform: translate3d(0, -8px, 0);
    }
  }

  @media (max-width: 1023px) {
    .orbit-layout {
      width: clamp(520px, 80vw, 720px);
      --bubble-size: clamp(6.5rem, 16vw, 8.5rem);
      --r: calc(
        (min(80vw, 45rem) / 2)
        - (var(--orbit-center-width) / 2)
        - (var(--bubble-size) / 2)
        - 1rem
      );
    }
  }

  @media (max-width: 767px) {
    .homepage-shell {
      padding: 3rem 1.25rem 4rem;
    }

    .orbit-layout {
      width: 100%;
      aspect-ratio: auto;
      display: grid;
      gap: 1.75rem;
      justify-items: center;
      --bubble-size: clamp(7.5rem, 42vw, 9.5rem);
      --r: 0;
    }

    .orbit-center-card {
      position: static;
      transform: none;
      width: min(100%, var(--orbit-center-width));
      padding: 2.25rem 1.75rem;
    }

    .orbit-ring {
      position: static;
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1.25rem;
    }

    .orbit-bubble {
      position: static;
      transform: none;
      transition: none;
    }

    .bubble-inner {
      height: auto;
      aspect-ratio: 1 / 1;
      padding: 1.25rem;
      animation: none;
    }
  }
</style>

<div class="max-w-5xl mx-auto px-4">
  <div class="homepage-shell">
    {% set bubble_count = 10 + (1 if current_user.role == "admin" else 0) %}
    <div class="orbit-layout" style="--count: {{ bubble_count }};">
      <div class="orbit-center-card">
        <h1>Bienvenue, {{ current_user.first_name }} !</h1>
        <p class="text-sm uppercase tracking-[0.25em] text-cgt-red/80 mb-4">Plateforme de gestion PAP/CSE</p>
        <p>
          Cette plateforme vous permet de piloter vos invitations PAP Cycle 5, suivre les prochaines échéances électorales et analyser la couverture syndicale CGT sur l'ensemble du territoire. Accédez aux statistiques, générez des rapports intelligents et utilisez notre assistant pour répondre à vos questions.
        </p>
      </div>

      <div class="orbit-ring">
        <a href="/stats" class="orbit-bubble" style="--i: 0; --bubble-bg: radial-gradient(circle at 30% 30%, rgba(99, 102, 241, 0.18), rgba(59, 7, 100, 0.45)); --bubble-fg: #1e1b4b; --bubble-border: rgba(79, 70, 229, 0.35); --delay: 0s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-chart-line text-xl"></i>
            </div>
            <div class="bubble-title">Statistiques</div>
            <p class="bubble-description">Consultez les indicateurs clés, graphiques et tableaux de bord.</p>
          </div>
        </a>

        <a href="/invitations" class="orbit-bubble" style="--i: 1; --bubble-bg: radial-gradient(circle at 25% 25%, rgba(59, 130, 246, 0.18), rgba(30, 64, 175, 0.5)); --bubble-fg: #1d4ed8; --bubble-border: rgba(59, 130, 246, 0.35); --delay: 0.35s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-envelope-open-text text-xl"></i>
            </div>
            <div class="bubble-title">Invitations PAP</div>
            <p class="bubble-description">Gérez la liste complète des invitations PAP Cycle 5.</p>
          </div>
        </a>

        <a href="/calendrier" class="orbit-bubble" style="--i: 2; --bubble-bg: radial-gradient(circle at 70% 30%, rgba(16, 185, 129, 0.2), rgba(5, 46, 22, 0.45)); --bubble-fg: #065f46; --bubble-border: rgba(16, 185, 129, 0.4); --delay: 0.7s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-calendar-alt text-xl"></i>
            </div>
            <div class="bubble-title">Calendrier +1000</div>
            <p class="bubble-description">Visualisez les prochaines échéances électorales majeures.</p>
          </div>
        </a>

        <a href="/cartographie" class="orbit-bubble" style="--i: 3; --bubble-bg: radial-gradient(circle at 30% 70%, rgba(129, 140, 248, 0.2), rgba(55, 48, 163, 0.45)); --bubble-fg: #3730a3; --bubble-border: rgba(99, 102, 241, 0.35); --delay: 1.05s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-map text-xl"></i>
            </div>
            <div class="bubble-title">Cartographie</div>
            <p class="bubble-description">Explorez la couverture territoriale de la CGT.</p>
          </div>
        </a>

        <a href="/ciblage" class="orbit-bubble" style="--i: 4; --bubble-bg: radial-gradient(circle at 70% 70%, rgba(249, 115, 22, 0.22), rgba(124, 45, 18, 0.55)); --bubble-fg: #7c2d12; --bubble-border: rgba(249, 115, 22, 0.35); --delay: 1.4s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-crosshairs text-xl"></i>
            </div>
            <div class="bubble-title">Ciblage</div>
            <p class="bubble-description">Repérez les établissements prioritaires selon vos critères.</p>
          </div>
        </a>

        <a href="/recherche-siret" class="orbit-bubble" style="--i: 5; --bubble-bg: radial-gradient(circle at 25% 75%, rgba(45, 212, 191, 0.22), rgba(19, 78, 74, 0.55)); --bubble-fg: #134e4a; --bubble-border: rgba(45, 212, 191, 0.4); --delay: 1.75s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-plus-circle text-xl"></i>
            </div>
            <div class="bubble-title">Ajout PAP</div>
            <p class="bubble-description">Ajoutez manuellement une nouvelle invitation PAP.</p>
          </div>
        </a>

        <a href="/presentation" class="orbit-bubble" style="--i: 6; --bubble-bg: radial-gradient(circle at 75% 30%, rgba(244, 114, 182, 0.24), rgba(131, 24, 67, 0.55)); --bubble-fg: #831843; --bubble-border: rgba(244, 114, 182, 0.4); --delay: 2.1s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-bullseye text-xl"></i>
            </div>
            <div class="bubble-title">Présentation</div>
            <p class="bubble-description">Découvrez la cible PAP Cycle 5 et ses objectifs.</p>
          </div>
        </a>

        <a href="/extraction" class="orbit-bubble" style="--i: 7; --bubble-bg: radial-gradient(circle at 70% 70%, rgba(250, 204, 21, 0.24), rgba(113, 63, 18, 0.55)); --bubble-fg: #713f12; --bubble-border: rgba(250, 204, 21, 0.4); --delay: 2.45s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-scan text-xl"></i>
            </div>
            <div class="bubble-title">Scanner PAP</div>
            <p class="bubble-description">Analysez automatiquement vos documents PAP.</p>
          </div>
        </a>

        <button onclick="ouvrirAssistantExpert()" class="orbit-bubble" style="--i: 8; --bubble-bg: radial-gradient(circle at 30% 30%, rgba(79, 70, 229, 0.28), rgba(59, 7, 100, 0.65)); --bubble-fg: #f8fafc; --bubble-border: rgba(129, 140, 248, 0.55); --delay: 2.8s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-comments text-xl"></i>
            </div>
            <div class="bubble-title">Chatbot</div>
            <p class="bubble-description">Posez vos questions et obtenez des réponses ciblées.</p>
          </div>
        </button>

        <button onclick="genererRapportIA()" class="orbit-bubble" style="--i: 9; --bubble-bg: radial-gradient(circle at 70% 30%, rgba(236, 72, 153, 0.3), rgba(126, 34, 206, 0.6)); --bubble-fg: #fdf2f8; --bubble-border: rgba(236, 72, 153, 0.55); --delay: 3.15s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-chart-pie text-xl"></i>
            </div>
            <div class="bubble-title">Super rapport</div>
            <p class="bubble-description">Générez un rapport stratégique en quelques clics.</p>
          </div>
        </button>

        {% if current_user.role == "admin" %}
        <a href="/admin" class="orbit-bubble" style="--i: 10; --bubble-bg: radial-gradient(circle at 40% 60%, rgba(239, 68, 68, 0.32), rgba(136, 19, 55, 0.62)); --bubble-fg: #fee2e2; --bubble-border: rgba(239, 68, 68, 0.6); --delay: 3.5s;">
          <div class="bubble-inner">
            <div class="bubble-icon">
              <i class="fas fa-cog text-xl"></i>
            </div>
            <div class="bubble-title">Administration</div>
            <p class="bubble-description">Pilotez les imports, utilisateurs et outils avancés.</p>
          </div>
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Inclure les modals chatbot et rapport -->
{% include '_chat_rapport_modals.html' %}

{% else %}
<!-- Page publique pour visiteurs non connectés -->
<div class="flex items-center justify-center min-h-[70vh]">
  <div class="text-center">
    <div class="mb-8">
      <i class="fas fa-lock text-6xl text-cgt-red mb-4"></i>
    </div>
    <h1 class="text-5xl font-bold text-gray-900 mb-4">
      Plateforme interne
    </h1>
    <p class="text-xl text-gray-600 mb-8">
      Accès réservé aux utilisateurs autorisés
    </p>
    <div class="flex justify-center gap-4">
      <a href="/login" class="inline-flex items-center gap-2 px-8 py-4 bg-cgt-red hover:bg-cgt-darkred text-white font-semibold rounded-lg shadow-lg transition">
        <i class="fas fa-sign-in-alt"></i>
        Se connecter
      </a>
      <a href="/signup" class="inline-flex items-center gap-2 px-8 py-4 bg-gray-700 hover:bg-gray-800 text-white font-semibold rounded-lg shadow-lg transition">
        <i class="fas fa-user-plus"></i>
        S'inscrire
      </a>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}
