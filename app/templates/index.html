{% extends "base.html" %}
{% block title %}Accueil ‚Äî PAP/CSE{% endblock %}
{% block content %}
{% if request.query_params.get('retour') == '1' %}
  <div style="text-align:center;margin:2rem 0;">
    <a href="/" class="button secondary" style="font-size:1.2em;padding:.7em 2em;">‚¨Ö Retour √† l‚Äôaccueil</a>
  </div>
{% endif %}
<form method="get" action="/" style="display:flex;gap:.5rem;align-items:center">
  <input name="q" value="{{ q or '' }}" placeholder="Rechercher SIRET / Raison sociale" />
  <button type="submit" class="secondary">Rechercher</button>
</form>

{% if summary_rows %}
<section style="margin:1.5rem 0;">
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
    <h2 style="margin:0;">Synth√®se invitations &amp; PV</h2>
    <a href="/admin" style="display:inline-block;font-size:0.95em;padding:.4rem .9rem;border-radius:.4rem;background:#181818;color:#fff;">‚öôÔ∏è Gestion des imports</a>
  </header>
  <p style="margin:.4rem 0 1rem 0;color:#555;">Vue rapide sur les structures list√©es ci-dessous¬†: nombre d'invitations PAP re√ßues, pr√©sence de PV C3/C4 et organisations syndicales identifi√©es.</p>
  <div style="overflow-x:auto;">
    <table role="grid" style="min-width:700px;">
      <thead>
        <tr>
          <th>SIRET</th>
          <th>Raison sociale</th>
          <th>D√©partement</th>
          <th>PAP re√ßus</th>
          <th>PV C3</th>
          <th>PV C4</th>
          <th>Organisations syndicales pr√©sentes</th>
        </tr>
      </thead>
      <tbody>
        {% for info in summary_rows %}
        <tr>
          <td><a href="/siret/{{ info.siret }}">{{ info.siret }}</a></td>
          <td>{{ info.raison_sociale or '' }}</td>
          <td>{{ info.departement or '' }}</td>
          <td style="text-align:center;">{{ info.pap_count }}</td>
          <td style="text-align:center;">{{ info.pv_c3_count }}</td>
          <td style="text-align:center;">{{ info.pv_c4_count }}</td>
          <td>{{ info.organisations|join(', ') if info.organisations else '‚Äî' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endif %}

<article>
  <header style="display:flex;align-items:center;justify-content:space-between;gap:1rem;"><strong>Derni√®res invitations re√ßues (C5)</strong>
  <button type="button" class="secondary" onclick="toggleFullscreenTable()" style="font-size:1em;padding:.4em 1.2em;">üñµ Voir tableau plein √©cran</button>
</header>
<div style="margin-bottom:1rem;display:flex;gap:.5rem;align-items:center">
  <form method="get" action="/">
    <input type="hidden" name="sort" value="date_pap_c5" />
    <button type="submit" class="secondary">Trier par date PAP la plus r√©cente</button>
  </form>
  <form method="get" action="/">
    <input type="hidden" name="sort" value="inscrits_c3" />
    <button type="submit" class="secondary">Trier par inscrits C3</button>
  </form>
  <form method="get" action="/">
    <input type="hidden" name="sort" value="inscrits_c4" />
    <button type="submit" class="secondary">Trier par inscrits C4</button>
  </form>
</div>
<section style="margin-bottom:1rem">
  <strong>Tableau de synth√®se¬†: PAP les plus r√©cents avec beaucoup d'inscrits</strong>
  <table role="grid" style="font-size:0.95em">
    <thead>
      <tr>
        <th>SIRET</th><th>Raison sociale</th><th>D√©partement</th><th>FD C3</th><th>FD C4</th><th>Date PAP C5</th><th>Inscrits C3</th><th>Inscrits C4</th><th>Pr√©sence CGT</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows|sort(attribute='date_pap_c5', reverse=True) if r.date_pap_c5 %}
      {% if (r.inscrits_c3 or 0) > 100 or (r.inscrits_c4 or 0) > 100 %}
      <tr>
        <td><a href="/siret/{{ r.siret }}">{{ r.siret }}</a></td>
        <td>{{ r.raison_sociale or '' }}</td>
        <td>{{ r.dep or '' }}</td>
        <td>{{ r.fd_c3 or '' }}</td>
        <td>{{ r.fd_c4 or '' }}</td>
        <td>{{ r.date_pap_c5 or '' }}</td>
        <td>{{ r.inscrits_c3 or '' }}</td>
        <td>{{ r.inscrits_c4 or '' }}</td>
        <td>{% if r.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
      </tr>
      {% endif %}
      {% endfor %}
    </tbody>
  </table>
</section>
  <table role="grid">
    <thead>
      <tr>
        <th>SIRET</th><th>Raison sociale</th><th>IDCC</th>
        <th>Date PV C3</th><th>Inscrits C3</th><th>Date PV C4</th><th>Inscrits C4</th>
        <th>Statut</th><th>Date PV max</th><th>Date PAP C5</th>
        <th>Implantation CGT</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td><a href="/siret/{{ r.siret }}">{{ r.siret }}</a></td>
        <td>{{ r.raison_sociale or '' }}</td>
        <td>{{ r.idcc or '' }}</td>
        <td>{{ r.date_pv_c3 or '' }}</td>
        <td>{{ r.inscrits_c3 or '' }}</td>
        <td>{{ r.date_pv_c4 or '' }}</td>
        <td>{{ r.inscrits_c4 or '' }}</td>
        <td>{{ r.statut_pap or '' }}</td>
        <td>{{ r.date_pv_max or '' }}</td>
        <td>{{ r.date_pap_c5 or '' }}</td>
        <td>{% if r.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</article>

<section>
  <details>
    <summary>API rapide</summary>
    <ul>
      <li>POST <code>/api/ingest/pv</code> (upload Excel PV)</li>
      <li>POST <code>/api/ingest/invit</code> (upload Excel invit PAP)</li>
      <li>POST <code>/api/build/summary</code></li>
      <li>GET <code>/api/siret?q=...</code></li>
      <li>GET <code>/api/siret/{siret}</code></li>
    </ul>
  </details>
</section>
{% endblock %}
