{% extends "base.html" %}
{% block title %}Administration — PAP/CSE{% endblock %}

{% block content %}

<!-- Header -->
<div class="mb-8">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-4xl font-bold text-gray-800 flex items-center">
      <i class="fas fa-cog text-cgt-red mr-3"></i>
      Administration
    </h1>
    <a href="/admin/logout" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
      <i class="fas fa-sign-out-alt mr-2"></i>
      Déconnexion
    </a>
  </div>
  <p class="text-gray-600">
    Suivi centralisé des imports, automatisations et nouvelles fonctionnalités de la plateforme PAP/CSE.
  </p>
</div>

<!-- Global metrics -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">PV enregistrés</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.pv_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-cgt-red/10 text-cgt-red rounded-full">
        <i class="fas fa-poll text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">SIRET distincts : {{ stats.pv_sirets or 0 }}</p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">Résumé SIRET</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.summary_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 text-blue-600 rounded-full">
        <i class="fas fa-database text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">Dernier PV enregistré : {{ stats.last_summary or '—' }}</p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">Invitations PAP C5</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.invit_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-green-100 text-green-600 rounded-full">
        <i class="fas fa-envelope-open-text text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">Dernière invitation : {{ stats.last_invitation or '—' }}</p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">Élections ≥ {{ upcoming_threshold }}</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.upcoming_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-purple-100 text-purple-600 rounded-full">
        <i class="fas fa-calendar-day text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">Prochaine échéance : {{ stats.upcoming_next or '—' }}</p>
  </div>
</div>

<!-- Quick actions -->
<section class="mb-10">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Raccourcis & nouvelles fonctionnalités</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-6 gap-4">
    <button onclick="genererRapportIA()" class="flex items-center justify-between px-5 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl shadow hover:shadow-lg transition border border-pink-200 hover:from-pink-600 hover:to-purple-700">
      <div class="text-left">
        <p class="text-sm font-semibold">⚡ Analyse Avancée PAP</p>
        <p class="text-xs opacity-90">Analyse approfondie des cibles prioritaires</p>
      </div>
      <i class="fas fa-chart-line text-white text-xl"></i>
    </button>

    <a href="/calendrier" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-purple-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Calendrier prochaines élections +1000</p>
        <p class="text-xs text-gray-500">Vue dédiée aux scrutins à venir (date_prochain_scrutin)</p>
      </div>
      <i class="fas fa-calendar-alt text-purple-500 text-xl"></i>
    </a>

    <a href="/invitations" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-green-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Tableau Invitations PAP</p>
        <p class="text-xs text-gray-500">Consultez et filtrez les imports automatiques ou manuels</p>
      </div>
      <i class="fas fa-envelope text-green-500 text-xl"></i>
    </a>

    <a href="/admin/diagnostics" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-red-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Diagnostic des doublons</p>
        <p class="text-xs text-gray-500">Détection & nettoyage des invitations importées plusieurs fois</p>
      </div>
      <i class="fas fa-stethoscope text-red-500 text-xl"></i>
    </a>

    <a href="#imports" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-blue-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Import manuel</p>
        <p class="text-xs text-gray-500">Accéder rapidement aux formulaires d'import Excel</p>
      </div>
      <i class="fas fa-file-upload text-blue-500 text-xl"></i>
    </a>

    <button onclick="ouvrirAssistantExpert()" class="flex items-center justify-between px-5 py-4 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg hover:shadow-xl transition text-white">
      <div class="text-left">
        <p class="text-sm font-semibold flex items-center gap-2">
          <span class="px-2 py-0.5 bg-yellow-400 text-yellow-900 rounded text-xs font-bold">NOUVEAU</span>
          Assistant Expert
        </p>
        <p class="text-xs text-indigo-100">Posez des questions en langage naturel</p>
      </div>
      <i class="fas fa-comments text-2xl"></i>
    </button>
  </div>
</section>

<!-- Upcoming elections preview -->
<section class="bg-white rounded-xl shadow-md p-6 mb-10">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">Calendrier des prochaines élections ≥ {{ upcoming_threshold }}</h2>
      <p class="text-sm text-gray-500">Les données proviennent de la colonne « date_prochain_scrutin » croisée avec l'effectif SIRET.</p>
    </div>
    <a href="/calendrier" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700 transition">
      <i class="fas fa-external-link-alt mr-2"></i>
      Ouvrir le calendrier complet
    </a>
  </div>

  {% if upcoming_preview %}
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Date</th>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Entreprise / SIRET</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Effectif</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Cycle</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Type</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">FD</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">IDCC</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">SVE</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Participation</th>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Top 3 organisations</th>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Implantation</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for item in upcoming_preview %}
        <tr class="hover:bg-purple-50/40">
          <td class="px-4 py-3 font-semibold text-gray-700">{{ item.date_display }}</td>
          <td class="px-4 py-3">
            <div class="font-semibold text-gray-800">{{ item.raison_sociale or '—' }}</div>
            <div class="text-xs text-gray-500 tracking-widest">{{ item.siret or '—' }}</div>
          </td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.effectif or '—' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.cycle or '—' }}</td>
          <td class="px-4 py-3 text-center">
            {% if item.institution == 'CAR' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-50 text-red-600">Carence</span>
            {% elif item.institution == 'CSE' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600">CSE</span>
            {% else %}
              <span class="text-gray-700">{{ item.institution or '—' }}</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.fd | clean_nan or '—' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.idcc | clean_nan or '—' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.sve_display or '—' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.participation_display or '—' }}</td>
          <td class="px-4 py-3 text-gray-700">
            {% if item.top_orgs %}
            <ul class="space-y-1">
              {% for org in item.top_orgs %}
              <li class="flex items-baseline justify-between gap-3">
                <span class="font-semibold text-gray-800">{{ org.label }}</span>
                <span class="text-sm text-gray-600">{{ org.votes_display or '—' }}{% if org.percent_display %} <span class="text-xs text-gray-500">({{ org.percent_display }})</span>{% endif %}</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <span class="text-gray-400">—</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-gray-700">
            <div>{{ item.ud | clean_nan or '—' }}</div>
            <div class="text-xs text-gray-500">{{ item.region or '—' }}</div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <p class="text-xs text-gray-500 mt-3">Affichage des 5 prochaines échéances. Utilisez le calendrier pour explorer l'intégralité des scrutins à venir.</p>
  {% else %}
  <div class="p-6 bg-purple-50 border border-dashed border-purple-200 rounded-lg text-purple-700">
    <i class="fas fa-info-circle mr-2"></i>
    Aucun scrutin ≥ {{ upcoming_threshold }} salarié à venir n'a été détecté dans la base pour le moment.
  </div>
  {% endif %}
</section>

<!-- Automations -->
<section class="mb-12">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Automatisations & intégrations</h2>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {% set db = db_asset %}
    <div class="bg-white rounded-xl shadow-md p-6 border border-blue-50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">Base papcse.db</h3>
          <p class="text-xs text-gray-500">Téléchargement automatique depuis GitHub Release</p>
        </div>
        {% if db.exists %}
          <span class="px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Disponible</span>
        {% else %}
          <span class="px-3 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">Introuvable</span>
        {% endif %}
      </div>
      <ul class="text-sm text-gray-600 space-y-2">
        <li><strong>Chemin :</strong> <code class="bg-gray-100 px-2 py-1 rounded">{{ db.path or '—' }}</code></li>
        <li><strong>Taille :</strong> {{ db.size_mb ~ ' Mo' if db.size_mb else '—' }}</li>
        <li>
          <strong>Source Release :</strong>
          {% if db.url %}
            <a href="{{ db.url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ db.url }}</a>
          {% else %}
            <span>Non configuré</span>
          {% endif %}
        </li>
        <li>
          <strong>Hash attendu :</strong>
          {% if db.expected_hash %}
            <code class="bg-gray-100 px-2 py-1 rounded break-all">{{ db.expected_hash }}</code>
          {% else %}
            <span>Non fourni</span>
          {% endif %}
        </li>
        <li>
          <strong>Hash calculé :</strong>
          {% if db.actual_hash %}
            <code class="bg-gray-100 px-2 py-1 rounded break-all">{{ db.actual_hash }}</code>
            {% if db.expected_hash %}
              {% if db.hash_match %}
                <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">Conforme</span>
              {% else %}
                <span class="ml-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full">À vérifier</span>
              {% endif %}
            {% endif %}
          {% else %}
            <span>—</span>
          {% endif %}
        </li>
      </ul>
      <p class="text-xs text-gray-500 mt-4">
        La base est téléchargée au démarrage si elle est absente. Supprimez le fichier local pour forcer un rafraîchissement depuis la release configurée.
      </p>
    </div>

    {% set invit = invitations_asset %}
    <div class="bg-white rounded-xl shadow-md p-6 border border-green-50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">Invitations PAP C5</h3>
          <p class="text-xs text-gray-500">Préchargement automatique lors du premier démarrage</p>
        </div>
        {% if invit.auto_enabled %}
          <span class="px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Auto-chargement activé</span>
        {% else %}
          <span class="px-3 py-1 text-xs font-semibold bg-gray-100 text-gray-600 rounded-full">Auto-chargement désactivé</span>
        {% endif %}
      </div>
      <ul class="text-sm text-gray-600 space-y-2">
        <li>
          <strong>Source Release :</strong>
          {% if invit.url %}
            <a href="{{ invit.url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ invit.url }}</a>
          {% else %}
            <span>Non configuré</span>
          {% endif %}
        </li>
        {% if not invit.url and invit.inferred_url %}
          <li class="text-xs text-gray-500">
            <strong>URL déduite :</strong>
            <a href="{{ invit.inferred_url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ invit.inferred_url }}</a>
            {% if invit.inferred_urls and invit.inferred_urls|length > 1 %}
              <span class="ml-1 text-gray-400">(+{{ invit.inferred_urls|length - 1 }} variante{{ 's' if invit.inferred_urls|length > 2 else '' }})</span>
            {% endif %}
          </li>
        {% endif %}
        <li><strong>Invitations en base :</strong> {{ invit.count or 0 }}</li>
        <li><strong>Dernière date importée :</strong> {{ invit.last_date or '—' }}</li>
        {% if invit.effective_url %}
          <li class="text-xs text-gray-500">
            <strong>Dernier import automatique :</strong>
            <a href="{{ invit.effective_url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ invit.effective_url }}</a>
          </li>
        {% endif %}
        <li>
          <strong>Hash attendu :</strong>
          {% if invit.expected_hash %}
            <code class="bg-gray-100 px-2 py-1 rounded break-all">{{ invit.expected_hash }}</code>
          {% else %}
            <span>Non fourni</span>
          {% endif %}
        </li>
      </ul>
      <p class="text-xs text-gray-500 mt-4">
        Si la table est vide au démarrage, le fichier configuré est importé automatiquement puis disponible dans le tableau « Invitations PAP - Cycle 5 ».
      </p>
    </div>

    {% set sirene = sirene_status %}
    <div class="bg-white rounded-xl shadow-md p-6 border border-indigo-50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">API Sirene</h3>
          <p class="text-xs text-gray-500">Enrichissement SIRET via la clé INSEE</p>
        </div>
        {% if sirene.configured %}
          <span class="px-3 py-1 text-xs font-semibold bg-indigo-100 text-indigo-700 rounded-full">Clé détectée</span>
        {% else %}
          <span class="px-3 py-1 text-xs font-semibold bg-yellow-100 text-yellow-700 rounded-full">Clé manquante</span>
        {% endif %}
      </div>
      <ul class="text-sm text-gray-600 space-y-2">
        <li>
          <strong>Variables Railway :</strong>
          <code class="bg-gray-100 px-2 py-1 rounded">SIRENE_API_KEY</code>
          <span class="text-xs text-gray-400">(clé intégration)</span>
          <span class="mx-2 text-gray-300">•</span>
          <code class="bg-gray-100 px-2 py-1 rounded">SIRENE_API_TOKEN</code>
          <span class="text-xs text-gray-400">(token OAuth)</span>
        </li>
        <li><strong>Statut :</strong> {% if sirene.configured %}{{ sirene.masked }}{% else %}Non configurée{% endif %}</li>
        {% if sirene.has_integration_key %}
          <li><strong>En-tête HTTP :</strong> <code class="bg-gray-100 px-2 py-1 rounded">X-INSEE-Api-Key-Integration</code></li>
        {% elif sirene.has_token %}
          <li><strong>En-tête HTTP :</strong> <code class="bg-gray-100 px-2 py-1 rounded">Authorization: Bearer ...</code></li>
        {% endif %}
        <li><strong>Usages :</strong> autocomplete SIRET, fiches entreprises, enrichissement invitations.</li>
      </ul>
      <p class="text-xs text-gray-500 mt-4">
        Ajoutez la clé fournie par l'INSEE sur Railway pour activer l'enrichissement automatique des raisons sociales et adresses lors des imports ou recherches SIRET.
      </p>
    </div>
  </div>
</section>

<!-- Import forms -->
<section id="imports" class="mb-12">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Imports manuels</h2>
    <p class="text-sm text-gray-500">Chargez ici vos fichiers Excel mis à jour. Recalculez ensuite le tableau de synthèse pour rafraîchir le tableau de bord.</p>
  </div>
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Import PV -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-file-excel text-blue-500 mr-2"></i>
        Importer PV (Excel initial)
      </h3>
      <form method="post" action="/api/ingest/pv" enctype="multipart/form-data" class="space-y-4">
        <div>
          <label for="pvfile" class="block text-sm font-semibold text-gray-700 mb-2">Sélectionnez le fichier Excel des PV</label>
          <input type="file" name="file" id="pvfile" required accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-lg cursor-pointer" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-upload"></i>
          <span>Importer les PV</span>
        </button>
        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Import des Procès-Verbaux des élections professionnelles (onglet « Tous PV »).</p>
      </form>
    </section>

    <!-- Import Invitations -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-envelope text-green-500 mr-2"></i>
        Importer Invitations PAP (Cycle 5)
      </h3>
      <form method="post" action="/api/ingest/invit" enctype="multipart/form-data" class="space-y-4">
        <div>
          <label for="invitfile" class="block text-sm font-semibold text-gray-700 mb-2">Sélectionnez le fichier Excel des invitations</label>
          <input type="file" name="file" id="invitfile" required accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 border border-gray-300 rounded-lg cursor-pointer" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-upload"></i>
          <span>Importer les invitations</span>
        </button>
        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Ajoutez ici les invitations complémentaires ou mises à jour du cycle 5.</p>
      </form>
    </section>

    <!-- Import Ciblage -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-crosshairs text-purple-500 mr-2"></i>
        Importer fichier de ciblage
      </h3>
      <form method="post" action="/ciblage/import" enctype="multipart/form-data" class="space-y-4">
        <div>
          <label for="ciblagefile" class="block text-sm font-semibold text-gray-700 mb-2">Sélectionnez le fichier de ciblage</label>
          <input type="file" name="file" id="ciblagefile" required accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 border border-gray-300 rounded-lg cursor-pointer" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-upload"></i>
          <span>Importer le ciblage</span>
        </button>
        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Utilisez ce module pour croiser vos listes (CAC40, SBF120…) avec les invitations détectées.</p>
      </form>
    </section>

    <!-- Rebuild summary -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-sync text-orange-500 mr-2"></i>
        Recalculer le tableau de synthèse
      </h3>
      <div class="space-y-4">
        <div class="p-4 bg-orange-50 border-l-4 border-orange-500 rounded-lg text-sm text-orange-800">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          À utiliser après chaque import PV ou invitation pour mettre à jour le tableau de bord.
        </div>

        <!-- Status display -->
        <div id="rebuild-status" class="hidden">
          <div class="p-4 rounded-lg border" id="rebuild-status-content">
            <!-- Status will be inserted here -->
          </div>
        </div>

        <!-- Action button -->
        <button id="rebuild-button" onclick="triggerRebuild()" class="w-full px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-sync-alt" id="rebuild-icon"></i>
          <span id="rebuild-text">Recalculer le tableau</span>
        </button>

        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Le recalcul nettoie les données, reconstruit <code>siret_summary</code> et alimente les graphiques du tableau de bord.</p>
      </div>
    </section>

    <!-- Enrichir IDCC -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-building text-indigo-500 mr-2"></i>
        Enrichir les IDCC manquants
      </h3>
      <div class="space-y-4">
        <div class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-lg text-sm text-indigo-800">
          <i class="fas fa-info-circle mr-2"></i>
          Enrichit les invitations PAP sans IDCC via l'API SIRENE de l'INSEE.
        </div>

        <!-- Status display -->
        <div id="enrichir-idcc-status" class="hidden">
          <div class="p-4 rounded-lg border" id="enrichir-idcc-status-content">
            <!-- Status will be inserted here -->
          </div>
        </div>

        <!-- Action button -->
        <button id="enrichir-idcc-button" onclick="triggerEnrichirIDCC()" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-database" id="enrichir-idcc-icon"></i>
          <span id="enrichir-idcc-text">Enrichir les IDCC</span>
        </button>

        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Récupère l'IDCC (Convention Collective) depuis l'API SIRENE pour chaque invitation sans IDCC. Permet ensuite d'identifier la FD (Fédération) correspondante.</p>
      </div>
    </section>
  </div>
</section>

<!-- Quality tools and reminders -->
<section class="mb-12">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <section class="bg-white rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-800 flex items-center"><i class="fas fa-stethoscope text-red-500 mr-2"></i>Diagnostic des doublons</h3>
        <a href="/admin/diagnostics" class="px-3 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">Ouvrir</a>
      </div>
      <p class="text-sm text-gray-600 mb-4">Détecte et supprime automatiquement les invitations importées plusieurs fois (garde la plus récente par SIRET).</p>
      <ul class="text-xs text-gray-500 space-y-2">
        <li><i class="fas fa-check text-green-500 mr-2"></i>Compteur global, SIRET uniques et nombre de doublons.</li>
        <li><i class="fas fa-check text-green-500 mr-2"></i>Top 10 des SIRET concernés avec aperçu des dates importées.</li>
        <li><i class="fas fa-check text-green-500 mr-2"></i>Bouton de suppression rapide (garde la ligne la plus récente).</li>
      </ul>
    </section>

    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Processus recommandé</h3>
      <ol class="space-y-4 text-sm text-gray-600">
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">1</span>
          <div>
            <strong>Importer les PV</strong>
            <p class="text-xs text-gray-500 mt-1">Utilisez l'onglet « Tous PV » de votre fichier Excel.</p>
          </div>
        </li>
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">2</span>
          <div>
            <strong>Ajouter les invitations PAP</strong>
            <p class="text-xs text-gray-500 mt-1">Import manuel ou automatique via la variable <code>INVITATIONS_URL</code>.</p>
          </div>
        </li>
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">3</span>
          <div>
            <strong>Recalculer le tableau</strong>
            <p class="text-xs text-gray-500 mt-1">Cliquez sur « Recalculer » pour alimenter <code>siret_summary</code>, le tableau de bord et le calendrier.</p>
          </div>
        </li>
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">4</span>
          <div>
            <strong>Vérifier les doublons</strong>
            <p class="text-xs text-gray-500 mt-1">Contrôlez la qualité des invitations avec l'outil diagnostic.</p>
          </div>
        </li>
      </ol>
    </section>
  </div>
</section>

<!-- Reference information -->
<section class="bg-white rounded-xl shadow-md p-6 mb-12">
  <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-database text-gray-600 mr-3"></i>
    Informations techniques
  </h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600">
    <div>
      <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2">Tables principales</h3>
      <ul class="space-y-1 text-xs">
        <li>• <code>Tous_PV</code> (historique des PV)</li>
        <li>• <code>invitations</code> (PAP cycle 5)</li>
        <li>• <code>siret_summary</code> (agrégations tableau de bord)</li>
      </ul>
    </div>
    <div>
      <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2">Formats acceptés</h3>
      <ul class="space-y-1 text-xs">
        <li>• Excel (.xlsx)</li>
        <li>• Excel 97-2003 (.xls)</li>
      </ul>
    </div>
    <div>
      <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2">Sécurité & intégrité</h3>
      <ul class="space-y-1 text-xs">
        <li>• Validation SHA256 (DB & invitations)</li>
        <li>• Téléchargements GitHub Release sécurisés</li>
        <li>• Données stockées en local SQLite</li>
      </ul>
    </div>
  </div>
</section>

<!-- Background task management script -->
<script>
let statusPollInterval = null;

// Trigger the rebuild task
async function triggerRebuild() {
  const button = document.getElementById('rebuild-button');
  const buttonText = document.getElementById('rebuild-text');
  const buttonIcon = document.getElementById('rebuild-icon');

  // Disable button
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.add('fa-spin');
  buttonText.textContent = 'Lancement en cours...';

  try {
    const response = await fetch('/api/build/summary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': '{{ admin_api_key }}'
      }
    });

    const data = await response.json();

    if (data.status === 'started' || data.status === 'already_running') {
      // Start polling for status
      showStatus('running', data.message);
      startStatusPolling();
    } else {
      showStatus('error', data.message || 'Erreur lors du lancement de la tâche');
      resetButton();
    }
  } catch (error) {
    showStatus('error', 'Erreur réseau : ' + error.message);
    resetButton();
  }
}

// Poll the status endpoint
async function checkStatus() {
  try {
    const response = await fetch('/api/build/summary/status');
    const data = await response.json();

    if (data.status === 'not_found') {
      // No task has been run yet - hide status display
      const statusDiv = document.getElementById('rebuild-status');
      statusDiv.classList.add('hidden');
      return;
    }

    const status = data.status;

    if (status === 'running') {
      const elapsed = data.elapsed_seconds ? ` (${Math.round(data.elapsed_seconds)}s écoulées)` : '';
      showStatus('running', data.description + elapsed);
    } else if (status === 'completed') {
      const rows = data.result?.rows || 0;
      const duration = data.duration_seconds ? ` en ${Math.round(data.duration_seconds)}s` : '';
      showStatus('success', `✓ Reconstruction terminée avec succès : ${rows} lignes générées${duration}`);
      stopStatusPolling();
      resetButton();
    } else if (status === 'failed') {
      showStatus('error', '✗ Erreur : ' + (data.error || 'Erreur inconnue'));
      stopStatusPolling();
      resetButton();
    } else if (status === 'pending') {
      showStatus('pending', 'Tâche en attente de démarrage...');
    }
  } catch (error) {
    console.error('Erreur lors de la vérification du statut:', error);
  }
}

// Start polling
function startStatusPolling() {
  if (statusPollInterval) {
    clearInterval(statusPollInterval);
  }
  // Poll every 2 seconds
  statusPollInterval = setInterval(checkStatus, 2000);
  // Check immediately
  checkStatus();
}

// Stop polling
function stopStatusPolling() {
  if (statusPollInterval) {
    clearInterval(statusPollInterval);
    statusPollInterval = null;
  }
}

// Show status message
function showStatus(type, message) {
  const statusDiv = document.getElementById('rebuild-status');
  const statusContent = document.getElementById('rebuild-status-content');

  statusDiv.classList.remove('hidden');

  // Update styling based on status
  statusContent.className = 'p-4 rounded-lg border';

  if (type === 'running' || type === 'pending') {
    statusContent.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-spinner fa-spin text-lg"></i>
        <div>
          <div class="font-semibold">Traitement en cours...</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'success') {
    statusContent.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-check-circle text-lg"></i>
        <div>
          <div class="font-semibold">Succès</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'error') {
    statusContent.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-exclamation-circle text-lg"></i>
        <div>
          <div class="font-semibold">Erreur</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  }
}

// Reset button to initial state
function resetButton() {
  const button = document.getElementById('rebuild-button');
  const buttonText = document.getElementById('rebuild-text');
  const buttonIcon = document.getElementById('rebuild-icon');

  button.disabled = false;
  button.classList.remove('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.remove('fa-spin');
  buttonText.textContent = 'Recalculer le tableau';
}

// Check status on page load if there's a task
window.addEventListener('DOMContentLoaded', function() {
  checkStatus();
  checkIDCCStatus();
});

// ============================================
// IDCC Enrichment Functions
// ============================================

let idccStatusPollInterval = null;

// Trigger the IDCC enrichment task
async function triggerEnrichirIDCC() {
  const button = document.getElementById('enrichir-idcc-button');
  const buttonText = document.getElementById('enrichir-idcc-text');
  const buttonIcon = document.getElementById('enrichir-idcc-icon');

  // Disable button
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.add('fa-spin');
  buttonText.textContent = 'Lancement en cours...';

  try {
    const response = await fetch('/api/enrichir/idcc', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': '{{ admin_api_key }}'
      }
    });

    const data = await response.json();

    if (data.status === 'started' || data.status === 'already_running') {
      // Start polling for status
      showIDCCStatus('running', data.message);
      startIDCCStatusPolling();
    } else {
      showIDCCStatus('error', data.message || 'Erreur lors du lancement de la tâche');
      resetIDCCButton();
    }
  } catch (error) {
    showIDCCStatus('error', 'Erreur réseau : ' + error.message);
    resetIDCCButton();
  }
}

// Poll the IDCC status endpoint
async function checkIDCCStatus() {
  try {
    const response = await fetch('/api/enrichir/idcc/status');
    const data = await response.json();

    if (data.status === 'not_found') {
      // No task has been run yet - hide status display
      const statusDiv = document.getElementById('enrichir-idcc-status');
      statusDiv.classList.add('hidden');
      return;
    }

    const status = data.status;

    if (status === 'running') {
      const elapsed = data.elapsed_seconds ? ` (${Math.round(data.elapsed_seconds)}s écoulées)` : '';
      showIDCCStatus('running', data.description + elapsed);
    } else if (status === 'completed') {
      const result = data.result || {};
      const enrichis = result.enrichis || 0;
      const total = result.total || 0;
      const erreurs = result.erreurs || 0;
      const duration = data.duration_seconds ? ` en ${Math.round(data.duration_seconds)}s` : '';
      showIDCCStatus('success', `✓ Enrichissement terminé : ${enrichis}/${total} IDCC récupérés (${erreurs} erreurs)${duration}`);
      stopIDCCStatusPolling();
      resetIDCCButton();
    } else if (status === 'failed') {
      showIDCCStatus('error', '✗ Erreur : ' + (data.error || 'Erreur inconnue'));
      stopIDCCStatusPolling();
      resetIDCCButton();
    } else if (status === 'pending') {
      showIDCCStatus('pending', 'Tâche en attente de démarrage...');
    }
  } catch (error) {
    console.error('Erreur lors de la vérification du statut IDCC:', error);
  }
}

// Start IDCC status polling
function startIDCCStatusPolling() {
  if (idccStatusPollInterval) {
    clearInterval(idccStatusPollInterval);
  }
  // Poll every 2 seconds
  idccStatusPollInterval = setInterval(checkIDCCStatus, 2000);
  // Check immediately
  checkIDCCStatus();
}

// Stop IDCC status polling
function stopIDCCStatusPolling() {
  if (idccStatusPollInterval) {
    clearInterval(idccStatusPollInterval);
    idccStatusPollInterval = null;
  }
}

// Show IDCC status message
function showIDCCStatus(type, message) {
  const statusDiv = document.getElementById('enrichir-idcc-status');
  const statusContent = document.getElementById('enrichir-idcc-status-content');

  statusDiv.classList.remove('hidden');

  // Update styling based on status
  statusContent.className = 'p-4 rounded-lg border';

  if (type === 'running' || type === 'pending') {
    statusContent.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-spinner fa-spin text-lg"></i>
        <div>
          <div class="font-semibold">Traitement en cours...</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'success') {
    statusContent.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-check-circle text-lg"></i>
        <div>
          <div class="font-semibold">Succès</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'error') {
    statusContent.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-exclamation-circle text-lg"></i>
        <div>
          <div class="font-semibold">Erreur</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  }
}

// Reset IDCC button to initial state
function resetIDCCButton() {
  const button = document.getElementById('enrichir-idcc-button');
  const buttonText = document.getElementById('enrichir-idcc-text');
  const buttonIcon = document.getElementById('enrichir-idcc-icon');

  button.disabled = false;
  button.classList.remove('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.remove('fa-spin');
  buttonText.textContent = 'Enrichir les IDCC';
}

// ============================================
// Chatbot IA Functions


// Check chatbot health on page load
async function checkChatbotStatus() {
  try {
    const response = await fetch('/api/chatbot/health');
    const data = await response.json();

    const statusEl = document.getElementById('chatbot-status');
    if (data.openai_configured) {
      statusEl.textContent = '✓ Opérationnel';
      statusEl.classList.remove('bg-gray-200', 'text-gray-600');
      statusEl.classList.add('bg-green-100', 'text-green-700');
    } else {
      statusEl.textContent = '✗ Non configuré';
      statusEl.classList.remove('bg-gray-200', 'text-gray-600');
      statusEl.classList.add('bg-yellow-100', 'text-yellow-700');
    }
  } catch (error) {
    console.error('Erreur lors de la vérification du chatbot:', error);
  }
}

// Handle chat form submission
document.getElementById('chat-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const input = document.getElementById('chat-input');
  const question = input.value.trim();

  if (!question) return;

  // Clear input
  input.value = '';

  // Add user message to chat
  addUserMessage(question);

  // Disable submit button
  const submitBtn = document.getElementById('chat-submit');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Envoi...';

  try {
    // Send question to chatbot
    const response = await fetch('/api/chatbot/ask', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ question })
    });

    const data = await response.json();

    // Add bot response to chat
    addBotMessage(data);

  } catch (error) {
    console.error('Erreur:', error);
    addBotMessage({
      answer: '❌ Une erreur est survenue. Veuillez réessayer.',
      error: error.message
    });
  } finally {
    // Re-enable submit button
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Envoyer';
    input.focus();
  }
});

// Add user message to chat
function addUserMessage(question) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageEl = document.createElement('div');
  messageEl.className = 'flex items-start gap-3 justify-end';
  messageEl.innerHTML = `
    <div class="max-w-2xl bg-indigo-500 text-white rounded-lg p-4 shadow-sm">
      <p class="text-sm">${escapeHtml(question)}</p>
    </div>
    <div class="flex-shrink-0 w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center">
      <i class="fas fa-user text-gray-600"></i>
    </div>
  `;
  messagesDiv.appendChild(messageEl);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Add bot message to chat
function addBotMessage(data) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageEl = document.createElement('div');
  messageEl.className = 'flex items-start gap-3';

  let content = `
    <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
      <i class="fas fa-comments text-white"></i>
    </div>
    <div class="flex-1 bg-white rounded-lg p-4 shadow-sm">
      <div class="prose prose-sm max-w-none">
        ${formatMarkdown(data.answer)}
      </div>
  `;

  // Add SQL query if available (collapsible)
  if (data.sql) {
    content += `
      <div class="mt-3 pt-3 border-t border-gray-200">
        <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1">
          <i class="fas fa-code"></i>
          Voir la requête SQL générée
          <i class="fas fa-chevron-down ml-1"></i>
        </button>
        <div class="hidden mt-2">
          <p class="text-xs text-gray-600 mb-1">${escapeHtml(data.sql_explanation || '')}</p>
          <pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto"><code>${escapeHtml(data.sql)}</code></pre>
          ${data.total_results ? `<p class="text-xs text-gray-500 mt-1">${data.total_results} résultat(s) trouvé(s)</p>` : ''}
        </div>
      </div>
    `;
  }

  content += `</div>`;
  messageEl.innerHTML = content;
  messagesDiv.appendChild(messageEl);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Ask a predefined question
function askPredefinedQuestion(question) {
  const input = document.getElementById('chat-input');
  input.value = question;
  document.getElementById('chat-form').dispatchEvent(new Event('submit'));
}

// Show more examples
async function showMoreExamples() {
  try {
    const response = await fetch('/api/chatbot/examples');
    const data = await response.json();

    const messagesDiv = document.getElementById('chat-messages');
    const messageEl = document.createElement('div');
    messageEl.className = 'flex items-start gap-3';

    let examplesHtml = '<div class="space-y-3">';
    for (const category of data.examples) {
      examplesHtml += `
        <div>
          <h4 class="font-semibold text-gray-800 mb-2">${escapeHtml(category.category)}</h4>
          <div class="space-y-1">
      `;
      for (const question of category.questions) {
        examplesHtml += `
          <button onclick="askPredefinedQuestion('${escapeHtml(question).replace(/'/g, "\\'")}'); this.closest('.flex').remove();" class="block w-full text-left px-3 py-2 text-xs bg-indigo-50 hover:bg-indigo-100 rounded transition">
            ${escapeHtml(question)}
          </button>
        `;
      }
      examplesHtml += '</div></div>';
    }
    examplesHtml += '</div>';

    messageEl.innerHTML = `
      <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
        <i class="fas fa-comments text-white"></i>
      </div>
      <div class="flex-1 bg-white rounded-lg p-4 shadow-sm">
        <p class="text-sm font-semibold text-gray-800 mb-3">✨ Voici plus d'exemples de questions :</p>
        ${examplesHtml}
      </div>
    `;

    messagesDiv.appendChild(messageEl);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  } catch (error) {
    console.error('Erreur lors du chargement des exemples:', error);
  }
}

// Utility: Escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Utility: Format markdown-like text (basic)
function formatMarkdown(text) {
  if (!text) return '';

  // Convert **bold** to <strong>
  text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  // Convert *italic* to <em>
  text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');

  // Convert newlines to <br>
  text = text.replace(/\n/g, '<br>');

  // Convert lists (lines starting with - or •)
  text = text.replace(/^[•\-]\s(.+)/gm, '<li>$1</li>');
  text = text.replace(/(<li>.*<\/li>)/s, '<ul class="list-disc list-inside space-y-1">$1</ul>');

  // Convert numbered lists
  text = text.replace(/^\d+\.\s(.+)/gm, '<li>$1</li>');

  return text;
}

// RAPPORT IA PAP
// ============================================

async function genererRapportIA() {
  // Affiche la modal
  const modal = document.getElementById('rapport-ia-modal');
  const modalContent = document.getElementById('rapport-ia-content');

  modal.classList.remove('hidden');

  // Affiche le loader
  modalContent.innerHTML = `
    <div class="flex flex-col items-center justify-center py-12">
      <i class="fas fa-chart-line fa-3x text-purple-600 mb-4 animate-pulse"></i>
      <p class="text-lg font-semibold text-gray-700">Analyse en cours...</p>
      <p class="text-sm text-gray-500 mt-2">Traitement des entreprises prioritaires</p>
      <div class="mt-4">
        <i class="fas fa-spinner fa-spin text-2xl text-purple-600"></i>
      </div>
    </div>
  `;

  try {
    const response = await fetch('/api/rapport-ia-pap');
    const data = await response.json();

    if (!data.success) {
      throw new Error('Erreur lors de la génération du rapport');
    }

    // Affiche le rapport
    afficherRapportIA(data);

  } catch (error) {
    modalContent.innerHTML = `
      <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
        <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
        <span class="text-red-800">Erreur: ${error.message}</span>
      </div>
    `;
  }
}

function afficherRapportIA(data) {
  const modalContent = document.getElementById('rapport-ia-content');
  const stats = data.statistiques;
  const p1 = data.priorite_1;
  const p2 = data.priorite_2;

  let html = `
    <!-- Header -->
    <div class="mb-6">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">⚡ Analyse Avancée PAP - Cibles Prioritaires</h2>
      <p class="text-sm text-gray-500">Généré le ${data.date_generation}</p>
    </div>

    <!-- Statistiques globales -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-purple-50 rounded-lg p-4">
        <p class="text-xs text-purple-600 font-semibold uppercase">Priorité 1</p>
        <p class="text-2xl font-bold text-purple-900">${stats.total_priorite_1}</p>
        <p class="text-xs text-purple-700">${stats.total_inscrits_p1.toLocaleString()} inscrits</p>
      </div>
      <div class="bg-blue-50 rounded-lg p-4">
        <p class="text-xs text-blue-600 font-semibold uppercase">Priorité 2</p>
        <p class="text-2xl font-bold text-blue-900">${stats.total_priorite_2}</p>
        <p class="text-xs text-blue-700">${stats.total_inscrits_p2.toLocaleString()} inscrits</p>
      </div>
      <div class="bg-green-50 rounded-lg p-4">
        <p class="text-xs text-green-600 font-semibold uppercase">CGT Implantée</p>
        <p class="text-2xl font-bold text-green-900">${stats.cgt_implantee_p1 + stats.cgt_implantee_p2}</p>
        <p class="text-xs text-green-700">P1: ${stats.cgt_implantee_p1} | P2: ${stats.cgt_implantee_p2}</p>
      </div>
      <div class="bg-orange-50 rounded-lg p-4">
        <p class="text-xs text-orange-600 font-semibold uppercase">En Carence</p>
        <p class="text-2xl font-bold text-orange-900">${stats.carence_p1 + stats.carence_p2}</p>
        <p class="text-xs text-orange-700">P1: ${stats.carence_p1} | P2: ${stats.carence_p2}</p>
      </div>
    </div>

    <!-- Filtre par région -->
    <div class="mb-6">
      <p class="text-sm font-semibold text-gray-700 mb-2">Filtrer par région:</p>
      <div class="flex flex-wrap gap-2" id="region-tabs">
        <!-- Les onglets de régions seront générés dynamiquement -->
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button onclick="switchTab('priorite-1')" id="tab-priorite-1" class="rapport-tab active border-b-2 border-purple-600 py-4 px-1 text-sm font-semibold text-purple-600">
            Priorité 1 (<span id="count-p1">${stats.total_priorite_1}</span>)
          </button>
          <button onclick="switchTab('priorite-2')" id="tab-priorite-2" class="rapport-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Priorité 2 (<span id="count-p2">${stats.total_priorite_2}</span>)
          </button>
        </nav>
      </div>
    </div>

    <!-- Content Priorité 1 -->
    <div id="content-priorite-1" class="rapport-content">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-gray-800">${p1.titre}</h3>
        <p class="text-sm text-gray-600">${p1.description}</p>
      </div>
      <div class="space-y-4 max-h-96 overflow-y-auto">
        ${p1.entreprises.map(e => genererCarteEntreprise(e)).join('')}
      </div>
    </div>

    <!-- Content Priorité 2 -->
    <div id="content-priorite-2" class="rapport-content hidden">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-gray-800">${p2.titre}</h3>
        <p class="text-sm text-gray-600">${p2.description}</p>
      </div>
      <div class="space-y-4 max-h-96 overflow-y-auto">
        ${p2.entreprises.map(e => genererCarteEntreprise(e)).join('')}
      </div>
    </div>

    <!-- Export button -->
    <div class="mt-6 flex justify-end space-x-3">
      <button onclick="exporterRapportPDF()" class="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700 transition">
        <i class="fas fa-file-pdf mr-2"></i>
        Télécharger PDF
      </button>
      <button onclick="exporterRapportJSON()" class="px-4 py-2 bg-gray-600 text-white text-sm font-semibold rounded-lg hover:bg-gray-700 transition">
        <i class="fas fa-download mr-2"></i>
        Télécharger JSON
      </button>
      <button onclick="fermerRapportIA()" class="px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700 transition">
        Fermer
      </button>
    </div>
  `;

  modalContent.innerHTML = html;

  // Générer et afficher les onglets de régions
  genererOngletsRegions(p1, p2);

  // Stocker les données globalement pour le filtrage
  window.rapportData = { p1, p2 };
  window.regionSelectionnee = 'toutes';
}

function genererOngletsRegions(p1, p2) {
  // Collecter toutes les régions uniques
  const regions = new Set();
  [...p1.entreprises, ...p2.entreprises].forEach(e => {
    if (e.region && e.region !== 'Non renseignée') {
      regions.add(e.region);
    }
  });

  const regionsArray = Array.from(regions).sort();
  const regionTabsContainer = document.getElementById('region-tabs');

  // Bouton "Toutes régions"
  let html = `
    <button onclick="filtrerParRegion('toutes')" id="region-tab-toutes"
            class="region-tab px-4 py-2 text-sm font-semibold rounded-lg bg-purple-600 text-white">
      Toutes régions
    </button>
  `;

  // Boutons pour chaque région
  regionsArray.forEach(region => {
    html += `
      <button onclick="filtrerParRegion('${region}')" id="region-tab-${region.replace(/[^a-zA-Z0-9]/g, '-')}"
              class="region-tab px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200">
        ${region}
      </button>
    `;
  });

  regionTabsContainer.innerHTML = html;
}

function filtrerParRegion(region) {
  window.regionSelectionnee = region;

  // Mettre à jour l'apparence des onglets de régions
  document.querySelectorAll('.region-tab').forEach(tab => {
    tab.classList.remove('bg-purple-600', 'text-white');
    tab.classList.add('bg-gray-100', 'text-gray-700');
  });

  const tabId = region === 'toutes' ? 'region-tab-toutes' : `region-tab-${region.replace(/[^a-zA-Z0-9]/g, '-')}`;
  const activeTab = document.getElementById(tabId);
  if (activeTab) {
    activeTab.classList.remove('bg-gray-100', 'text-gray-700');
    activeTab.classList.add('bg-purple-600', 'text-white');
  }

  // Filtrer les entreprises
  const { p1, p2 } = window.rapportData;

  const p1Filtrees = region === 'toutes'
    ? p1.entreprises
    : p1.entreprises.filter(e => e.region === region);

  const p2Filtrees = region === 'toutes'
    ? p2.entreprises
    : p2.entreprises.filter(e => e.region === region);

  // Mettre à jour les compteurs
  document.getElementById('count-p1').textContent = p1Filtrees.length;
  document.getElementById('count-p2').textContent = p2Filtrees.length;

  // Mettre à jour le contenu
  document.querySelector('#content-priorite-1 .space-y-4').innerHTML =
    p1Filtrees.map(e => genererCarteEntreprise(e)).join('') ||
    '<p class="text-gray-500 text-center py-8">Aucune entreprise dans cette région pour cette priorité</p>';

  document.querySelector('#content-priorite-2 .space-y-4').innerHTML =
    p2Filtrees.map(e => genererCarteEntreprise(e)).join('') ||
    '<p class="text-gray-500 text-center py-8">Aucune entreprise dans cette région pour cette priorité</p>';
}

function genererCarteEntreprise(e) {
  const carenceBadge = e.carence
    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-50 text-red-600">CARENCE</span>'
    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600">PV</span>';

  const cgtBadge = e.implantations_syndicales.includes('CGT')
    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600">CGT ✓</span>'
    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-50 text-orange-600">CGT ✗</span>';

  // Badge de date d'élection avec couleur selon urgence
  let dateBadge = '';
  if (e.jours_restants !== null && e.jours_restants !== undefined) {
    const joursColor = e.jours_restants <= 30
      ? 'bg-red-100 text-red-700'
      : e.jours_restants <= 90
        ? 'bg-orange-100 text-orange-700'
        : 'bg-blue-100 text-blue-700';
    dateBadge = `<span class="px-2 py-1 text-xs font-semibold rounded-full ${joursColor}">J-${e.jours_restants}</span>`;
  }

  return `
    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
      <div class="flex items-start justify-between mb-3">
        <div class="flex-1">
          <h4 class="text-lg font-bold text-gray-800">${e.raison_sociale}</h4>
          <p class="text-xs text-gray-500 font-mono">${e.siret}</p>
        </div>
        <div class="flex flex-col items-end space-y-1">
          ${dateBadge}
          ${carenceBadge}
          ${cgtBadge}
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 text-sm">
        <div>
          <p class="text-xs text-gray-500">Inscrits</p>
          <p class="font-semibold text-gray-800">${e.inscrits.toLocaleString()}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500">PV</p>
          <p class="font-semibold text-gray-800">${e.nb_pv}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500">Département</p>
          <p class="font-semibold text-gray-800">${e.departement}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500">Ville</p>
          <p class="font-semibold text-gray-800">${e.ville}</p>
        </div>
      </div>

      ${e.date_election !== 'Non renseignée' || (e.invitations_pap && e.invitations_pap.length > 0) ? `
      <div class="mb-3 bg-purple-50 p-3 rounded border border-purple-200">
        <p class="text-xs text-purple-700 font-semibold mb-2">📅 DATES IMPORTANTES</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
          ${e.date_election !== 'Non renseignée' ? `
          <div class="flex items-center gap-2">
            <span class="text-purple-600">🗳️</span>
            <div>
              <p class="text-xs text-purple-600 font-medium">Prochaine élection</p>
              <p class="font-bold text-purple-900">${e.date_election}</p>
              ${e.jours_restants !== null && e.jours_restants !== undefined ? `<p class="text-xs text-purple-700">Dans ${e.jours_restants} jours</p>` : ''}
            </div>
          </div>
          ` : ''}
          ${e.invitations_pap && e.invitations_pap.length > 0 ? `
          <div class="flex items-center gap-2">
            <span class="text-purple-600">📬</span>
            <div>
              <p class="text-xs text-purple-600 font-medium">Invitation(s) PAP</p>
              <p class="font-bold text-purple-900">${e.invitations_pap.join(', ')}</p>
            </div>
          </div>
          ` : ''}
        </div>
      </div>
      ` : ''}

      <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3 text-sm bg-blue-50 p-2 rounded border border-blue-200">
        <div>
          <p class="text-xs text-blue-600 font-semibold">FD (Fédération)</p>
          <p class="font-semibold text-gray-800">${e.fd || 'Non renseignée'}</p>
        </div>
        <div>
          <p class="text-xs text-blue-600 font-semibold">UD</p>
          <p class="font-semibold text-gray-800">${e.ud || 'Non renseigné'}</p>
        </div>
        <div>
          <p class="text-xs text-blue-600 font-semibold">IDCC</p>
          <p class="font-semibold text-gray-800">${e.idcc || 'Non renseigné'}</p>
        </div>
      </div>

      ${e.sve || e.votants ? `
      <div class="grid grid-cols-2 gap-3 mb-3 text-sm bg-gray-50 p-2 rounded border border-gray-200">
        <div>
          <p class="text-xs text-gray-600 font-semibold">SVE</p>
          <p class="font-semibold text-gray-800">${(e.sve || 0).toLocaleString()}</p>
        </div>
        <div>
          <p class="text-xs text-gray-600 font-semibold">Votants</p>
          <p class="font-semibold text-gray-800">${(e.votants || 0).toLocaleString()}</p>
        </div>
      </div>
      ` : ''}

      <div class="mb-3">
        <p class="text-xs text-gray-500 mb-1">Implantations syndicales:</p>
        <div class="flex flex-wrap gap-1">
          ${e.implantations_syndicales.map(org =>
            `<span class="px-2 py-1 text-xs rounded-full ${org === 'CGT' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">${org}</span>`
          ).join('')}
        </div>
      </div>

      ${e.voix_organisations && Object.keys(e.voix_organisations).length > 0 ? `
      <div class="mb-3">
        <p class="text-xs text-gray-500 mb-1">Résultats électoraux (voix):</p>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-2 text-xs">
          ${Object.entries(e.voix_organisations).sort((a, b) => b[1] - a[1]).map(([org, voix]) => {
            const pct = e.sve && e.sve > 0 ? ((voix / e.sve) * 100).toFixed(1) : '0';
            const bgColor = org === 'CGT' ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200';
            const textColor = org === 'CGT' ? 'text-red-700' : 'text-gray-700';
            return `<div class="p-2 rounded border ${bgColor}">
              <span class="font-semibold ${textColor}">${org}</span>:
              <span class="font-bold">${voix.toLocaleString()}</span>
              <span class="text-gray-500">(${pct}%)</span>
            </div>`;
          }).join('')}
        </div>
      </div>
      ` : ''}

      ${e.colleges && e.colleges.length > 0 ? `
      <div class="mb-3">
        <p class="text-xs text-gray-500 mb-1">Collèges électoraux (${e.colleges.length}):</p>
        <div class="flex flex-wrap gap-1">
          ${e.colleges.map(college =>
            `<span class="px-2 py-1 text-xs rounded bg-blue-50 text-blue-700 border border-blue-200">${college}</span>`
          ).join('')}
        </div>
      </div>
      ` : ''}

      <div>
        <p class="text-xs text-gray-500 mb-1">Enjeux identifiés:</p>
        <ul class="space-y-1">
          ${e.enjeux.map(enjeu =>
            `<li class="text-xs text-gray-700 flex items-start">
              <i class="fas fa-chevron-right text-purple-500 mr-2 mt-1 text-xs"></i>
              <span>${enjeu}</span>
            </li>`
          ).join('')}
        </ul>
      </div>
    </div>
  `;
}

function switchTab(tabName) {
  // Reset all tabs
  document.querySelectorAll('.rapport-tab').forEach(tab => {
    tab.classList.remove('active', 'border-purple-600', 'text-purple-600');
    tab.classList.add('border-transparent', 'text-gray-500');
  });

  // Hide all contents
  document.querySelectorAll('.rapport-content').forEach(content => {
    content.classList.add('hidden');
  });

  // Activate selected tab
  const selectedTab = document.getElementById(`tab-${tabName}`);
  selectedTab.classList.remove('border-transparent', 'text-gray-500');
  selectedTab.classList.add('active', 'border-purple-600', 'text-purple-600');

  // Show selected content
  document.getElementById(`content-${tabName}`).classList.remove('hidden');
}

let rapportDataGlobal = null;

function exporterRapportPDF() {
  // Méthode simple : utiliser window.print() pour générer un PDF
  // Le navigateur ouvrira la boîte de dialogue d'impression avec l'option "Enregistrer en PDF"

  // Masquer temporairement les boutons d'export
  const modalFooter = document.querySelector('#rapport-ia-modal .mt-6');
  if (modalFooter) {
    modalFooter.style.display = 'none';
  }

  // Lancer l'impression
  window.print();

  // Réafficher les boutons après impression
  setTimeout(() => {
    if (modalFooter) {
      modalFooter.style.display = 'flex';
    }
  }, 100);
}

async function exporterRapportJSON() {
  try {
    const response = await fetch('/api/rapport-ia-pap');
    const data = await response.json();

    // Crée un blob JSON
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    // Crée un lien de téléchargement
    const a = document.createElement('a');
    a.href = url;
    a.download = `rapport-ia-pap-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (error) {
    alert('Erreur lors de l\'export: ' + error.message);
  }
}

function fermerRapportIA() {
  const modal = document.getElementById('rapport-ia-modal');
  modal.classList.add('hidden');
}

// ============================================
// Assistant Expert Modal Functions

function ouvrirAssistantExpert() {
  const modal = document.getElementById('assistant-expert-modal');
  modal.classList.remove('hidden');

  // Check chatbot status when opening
  checkChatbotStatus();

  // Focus on input
  setTimeout(() => {
    const input = document.getElementById('chat-input');
    if (input) input.focus();
  }, 100);
}

function fermerAssistantExpert() {
  const modal = document.getElementById('assistant-expert-modal');
  modal.classList.add('hidden');
}
</script>

<!-- Modal Rapport IA -->
<div id="rapport-ia-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
    <div class="p-6 overflow-y-auto max-h-[90vh]" id="rapport-ia-content">
      <!-- Le contenu sera injecté ici -->
    </div>
  </div>
</div>

<!-- Modal Assistant Expert -->
<div id="assistant-expert-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between p-6 border-b border-gray-200 bg-gradient-to-r from-indigo-500 to-purple-600">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center justify-center w-12 h-12 bg-white/20 rounded-full">
          <i class="fas fa-comments text-white text-2xl"></i>
        </span>
        <div>
          <h2 class="text-2xl font-bold text-white">Assistant Expert</h2>
          <p class="text-sm text-indigo-100">Posez vos questions sur les données PAP/CSE en langage naturel</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="chatbot-status" class="px-3 py-1 text-xs font-semibold bg-white/20 text-white rounded-full">Vérification...</span>
        <button onclick="fermerAssistantExpert()" class="text-white hover:bg-white/20 rounded-lg p-2 transition">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Chat messages area -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50">
      <!-- Welcome message -->
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
          <i class="fas fa-comments text-white"></i>
        </div>
        <div class="flex-1 bg-white rounded-lg p-4 shadow-sm">
          <p class="text-sm text-gray-800 mb-3">
            👋 Bonjour ! Je suis votre assistant expert pour analyser les données PAP/CSE.
          </p>
          <p class="text-sm text-gray-700 mb-3">
            <strong>Exemples de questions que vous pouvez me poser :</strong>
          </p>
          <div class="space-y-2 text-xs">
            <button onclick="askPredefinedQuestion('Combien d\\'invitations PAP dans la base ?')" class="block w-full text-left px-3 py-2 bg-indigo-50 hover:bg-indigo-100 rounded transition">
              💭 "Combien d'invitations PAP dans la base ?"
            </button>
            <button onclick="askPredefinedQuestion('Quelles entreprises ont une élection ce mois-ci ?')" class="block w-full text-left px-3 py-2 bg-indigo-50 hover:bg-indigo-100 rounded transition">
              📅 "Quelles entreprises ont une élection ce mois-ci ?"
            </button>
            <button onclick="askPredefinedQuestion('Combien d\\'invitations en retard dans le 75 ?')" class="block w-full text-left px-3 py-2 bg-indigo-50 hover:bg-indigo-100 rounded transition">
              🔴 "Combien d'invitations en retard dans le 75 ?"
            </button>
            <button onclick="askPredefinedQuestion('Top 5 des fédérations avec le plus d\\'invitations')" class="block w-full text-left px-3 py-2 bg-indigo-50 hover:bg-indigo-100 rounded transition">
              🏢 "Top 5 des fédérations avec le plus d'invitations"
            </button>
            <button onclick="showMoreExamples()" class="block w-full text-left px-3 py-2 bg-purple-50 hover:bg-purple-100 rounded transition font-semibold text-purple-700">
              ✨ Voir plus d'exemples
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Input area -->
    <div class="border-t border-gray-200 p-4 bg-white">
      <form id="chat-form" class="flex gap-3">
        <input
          type="text"
          id="chat-input"
          placeholder="Posez votre question... (ex: Combien d'invitations en retard dans le 75 ?)"
          class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
          autocomplete="off"
        />
        <button
          type="submit"
          id="chat-submit"
          class="px-6 py-3 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-lg hover:from-indigo-600 hover:to-purple-700 transition flex items-center gap-2 font-semibold"
        >
          <i class="fas fa-paper-plane"></i>
          Envoyer
        </button>
      </form>
      <p class="text-xs text-gray-500 mt-2">
        <i class="fas fa-lightbulb mr-1"></i>
        Astuce : Soyez précis dans vos questions pour obtenir les meilleurs résultats
      </p>
    </div>
  </div>
</div>

{% endblock %}
