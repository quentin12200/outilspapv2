{% extends "base.html" %}
{% block title %}Administration ‚Äî PAP/CSE{% endblock %}

{% block content %}

<!-- Header -->
<div class="mb-8">
  <div class="flex items-center justify-between mb-2">
    <h1 class="text-4xl font-bold text-gray-800 flex items-center">
      <i class="fas fa-cog text-cgt-red mr-3"></i>
      Administration
    </h1>
    <a href="/admin/logout" class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors">
      <i class="fas fa-sign-out-alt mr-2"></i>
      D√©connexion
    </a>
  </div>
  <p class="text-gray-600">
    Suivi centralis√© des imports, automatisations et nouvelles fonctionnalit√©s de la plateforme PAP/CSE.
  </p>
</div>

<!-- Global metrics -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">PV enregistr√©s</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.pv_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-cgt-red/10 text-cgt-red rounded-full">
        <i class="fas fa-poll text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">SIRET distincts : {{ stats.pv_sirets or 0 }}</p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">R√©sum√© SIRET</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.summary_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 text-blue-600 rounded-full">
        <i class="fas fa-database text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">Dernier PV enregistr√© : {{ stats.last_summary or '‚Äî' }}</p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">Invitations PAP C5</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.invit_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-green-100 text-green-600 rounded-full">
        <i class="fas fa-envelope-open-text text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">Derni√®re invitation : {{ stats.last_invitation or '‚Äî' }}</p>
  </div>

  <div class="bg-white rounded-xl shadow-md p-6">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold text-gray-500 uppercase">√âlections ‚â• {{ upcoming_threshold }}</p>
        <p class="text-3xl font-bold text-gray-900">{{ stats.upcoming_total or 0 }}</p>
      </div>
      <span class="inline-flex items-center justify-center w-12 h-12 bg-purple-100 text-purple-600 rounded-full">
        <i class="fas fa-calendar-day text-xl"></i>
      </span>
    </div>
    <p class="text-xs text-gray-500">Prochaine √©ch√©ance : {{ stats.upcoming_next or '‚Äî' }}</p>
  </div>
</div>

<!-- Quick actions -->
<section class="mb-10">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Raccourcis & nouvelles fonctionnalit√©s</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
    <button onclick="genererRapportIA()" class="flex items-center justify-between px-5 py-4 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl shadow hover:shadow-lg transition border border-pink-200 hover:from-pink-600 hover:to-purple-700">
      <div class="text-left">
        <p class="text-sm font-semibold">ü§ñ Rapport IA - Situation PAP</p>
        <p class="text-xs opacity-90">Analyse intelligente des cibles prioritaires</p>
      </div>
      <i class="fas fa-robot text-white text-xl"></i>
    </button>

    <a href="/calendrier" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-purple-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Calendrier prochaines √©lections +1000</p>
        <p class="text-xs text-gray-500">Vue d√©di√©e aux scrutins √† venir (date_prochain_scrutin)</p>
      </div>
      <i class="fas fa-calendar-alt text-purple-500 text-xl"></i>
    </a>

    <a href="/invitations" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-green-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Tableau Invitations PAP</p>
        <p class="text-xs text-gray-500">Consultez et filtrez les imports automatiques ou manuels</p>
      </div>
      <i class="fas fa-envelope text-green-500 text-xl"></i>
    </a>

    <a href="/admin/diagnostics" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-red-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Diagnostic des doublons</p>
        <p class="text-xs text-gray-500">D√©tection & nettoyage des invitations import√©es plusieurs fois</p>
      </div>
      <i class="fas fa-stethoscope text-red-500 text-xl"></i>
    </a>

    <a href="#imports" class="flex items-center justify-between px-5 py-4 bg-white rounded-xl shadow hover:shadow-lg transition border border-blue-100">
      <div>
        <p class="text-sm font-semibold text-gray-700">Import manuel</p>
        <p class="text-xs text-gray-500">Acc√©der rapidement aux formulaires d'import Excel</p>
      </div>
      <i class="fas fa-file-upload text-blue-500 text-xl"></i>
    </a>
  </div>
</section>

<!-- Upcoming elections preview -->
<section class="bg-white rounded-xl shadow-md p-6 mb-10">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-800">Calendrier des prochaines √©lections ‚â• {{ upcoming_threshold }}</h2>
      <p class="text-sm text-gray-500">Les donn√©es proviennent de la colonne ¬´ date_prochain_scrutin ¬ª crois√©e avec l'effectif SIRET.</p>
    </div>
    <a href="/calendrier" class="inline-flex items-center px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700 transition">
      <i class="fas fa-external-link-alt mr-2"></i>
      Ouvrir le calendrier complet
    </a>
  </div>

  {% if upcoming_preview %}
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 text-sm">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Date</th>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Entreprise / SIRET</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Effectif</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Cycle</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Type</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">FD</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">IDCC</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">SVE</th>
          <th class="px-4 py-3 text-center font-semibold text-gray-600">Participation</th>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Top 3 organisations</th>
          <th class="px-4 py-3 text-left font-semibold text-gray-600">Implantation</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {% for item in upcoming_preview %}
        <tr class="hover:bg-purple-50/40">
          <td class="px-4 py-3 font-semibold text-gray-700">{{ item.date_display }}</td>
          <td class="px-4 py-3">
            <div class="font-semibold text-gray-800">{{ item.raison_sociale or '‚Äî' }}</div>
            <div class="text-xs text-gray-500 tracking-widest">{{ item.siret or '‚Äî' }}</div>
          </td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.effectif or '‚Äî' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.cycle or '‚Äî' }}</td>
          <td class="px-4 py-3 text-center">
            {% if item.institution == 'CAR' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-50 text-red-600">Carence</span>
            {% elif item.institution == 'CSE' %}
              <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600">CSE</span>
            {% else %}
              <span class="text-gray-700">{{ item.institution or '‚Äî' }}</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.fd or '‚Äî' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.idcc or '‚Äî' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.sve_display or '‚Äî' }}</td>
          <td class="px-4 py-3 text-center text-gray-700">{{ item.participation_display or '‚Äî' }}</td>
          <td class="px-4 py-3 text-gray-700">
            {% if item.top_orgs %}
            <ul class="space-y-1">
              {% for org in item.top_orgs %}
              <li class="flex items-baseline justify-between gap-3">
                <span class="font-semibold text-gray-800">{{ org.label }}</span>
                <span class="text-sm text-gray-600">{{ org.votes_display or '‚Äî' }}{% if org.percent_display %} <span class="text-xs text-gray-500">({{ org.percent_display }})</span>{% endif %}</span>
              </li>
              {% endfor %}
            </ul>
            {% else %}
            <span class="text-gray-400">‚Äî</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-gray-700">
            <div>{{ item.ud or '‚Äî' }}</div>
            <div class="text-xs text-gray-500">{{ item.region or '‚Äî' }}</div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <p class="text-xs text-gray-500 mt-3">Affichage des 5 prochaines √©ch√©ances. Utilisez le calendrier pour explorer l'int√©gralit√© des scrutins √† venir.</p>
  {% else %}
  <div class="p-6 bg-purple-50 border border-dashed border-purple-200 rounded-lg text-purple-700">
    <i class="fas fa-info-circle mr-2"></i>
    Aucun scrutin ‚â• {{ upcoming_threshold }} salari√© √† venir n'a √©t√© d√©tect√© dans la base pour le moment.
  </div>
  {% endif %}
</section>

<!-- Automations -->
<section class="mb-12">
  <h2 class="text-2xl font-bold text-gray-800 mb-4">Automatisations & int√©grations</h2>
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    {% set db = db_asset %}
    <div class="bg-white rounded-xl shadow-md p-6 border border-blue-50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">Base papcse.db</h3>
          <p class="text-xs text-gray-500">T√©l√©chargement automatique depuis GitHub Release</p>
        </div>
        {% if db.exists %}
          <span class="px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Disponible</span>
        {% else %}
          <span class="px-3 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">Introuvable</span>
        {% endif %}
      </div>
      <ul class="text-sm text-gray-600 space-y-2">
        <li><strong>Chemin :</strong> <code class="bg-gray-100 px-2 py-1 rounded">{{ db.path or '‚Äî' }}</code></li>
        <li><strong>Taille :</strong> {{ db.size_mb ~ ' Mo' if db.size_mb else '‚Äî' }}</li>
        <li>
          <strong>Source Release :</strong>
          {% if db.url %}
            <a href="{{ db.url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ db.url }}</a>
          {% else %}
            <span>Non configur√©</span>
          {% endif %}
        </li>
        <li>
          <strong>Hash attendu :</strong>
          {% if db.expected_hash %}
            <code class="bg-gray-100 px-2 py-1 rounded break-all">{{ db.expected_hash }}</code>
          {% else %}
            <span>Non fourni</span>
          {% endif %}
        </li>
        <li>
          <strong>Hash calcul√© :</strong>
          {% if db.actual_hash %}
            <code class="bg-gray-100 px-2 py-1 rounded break-all">{{ db.actual_hash }}</code>
            {% if db.expected_hash %}
              {% if db.hash_match %}
                <span class="ml-2 px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full">Conforme</span>
              {% else %}
                <span class="ml-2 px-2 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full">√Ä v√©rifier</span>
              {% endif %}
            {% endif %}
          {% else %}
            <span>‚Äî</span>
          {% endif %}
        </li>
      </ul>
      <p class="text-xs text-gray-500 mt-4">
        La base est t√©l√©charg√©e au d√©marrage si elle est absente. Supprimez le fichier local pour forcer un rafra√Æchissement depuis la release configur√©e.
      </p>
    </div>

    {% set invit = invitations_asset %}
    <div class="bg-white rounded-xl shadow-md p-6 border border-green-50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">Invitations PAP C5</h3>
          <p class="text-xs text-gray-500">Pr√©chargement automatique lors du premier d√©marrage</p>
        </div>
        {% if invit.auto_enabled %}
          <span class="px-3 py-1 text-xs font-semibold bg-green-100 text-green-700 rounded-full">Auto-chargement activ√©</span>
        {% else %}
          <span class="px-3 py-1 text-xs font-semibold bg-gray-100 text-gray-600 rounded-full">Auto-chargement d√©sactiv√©</span>
        {% endif %}
      </div>
      <ul class="text-sm text-gray-600 space-y-2">
        <li>
          <strong>Source Release :</strong>
          {% if invit.url %}
            <a href="{{ invit.url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ invit.url }}</a>
          {% else %}
            <span>Non configur√©</span>
          {% endif %}
        </li>
        {% if not invit.url and invit.inferred_url %}
          <li class="text-xs text-gray-500">
            <strong>URL d√©duite :</strong>
            <a href="{{ invit.inferred_url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ invit.inferred_url }}</a>
            {% if invit.inferred_urls and invit.inferred_urls|length > 1 %}
              <span class="ml-1 text-gray-400">(+{{ invit.inferred_urls|length - 1 }} variante{{ 's' if invit.inferred_urls|length > 2 else '' }})</span>
            {% endif %}
          </li>
        {% endif %}
        <li><strong>Invitations en base :</strong> {{ invit.count or 0 }}</li>
        <li><strong>Derni√®re date import√©e :</strong> {{ invit.last_date or '‚Äî' }}</li>
        {% if invit.effective_url %}
          <li class="text-xs text-gray-500">
            <strong>Dernier import automatique :</strong>
            <a href="{{ invit.effective_url }}" class="text-blue-600 underline" target="_blank" rel="noopener">{{ invit.effective_url }}</a>
          </li>
        {% endif %}
        <li>
          <strong>Hash attendu :</strong>
          {% if invit.expected_hash %}
            <code class="bg-gray-100 px-2 py-1 rounded break-all">{{ invit.expected_hash }}</code>
          {% else %}
            <span>Non fourni</span>
          {% endif %}
        </li>
      </ul>
      <p class="text-xs text-gray-500 mt-4">
        Si la table est vide au d√©marrage, le fichier configur√© est import√© automatiquement puis disponible dans le tableau ¬´ Invitations PAP - Cycle 5 ¬ª.
      </p>
    </div>

    {% set sirene = sirene_status %}
    <div class="bg-white rounded-xl shadow-md p-6 border border-indigo-50">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-semibold text-gray-800">API Sirene</h3>
          <p class="text-xs text-gray-500">Enrichissement SIRET via la cl√© INSEE</p>
        </div>
        {% if sirene.configured %}
          <span class="px-3 py-1 text-xs font-semibold bg-indigo-100 text-indigo-700 rounded-full">Cl√© d√©tect√©e</span>
        {% else %}
          <span class="px-3 py-1 text-xs font-semibold bg-yellow-100 text-yellow-700 rounded-full">Cl√© manquante</span>
        {% endif %}
      </div>
      <ul class="text-sm text-gray-600 space-y-2">
        <li>
          <strong>Variables Railway :</strong>
          <code class="bg-gray-100 px-2 py-1 rounded">SIRENE_API_KEY</code>
          <span class="text-xs text-gray-400">(cl√© int√©gration)</span>
          <span class="mx-2 text-gray-300">‚Ä¢</span>
          <code class="bg-gray-100 px-2 py-1 rounded">SIRENE_API_TOKEN</code>
          <span class="text-xs text-gray-400">(token OAuth)</span>
        </li>
        <li><strong>Statut :</strong> {% if sirene.configured %}{{ sirene.masked }}{% else %}Non configur√©e{% endif %}</li>
        {% if sirene.has_integration_key %}
          <li><strong>En-t√™te HTTP :</strong> <code class="bg-gray-100 px-2 py-1 rounded">X-INSEE-Api-Key-Integration</code></li>
        {% elif sirene.has_token %}
          <li><strong>En-t√™te HTTP :</strong> <code class="bg-gray-100 px-2 py-1 rounded">Authorization: Bearer ...</code></li>
        {% endif %}
        <li><strong>Usages :</strong> autocomplete SIRET, fiches entreprises, enrichissement invitations.</li>
      </ul>
      <p class="text-xs text-gray-500 mt-4">
        Ajoutez la cl√© fournie par l'INSEE sur Railway pour activer l'enrichissement automatique des raisons sociales et adresses lors des imports ou recherches SIRET.
      </p>
    </div>
  </div>
</section>

<!-- Import forms -->
<section id="imports" class="mb-12">
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-800">Imports manuels</h2>
    <p class="text-sm text-gray-500">Chargez ici vos fichiers Excel mis √† jour. Recalculez ensuite le tableau de synth√®se pour rafra√Æchir le tableau de bord.</p>
  </div>
  <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
    <!-- Import PV -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-file-excel text-blue-500 mr-2"></i>
        Importer PV (Excel initial)
      </h3>
      <form method="post" action="/api/ingest/pv" enctype="multipart/form-data" class="space-y-4">
        <div>
          <label for="pvfile" class="block text-sm font-semibold text-gray-700 mb-2">S√©lectionnez le fichier Excel des PV</label>
          <input type="file" name="file" id="pvfile" required accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 border border-gray-300 rounded-lg cursor-pointer" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-upload"></i>
          <span>Importer les PV</span>
        </button>
        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Import des Proc√®s-Verbaux des √©lections professionnelles (onglet ¬´ Tous PV ¬ª).</p>
      </form>
    </section>

    <!-- Import Invitations -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-envelope text-green-500 mr-2"></i>
        Importer Invitations PAP (Cycle 5)
      </h3>
      <form method="post" action="/api/ingest/invit" enctype="multipart/form-data" class="space-y-4">
        <div>
          <label for="invitfile" class="block text-sm font-semibold text-gray-700 mb-2">S√©lectionnez le fichier Excel des invitations</label>
          <input type="file" name="file" id="invitfile" required accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 border border-gray-300 rounded-lg cursor-pointer" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-upload"></i>
          <span>Importer les invitations</span>
        </button>
        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Ajoutez ici les invitations compl√©mentaires ou mises √† jour du cycle 5.</p>
      </form>
    </section>

    <!-- Import Ciblage -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-crosshairs text-purple-500 mr-2"></i>
        Importer fichier de ciblage
      </h3>
      <form method="post" action="/ciblage/import" enctype="multipart/form-data" class="space-y-4">
        <div>
          <label for="ciblagefile" class="block text-sm font-semibold text-gray-700 mb-2">S√©lectionnez le fichier de ciblage</label>
          <input type="file" name="file" id="ciblagefile" required accept=".xlsx,.xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100 border border-gray-300 rounded-lg cursor-pointer" />
        </div>
        <button type="submit" class="w-full px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-upload"></i>
          <span>Importer le ciblage</span>
        </button>
        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Utilisez ce module pour croiser vos listes (CAC40, SBF120‚Ä¶) avec les invitations d√©tect√©es.</p>
      </form>
    </section>

    <!-- Rebuild summary -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-sync text-orange-500 mr-2"></i>
        Recalculer le tableau de synth√®se
      </h3>
      <div class="space-y-4">
        <div class="p-4 bg-orange-50 border-l-4 border-orange-500 rounded-lg text-sm text-orange-800">
          <i class="fas fa-exclamation-triangle mr-2"></i>
          √Ä utiliser apr√®s chaque import PV ou invitation pour mettre √† jour le tableau de bord.
        </div>

        <!-- Status display -->
        <div id="rebuild-status" class="hidden">
          <div class="p-4 rounded-lg border" id="rebuild-status-content">
            <!-- Status will be inserted here -->
          </div>
        </div>

        <!-- Action button -->
        <button id="rebuild-button" onclick="triggerRebuild()" class="w-full px-6 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-sync-alt" id="rebuild-icon"></i>
          <span id="rebuild-text">Recalculer le tableau</span>
        </button>

        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>Le recalcul nettoie les donn√©es, reconstruit <code>siret_summary</code> et alimente les graphiques du tableau de bord.</p>
      </div>
    </section>

    <!-- Enrichir IDCC -->
    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-6">
        <i class="fas fa-building text-indigo-500 mr-2"></i>
        Enrichir les IDCC manquants
      </h3>
      <div class="space-y-4">
        <div class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-lg text-sm text-indigo-800">
          <i class="fas fa-info-circle mr-2"></i>
          Enrichit les invitations PAP sans IDCC via l'API SIRENE de l'INSEE.
        </div>

        <!-- Status display -->
        <div id="enrichir-idcc-status" class="hidden">
          <div class="p-4 rounded-lg border" id="enrichir-idcc-status-content">
            <!-- Status will be inserted here -->
          </div>
        </div>

        <!-- Action button -->
        <button id="enrichir-idcc-button" onclick="triggerEnrichirIDCC()" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition shadow-md flex items-center justify-center space-x-2">
          <i class="fas fa-database" id="enrichir-idcc-icon"></i>
          <span id="enrichir-idcc-text">Enrichir les IDCC</span>
        </button>

        <p class="text-xs text-gray-500 flex items-start"><i class="fas fa-info-circle mr-2 mt-0.5"></i>R√©cup√®re l'IDCC (Convention Collective) depuis l'API SIRENE pour chaque invitation sans IDCC. Permet ensuite d'identifier la FD (F√©d√©ration) correspondante.</p>
      </div>
    </section>
  </div>
</section>

<!-- Quality tools and reminders -->
<section class="mb-12">
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <section class="bg-white rounded-xl shadow-md p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-800 flex items-center"><i class="fas fa-stethoscope text-red-500 mr-2"></i>Diagnostic des doublons</h3>
        <a href="/admin/diagnostics" class="px-3 py-1 text-xs font-semibold bg-red-100 text-red-700 rounded-full">Ouvrir</a>
      </div>
      <p class="text-sm text-gray-600 mb-4">D√©tecte et supprime automatiquement les invitations import√©es plusieurs fois (garde la plus r√©cente par SIRET).</p>
      <ul class="text-xs text-gray-500 space-y-2">
        <li><i class="fas fa-check text-green-500 mr-2"></i>Compteur global, SIRET uniques et nombre de doublons.</li>
        <li><i class="fas fa-check text-green-500 mr-2"></i>Top 10 des SIRET concern√©s avec aper√ßu des dates import√©es.</li>
        <li><i class="fas fa-check text-green-500 mr-2"></i>Bouton de suppression rapide (garde la ligne la plus r√©cente).</li>
      </ul>
    </section>

    <section class="bg-white rounded-xl shadow-md p-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Processus recommand√©</h3>
      <ol class="space-y-4 text-sm text-gray-600">
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">1</span>
          <div>
            <strong>Importer les PV</strong>
            <p class="text-xs text-gray-500 mt-1">Utilisez l'onglet ¬´ Tous PV ¬ª de votre fichier Excel.</p>
          </div>
        </li>
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">2</span>
          <div>
            <strong>Ajouter les invitations PAP</strong>
            <p class="text-xs text-gray-500 mt-1">Import manuel ou automatique via la variable <code>INVITATIONS_URL</code>.</p>
          </div>
        </li>
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">3</span>
          <div>
            <strong>Recalculer le tableau</strong>
            <p class="text-xs text-gray-500 mt-1">Cliquez sur ¬´ Recalculer ¬ª pour alimenter <code>siret_summary</code>, le tableau de bord et le calendrier.</p>
          </div>
        </li>
        <li class="flex items-start space-x-3">
          <span class="flex items-center justify-center w-6 h-6 bg-cgt-red text-white rounded-full text-sm font-bold">4</span>
          <div>
            <strong>V√©rifier les doublons</strong>
            <p class="text-xs text-gray-500 mt-1">Contr√¥lez la qualit√© des invitations avec l'outil diagnostic.</p>
          </div>
        </li>
      </ol>
    </section>
  </div>
</section>

<!-- Reference information -->
<section class="bg-white rounded-xl shadow-md p-6 mb-12">
  <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-database text-gray-600 mr-3"></i>
    Informations techniques
  </h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-sm text-gray-600">
    <div>
      <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2">Tables principales</h3>
      <ul class="space-y-1 text-xs">
        <li>‚Ä¢ <code>Tous_PV</code> (historique des PV)</li>
        <li>‚Ä¢ <code>invitations</code> (PAP cycle 5)</li>
        <li>‚Ä¢ <code>siret_summary</code> (agr√©gations tableau de bord)</li>
      </ul>
    </div>
    <div>
      <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2">Formats accept√©s</h3>
      <ul class="space-y-1 text-xs">
        <li>‚Ä¢ Excel (.xlsx)</li>
        <li>‚Ä¢ Excel 97-2003 (.xls)</li>
      </ul>
    </div>
    <div>
      <h3 class="text-sm font-semibold text-gray-700 uppercase mb-2">S√©curit√© & int√©grit√©</h3>
      <ul class="space-y-1 text-xs">
        <li>‚Ä¢ Validation SHA256 (DB & invitations)</li>
        <li>‚Ä¢ T√©l√©chargements GitHub Release s√©curis√©s</li>
        <li>‚Ä¢ Donn√©es stock√©es en local SQLite</li>
      </ul>
    </div>
  </div>
</section>

<!-- Background task management script -->
<script>
let statusPollInterval = null;

// Trigger the rebuild task
async function triggerRebuild() {
  const button = document.getElementById('rebuild-button');
  const buttonText = document.getElementById('rebuild-text');
  const buttonIcon = document.getElementById('rebuild-icon');

  // Disable button
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.add('fa-spin');
  buttonText.textContent = 'Lancement en cours...';

  try {
    const response = await fetch('/api/build/summary', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': '{{ admin_api_key }}'
      }
    });

    const data = await response.json();

    if (data.status === 'started' || data.status === 'already_running') {
      // Start polling for status
      showStatus('running', data.message);
      startStatusPolling();
    } else {
      showStatus('error', data.message || 'Erreur lors du lancement de la t√¢che');
      resetButton();
    }
  } catch (error) {
    showStatus('error', 'Erreur r√©seau : ' + error.message);
    resetButton();
  }
}

// Poll the status endpoint
async function checkStatus() {
  try {
    const response = await fetch('/api/build/summary/status');
    const data = await response.json();

    if (data.status === 'not_found') {
      // No task has been run yet - hide status display
      const statusDiv = document.getElementById('rebuild-status');
      statusDiv.classList.add('hidden');
      return;
    }

    const status = data.status;

    if (status === 'running') {
      const elapsed = data.elapsed_seconds ? ` (${Math.round(data.elapsed_seconds)}s √©coul√©es)` : '';
      showStatus('running', data.description + elapsed);
    } else if (status === 'completed') {
      const rows = data.result?.rows || 0;
      const duration = data.duration_seconds ? ` en ${Math.round(data.duration_seconds)}s` : '';
      showStatus('success', `‚úì Reconstruction termin√©e avec succ√®s : ${rows} lignes g√©n√©r√©es${duration}`);
      stopStatusPolling();
      resetButton();
    } else if (status === 'failed') {
      showStatus('error', '‚úó Erreur : ' + (data.error || 'Erreur inconnue'));
      stopStatusPolling();
      resetButton();
    } else if (status === 'pending') {
      showStatus('pending', 'T√¢che en attente de d√©marrage...');
    }
  } catch (error) {
    console.error('Erreur lors de la v√©rification du statut:', error);
  }
}

// Start polling
function startStatusPolling() {
  if (statusPollInterval) {
    clearInterval(statusPollInterval);
  }
  // Poll every 2 seconds
  statusPollInterval = setInterval(checkStatus, 2000);
  // Check immediately
  checkStatus();
}

// Stop polling
function stopStatusPolling() {
  if (statusPollInterval) {
    clearInterval(statusPollInterval);
    statusPollInterval = null;
  }
}

// Show status message
function showStatus(type, message) {
  const statusDiv = document.getElementById('rebuild-status');
  const statusContent = document.getElementById('rebuild-status-content');

  statusDiv.classList.remove('hidden');

  // Update styling based on status
  statusContent.className = 'p-4 rounded-lg border';

  if (type === 'running' || type === 'pending') {
    statusContent.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-spinner fa-spin text-lg"></i>
        <div>
          <div class="font-semibold">Traitement en cours...</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'success') {
    statusContent.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-check-circle text-lg"></i>
        <div>
          <div class="font-semibold">Succ√®s</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'error') {
    statusContent.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-exclamation-circle text-lg"></i>
        <div>
          <div class="font-semibold">Erreur</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  }
}

// Reset button to initial state
function resetButton() {
  const button = document.getElementById('rebuild-button');
  const buttonText = document.getElementById('rebuild-text');
  const buttonIcon = document.getElementById('rebuild-icon');

  button.disabled = false;
  button.classList.remove('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.remove('fa-spin');
  buttonText.textContent = 'Recalculer le tableau';
}

// Check status on page load if there's a task
window.addEventListener('DOMContentLoaded', function() {
  checkStatus();
  checkIDCCStatus();
});

// ============================================
// IDCC Enrichment Functions
// ============================================

let idccStatusPollInterval = null;

// Trigger the IDCC enrichment task
async function triggerEnrichirIDCC() {
  const button = document.getElementById('enrichir-idcc-button');
  const buttonText = document.getElementById('enrichir-idcc-text');
  const buttonIcon = document.getElementById('enrichir-idcc-icon');

  // Disable button
  button.disabled = true;
  button.classList.add('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.add('fa-spin');
  buttonText.textContent = 'Lancement en cours...';

  try {
    const response = await fetch('/api/enrichir/idcc', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-Key': '{{ admin_api_key }}'
      }
    });

    const data = await response.json();

    if (data.status === 'started' || data.status === 'already_running') {
      // Start polling for status
      showIDCCStatus('running', data.message);
      startIDCCStatusPolling();
    } else {
      showIDCCStatus('error', data.message || 'Erreur lors du lancement de la t√¢che');
      resetIDCCButton();
    }
  } catch (error) {
    showIDCCStatus('error', 'Erreur r√©seau : ' + error.message);
    resetIDCCButton();
  }
}

// Poll the IDCC status endpoint
async function checkIDCCStatus() {
  try {
    const response = await fetch('/api/enrichir/idcc/status');
    const data = await response.json();

    if (data.status === 'not_found') {
      // No task has been run yet - hide status display
      const statusDiv = document.getElementById('enrichir-idcc-status');
      statusDiv.classList.add('hidden');
      return;
    }

    const status = data.status;

    if (status === 'running') {
      const elapsed = data.elapsed_seconds ? ` (${Math.round(data.elapsed_seconds)}s √©coul√©es)` : '';
      showIDCCStatus('running', data.description + elapsed);
    } else if (status === 'completed') {
      const result = data.result || {};
      const enrichis = result.enrichis || 0;
      const total = result.total || 0;
      const erreurs = result.erreurs || 0;
      const duration = data.duration_seconds ? ` en ${Math.round(data.duration_seconds)}s` : '';
      showIDCCStatus('success', `‚úì Enrichissement termin√© : ${enrichis}/${total} IDCC r√©cup√©r√©s (${erreurs} erreurs)${duration}`);
      stopIDCCStatusPolling();
      resetIDCCButton();
    } else if (status === 'failed') {
      showIDCCStatus('error', '‚úó Erreur : ' + (data.error || 'Erreur inconnue'));
      stopIDCCStatusPolling();
      resetIDCCButton();
    } else if (status === 'pending') {
      showIDCCStatus('pending', 'T√¢che en attente de d√©marrage...');
    }
  } catch (error) {
    console.error('Erreur lors de la v√©rification du statut IDCC:', error);
  }
}

// Start IDCC status polling
function startIDCCStatusPolling() {
  if (idccStatusPollInterval) {
    clearInterval(idccStatusPollInterval);
  }
  // Poll every 2 seconds
  idccStatusPollInterval = setInterval(checkIDCCStatus, 2000);
  // Check immediately
  checkIDCCStatus();
}

// Stop IDCC status polling
function stopIDCCStatusPolling() {
  if (idccStatusPollInterval) {
    clearInterval(idccStatusPollInterval);
    idccStatusPollInterval = null;
  }
}

// Show IDCC status message
function showIDCCStatus(type, message) {
  const statusDiv = document.getElementById('enrichir-idcc-status');
  const statusContent = document.getElementById('enrichir-idcc-status-content');

  statusDiv.classList.remove('hidden');

  // Update styling based on status
  statusContent.className = 'p-4 rounded-lg border';

  if (type === 'running' || type === 'pending') {
    statusContent.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-spinner fa-spin text-lg"></i>
        <div>
          <div class="font-semibold">Traitement en cours...</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'success') {
    statusContent.classList.add('bg-green-50', 'border-green-200', 'text-green-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-check-circle text-lg"></i>
        <div>
          <div class="font-semibold">Succ√®s</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  } else if (type === 'error') {
    statusContent.classList.add('bg-red-50', 'border-red-200', 'text-red-800');
    statusContent.innerHTML = `
      <div class="flex items-center space-x-3">
        <i class="fas fa-exclamation-circle text-lg"></i>
        <div>
          <div class="font-semibold">Erreur</div>
          <div class="text-sm mt-1">${message}</div>
        </div>
      </div>
    `;
  }
}

// Reset IDCC button to initial state
function resetIDCCButton() {
  const button = document.getElementById('enrichir-idcc-button');
  const buttonText = document.getElementById('enrichir-idcc-text');
  const buttonIcon = document.getElementById('enrichir-idcc-icon');

  button.disabled = false;
  button.classList.remove('opacity-50', 'cursor-not-allowed');
  buttonIcon.classList.remove('fa-spin');
  buttonText.textContent = 'Enrichir les IDCC';
}

// ============================================
// RAPPORT IA PAP
// ============================================

async function genererRapportIA() {
  // Affiche la modal
  const modal = document.getElementById('rapport-ia-modal');
  const modalContent = document.getElementById('rapport-ia-content');

  modal.classList.remove('hidden');

  // Affiche le loader
  modalContent.innerHTML = `
    <div class="flex flex-col items-center justify-center py-12">
      <i class="fas fa-robot fa-3x text-purple-600 mb-4 animate-pulse"></i>
      <p class="text-lg font-semibold text-gray-700">G√©n√©ration du rapport IA en cours...</p>
      <p class="text-sm text-gray-500 mt-2">Analyse des entreprises prioritaires</p>
      <div class="mt-4">
        <i class="fas fa-spinner fa-spin text-2xl text-purple-600"></i>
      </div>
    </div>
  `;

  try {
    const response = await fetch('/api/rapport-ia-pap');
    const data = await response.json();

    if (!data.success) {
      throw new Error('Erreur lors de la g√©n√©ration du rapport');
    }

    // Affiche le rapport
    afficherRapportIA(data);

  } catch (error) {
    modalContent.innerHTML = `
      <div class="p-6 bg-red-50 border border-red-200 rounded-lg">
        <i class="fas fa-exclamation-circle text-red-600 mr-2"></i>
        <span class="text-red-800">Erreur: ${error.message}</span>
      </div>
    `;
  }
}

function afficherRapportIA(data) {
  const modalContent = document.getElementById('rapport-ia-content');
  const stats = data.statistiques;
  const p1 = data.priorite_1;
  const p2 = data.priorite_2;

  let html = `
    <!-- Header -->
    <div class="mb-6">
      <h2 class="text-3xl font-bold text-gray-800 mb-2">ü§ñ Rapport IA - Analyse PAP Prioritaire</h2>
      <p class="text-sm text-gray-500">G√©n√©r√© le ${data.date_generation}</p>
    </div>

    <!-- Statistiques globales -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="bg-purple-50 rounded-lg p-4">
        <p class="text-xs text-purple-600 font-semibold uppercase">Priorit√© 1</p>
        <p class="text-2xl font-bold text-purple-900">${stats.total_priorite_1}</p>
        <p class="text-xs text-purple-700">${stats.total_inscrits_p1.toLocaleString()} inscrits</p>
      </div>
      <div class="bg-blue-50 rounded-lg p-4">
        <p class="text-xs text-blue-600 font-semibold uppercase">Priorit√© 2</p>
        <p class="text-2xl font-bold text-blue-900">${stats.total_priorite_2}</p>
        <p class="text-xs text-blue-700">${stats.total_inscrits_p2.toLocaleString()} inscrits</p>
      </div>
      <div class="bg-green-50 rounded-lg p-4">
        <p class="text-xs text-green-600 font-semibold uppercase">CGT Implant√©e</p>
        <p class="text-2xl font-bold text-green-900">${stats.cgt_implantee_p1 + stats.cgt_implantee_p2}</p>
        <p class="text-xs text-green-700">P1: ${stats.cgt_implantee_p1} | P2: ${stats.cgt_implantee_p2}</p>
      </div>
      <div class="bg-orange-50 rounded-lg p-4">
        <p class="text-xs text-orange-600 font-semibold uppercase">En Carence</p>
        <p class="text-2xl font-bold text-orange-900">${stats.carence_p1 + stats.carence_p2}</p>
        <p class="text-xs text-orange-700">P1: ${stats.carence_p1} | P2: ${stats.carence_p2}</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="mb-6">
      <div class="border-b border-gray-200">
        <nav class="-mb-px flex space-x-8">
          <button onclick="switchTab('priorite-1')" id="tab-priorite-1" class="rapport-tab active border-b-2 border-purple-600 py-4 px-1 text-sm font-semibold text-purple-600">
            Priorit√© 1 (${stats.total_priorite_1})
          </button>
          <button onclick="switchTab('priorite-2')" id="tab-priorite-2" class="rapport-tab border-b-2 border-transparent py-4 px-1 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Priorit√© 2 (${stats.total_priorite_2})
          </button>
        </nav>
      </div>
    </div>

    <!-- Content Priorit√© 1 -->
    <div id="content-priorite-1" class="rapport-content">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-gray-800">${p1.titre}</h3>
        <p class="text-sm text-gray-600">${p1.description}</p>
      </div>
      <div class="space-y-4 max-h-96 overflow-y-auto">
        ${p1.entreprises.map(e => genererCarteEntreprise(e)).join('')}
      </div>
    </div>

    <!-- Content Priorit√© 2 -->
    <div id="content-priorite-2" class="rapport-content hidden">
      <div class="mb-4">
        <h3 class="text-xl font-bold text-gray-800">${p2.titre}</h3>
        <p class="text-sm text-gray-600">${p2.description}</p>
      </div>
      <div class="space-y-4 max-h-96 overflow-y-auto">
        ${p2.entreprises.map(e => genererCarteEntreprise(e)).join('')}
      </div>
    </div>

    <!-- Export button -->
    <div class="mt-6 flex justify-end space-x-3">
      <button onclick="exporterRapportJSON()" class="px-4 py-2 bg-gray-600 text-white text-sm font-semibold rounded-lg hover:bg-gray-700 transition">
        <i class="fas fa-download mr-2"></i>
        T√©l√©charger JSON
      </button>
      <button onclick="fermerRapportIA()" class="px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700 transition">
        Fermer
      </button>
    </div>
  `;

  modalContent.innerHTML = html;
}

function genererCarteEntreprise(e) {
  const carenceBadge = e.carence
    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-50 text-red-600">CARENCE</span>'
    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600">PV</span>';

  const cgtBadge = e.implantations_syndicales.includes('CGT')
    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-50 text-green-600">CGT ‚úì</span>'
    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-orange-50 text-orange-600">CGT ‚úó</span>';

  return `
    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition">
      <div class="flex items-start justify-between mb-3">
        <div class="flex-1">
          <h4 class="text-lg font-bold text-gray-800">${e.raison_sociale}</h4>
          <p class="text-xs text-gray-500 font-mono">${e.siret}</p>
        </div>
        <div class="flex flex-col items-end space-y-1">
          ${carenceBadge}
          ${cgtBadge}
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3 text-sm">
        <div>
          <p class="text-xs text-gray-500">Inscrits</p>
          <p class="font-semibold text-gray-800">${e.inscrits.toLocaleString()}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500">Coll√®ges</p>
          <p class="font-semibold text-gray-800">${e.nb_colleges}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500">D√©partement</p>
          <p class="font-semibold text-gray-800">${e.departement}</p>
        </div>
        <div>
          <p class="text-xs text-gray-500">Ville</p>
          <p class="font-semibold text-gray-800">${e.ville}</p>
        </div>
      </div>

      <div class="mb-3">
        <p class="text-xs text-gray-500 mb-1">Implantations syndicales:</p>
        <div class="flex flex-wrap gap-1">
          ${e.implantations_syndicales.map(org =>
            `<span class="px-2 py-1 text-xs rounded-full ${org === 'CGT' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700'}">${org}</span>`
          ).join('')}
        </div>
      </div>

      ${e.invitations_pap.length > 0 ? `
      <div class="mb-3">
        <p class="text-xs text-gray-500 mb-1">Invitations PAP:</p>
        <p class="text-xs text-gray-700">${e.invitations_pap.join(', ')}</p>
      </div>
      ` : ''}

      <div>
        <p class="text-xs text-gray-500 mb-1">Enjeux identifi√©s:</p>
        <ul class="space-y-1">
          ${e.enjeux.map(enjeu =>
            `<li class="text-xs text-gray-700 flex items-start">
              <i class="fas fa-chevron-right text-purple-500 mr-2 mt-1 text-xs"></i>
              <span>${enjeu}</span>
            </li>`
          ).join('')}
        </ul>
      </div>
    </div>
  `;
}

function switchTab(tabName) {
  // Reset all tabs
  document.querySelectorAll('.rapport-tab').forEach(tab => {
    tab.classList.remove('active', 'border-purple-600', 'text-purple-600');
    tab.classList.add('border-transparent', 'text-gray-500');
  });

  // Hide all contents
  document.querySelectorAll('.rapport-content').forEach(content => {
    content.classList.add('hidden');
  });

  // Activate selected tab
  const selectedTab = document.getElementById(`tab-${tabName}`);
  selectedTab.classList.remove('border-transparent', 'text-gray-500');
  selectedTab.classList.add('active', 'border-purple-600', 'text-purple-600');

  // Show selected content
  document.getElementById(`content-${tabName}`).classList.remove('hidden');
}

let rapportDataGlobal = null;

async function exporterRapportJSON() {
  try {
    const response = await fetch('/api/rapport-ia-pap');
    const data = await response.json();

    // Cr√©e un blob JSON
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);

    // Cr√©e un lien de t√©l√©chargement
    const a = document.createElement('a');
    a.href = url;
    a.download = `rapport-ia-pap-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (error) {
    alert('Erreur lors de l\'export: ' + error.message);
  }
}

function fermerRapportIA() {
  const modal = document.getElementById('rapport-ia-modal');
  modal.classList.add('hidden');
}
</script>

<!-- Modal Rapport IA -->
<div id="rapport-ia-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
    <div class="p-6 overflow-y-auto max-h-[90vh]" id="rapport-ia-content">
      <!-- Le contenu sera inject√© ici -->
    </div>
  </div>
</div>

{% endblock %}
