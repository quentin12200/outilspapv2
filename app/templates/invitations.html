{% extends "base.html" %}
{% block title %}Invitations PAP â€” PAP/CSE{% endblock %}

{% block content %}
<section class="mb-8">
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    <div>
      <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
        <i class="fas fa-envelope-open-text text-cgt-red"></i>
        Invitations PAP importÃ©es
      </h1>
      <p class="text-sm text-gray-500 mt-2 max-w-2xl">
        Retrouvez ci-dessous l'ensemble des invitations au PAP Cycle 5 importÃ©es dans l'outil. Utilisez les filtres pour affiner la liste ou cliquer sur les en-tÃªtes du tableau pour rÃ©ordonner les colonnes.
      </p>
    </div>
    <div class="bg-white rounded-xl shadow px-5 py-4 text-center">
      <p class="text-sm text-gray-500 uppercase font-semibold">Invitations recensÃ©es</p>
      <p class="text-3xl font-bold text-gray-800">{{ total_invitations }}</p>
    </div>
  </div>

  <form method="get" class="bg-white rounded-xl shadow-md border border-gray-200 p-6 mb-8">
    <h3 class="text-lg font-bold text-gray-800 mb-4">
      <i class="fas fa-filter text-cgt-red mr-2"></i>
      Filtres de recherche
    </h3>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
      <!-- Recherche gÃ©nÃ©rale -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="q">
          <i class="fas fa-search text-cgt-red mr-1"></i>
          Recherche
        </label>
        <input id="q" name="q" value="{{ q }}" type="text" placeholder="SIRET, raison sociale, ville..."
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
      </div>

      <!-- Union DÃ©partementale (UD) -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="ud">
          <i class="fas fa-flag-checkered text-cgt-red mr-1"></i>
          Union DÃ©partementale (UD)
        </label>
        <select id="ud" name="ud" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes les UD</option>
          {% for item in all_uds %}
          <option value="{{ item }}" {% if ud == item %}selected{% endif %}>{{ item }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- FÃ©dÃ©ration (FD) -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="fd">
          <i class="fas fa-building text-cgt-red mr-1"></i>
          FÃ©dÃ©ration (FD)
        </label>
        <select id="fd" name="fd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes les FD</option>
          {% for item in all_fds %}
          <option value="{{ item }}" {% if fd == item %}selected{% endif %}>{{ item }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- DÃ©partement -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="departement">
          <i class="fas fa-map-marker-alt text-cgt-red mr-1"></i>
          DÃ©partement
        </label>
        <select id="departement" name="departement" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous les dÃ©partements</option>
          {% for dept in all_depts %}
          <option value="{{ dept }}" {% if departement == dept %}selected{% endif %}>{{ dept }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Statut -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="statut">
          <i class="fas fa-info-circle text-cgt-red mr-1"></i>
          Statut
        </label>
        <select id="statut" name="statut" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous les statuts</option>
          <option value="pv_c5_enregistre" {% if statut == 'pv_c5_enregistre' %}selected{% endif %}>ðŸ”µ PV C5 enregistrÃ©</option>
          <option value="en_attente" {% if statut == 'en_attente' %}selected{% endif %}>ðŸŸ¡ En attente de PV</option>
        </select>
      </div>

      <!-- Source -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="source">
          <i class="fas fa-inbox text-cgt-red mr-1"></i>
          Source
        </label>
        <select id="source" name="source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Toutes</option>
          {% for item in sources %}
          <option value="{{ item }}" {% if source == item %}selected{% endif %}>{{ item }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Ã‰tablissement actif -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="est_actif">
          <i class="fas fa-industry text-cgt-red mr-1"></i>
          Ã‰tablissement actif
        </label>
        <select id="est_actif" name="est_actif" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous</option>
          <option value="oui" {% if est_actif == 'oui' %}selected{% endif %}>Oui</option>
          <option value="non" {% if est_actif == 'non' %}selected{% endif %}>Non</option>
        </select>
      </div>

      <!-- SiÃ¨ge social -->
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-2" for="est_siege">
          <i class="fas fa-building text-cgt-red mr-1"></i>
          SiÃ¨ge social
        </label>
        <select id="est_siege" name="est_siege" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cgt-red focus:border-transparent">
          <option value="">Tous</option>
          <option value="oui" {% if est_siege == 'oui' %}selected{% endif %}>Oui</option>
          <option value="non" {% if est_siege == 'non' %}selected{% endif %}>Non</option>
        </select>
      </div>
    </div>

    <div class="mt-6 flex flex-col md:flex-row gap-3 md:justify-end">
      <a href="/invitations" class="px-5 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition inline-flex items-center gap-2">
        <i class="fas fa-undo"></i>
        RÃ©initialiser
      </a>
      <button type="submit" class="px-6 py-2 rounded-lg bg-cgt-red text-white hover:bg-cgt-darkred transition inline-flex items-center gap-2">
        <i class="fas fa-filter"></i>
        Appliquer
      </button>
    </div>
  </form>
</section>

<section class="bg-white rounded-xl shadow-md border border-gray-200 p-6">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
      <i class="fas fa-list"></i>
      Liste des invitations
    </h2>
    <button onclick="toggleFullscreenTable('invitations-table')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
      <i class="fas fa-expand mr-2"></i>
      Plein Ã©cran
    </button>
  </div>
  {% if invitations %}
  <div class="overflow-x-auto rounded-lg border border-gray-200">
    <table id="invitations-table" class="min-w-full divide-y divide-gray-200" data-sortable="true">
      <thead class="bg-gradient-to-r from-cgt-red to-cgt-darkred text-white">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">Statut</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date invitation</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">SIRET</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">Raison sociale</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">UD</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">FD</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">DÃ©partement</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">Ville</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase" data-sort-type="date">Date PV C5</th>
          <th class="px-4 py-3 text-left text-xs font-bold uppercase">Source</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for invit in invitations %}
        {% set display_denomination = invit.display_denomination %}
        {% set display_commune = invit.display_commune %}
        {% set dept = invit.code_postal[:2] if invit.code_postal and invit.code_postal|length >= 2 else 'â€”' %}
        <tr class="table-row-hover hover:bg-cgt-lightred">
          <!-- Statut avec badge -->
          <td class="px-4 py-3 whitespace-nowrap">
            {% if invit.statut_badge == 'green' %}
              <span class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
                <i class="fas {{ invit.statut_icon }} mr-1"></i>
                {{ invit.statut_label }}
              </span>
            {% elif invit.statut_badge == 'blue' %}
              <span class="inline-flex items-center px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                <i class="fas {{ invit.statut_icon }} mr-1"></i>
                {{ invit.statut_label }}
              </span>
            {% elif invit.statut_badge == 'yellow' %}
              <span class="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-semibold">
                <i class="fas {{ invit.statut_icon }} mr-1"></i>
                {{ invit.statut_label }}
              </span>
            {% elif invit.statut_badge == 'red' %}
              <span class="inline-flex items-center px-3 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">
                <i class="fas {{ invit.statut_icon }} mr-1"></i>
                {{ invit.statut_label }}
              </span>
            {% else %}
              <span class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">
                <i class="fas {{ invit.statut_icon }} mr-1"></i>
                {{ invit.statut_label }}
              </span>
            {% endif %}
          </td>
          <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ invit.date_invit or '' }}">{{ invit.date_invit or '' }}</td>
          <td class="px-4 py-3 whitespace-nowrap">
            <a href="/siret/{{ invit.siret }}" class="text-blue-600 hover:text-blue-800 font-medium">{{ invit.siret }}</a>
          </td>
          <td class="px-4 py-3">{{ display_denomination or 'â€”' }}</td>
          <td class="px-4 py-3">{{ invit.ud or 'â€”' }}</td>
          <td class="px-4 py-3">{{ invit.fd or 'â€”' }}</td>
          <td class="px-4 py-3 text-center">
            <span class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs font-semibold">{{ dept }}</span>
          </td>
          <td class="px-4 py-3">{{ display_commune or 'â€”' }}</td>
          <td class="px-4 py-3 whitespace-nowrap" data-sort-value="{{ invit.date_pv_c5 or '' }}">
            {% if invit.date_pv_c5 %}
              <span class="text-blue-700 font-semibold">{{ invit.date_pv_c5 }}</span>
            {% else %}
              <span class="text-gray-400">â€”</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">{{ invit.source or 'â€”' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-sm text-gray-500">Aucune invitation n'a encore Ã©tÃ© importÃ©e.</p>
  {% endif %}
</section>
{% endblock %}
