{% extends "base.html" %}
{% block title %}Statistiques — PAP/CSE{% endblock %}

{% block head %}
<style>
  [x-cloak] {
    display: none !important;
  }
  .stat-card {
    transition: all 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
  }
  .section-nav a {
    position: relative;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 9999px;
    font-weight: 600;
    color: #374151;
    background-color: rgba(255, 255, 255, 0.9);
    transition: transform 0.2s ease, box-shadow 0.2s ease, color 0.2s ease;
  }
  .section-nav a:hover {
    color: #d5001c;
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -8px rgba(213, 0, 28, 0.6);
  }
</style>
{% endblock %}

{% block content %}
<section class="space-y-12" x-data="dashboardData()" x-init="loadStats()">
  <header class="relative overflow-hidden rounded-3xl bg-gradient-to-br from-cgt-red via-cgt-darkred to-gray-900 text-white shadow-2xl">
    <div class="absolute inset-0 opacity-30 bg-[radial-gradient(circle_at_top_right,rgba(255,255,255,0.8),transparent_60%)]"></div>
    <div class="relative px-8 py-12 lg:px-16 flex flex-col gap-10 lg:flex-row lg:items-center lg:justify-between">
      <div class="space-y-6 max-w-2xl">
        <div class="flex flex-wrap items-center gap-3">
          <span class="inline-flex items-center px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] rounded-full bg-white/10">Statistiques</span>
          <button @click="loadStats()" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/15 hover:bg-white/25 transition text-sm font-semibold">
            <i class="fas fa-sync-alt"></i>
            Actualiser
          </button>
        </div>
        <h1 class="text-3xl lg:text-4xl font-black leading-tight">Suivi consolidé des invitations PAP et des échéances C5</h1>
        <p class="text-white/80 text-base">
          Analysez en un coup d'œil la cible ≥ <span x-text="stats.audience_threshold || 1000">1000</span> inscrit·es, les invitations PAP C5 et les correspondances PV pour préparer au mieux les campagnes.
        </p>
        <div class="flex flex-wrap gap-3">
          <a href="#vue-generale" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/15 hover:bg-white/25 transition text-sm font-semibold">
            <i class="fas fa-layer-group"></i>
            Vue générale
          </a>
          <a href="#graphiques" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/15 hover:bg-white/25 transition text-sm font-semibold">
            <i class="fas fa-chart-bar"></i>
            Graphiques
          </a>
          <a href="#statuts" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/15 hover:bg-white/25 transition text-sm font-semibold">
            <i class="fas fa-circle-info"></i>
            Statuts PAP
          </a>
        </div>
      </div>
      <div class="w-full max-w-md bg-white/10 border border-white/20 rounded-2xl p-6 backdrop-blur space-y-4">
        <p class="text-sm text-white/70">
          Sur cette page, vous trouverez une synthèse interactive alignée sur les données de l'espace d'administration. Chaque bloc est mis à jour automatiquement à partir des API «&nbsp;stats&nbsp;».
        </p>
        <div class="grid grid-cols-2 gap-3 text-left">
          <div class="bg-white/10 rounded-xl p-3">
            <p class="text-xs uppercase tracking-widest text-white/70">Période invitations</p>
            <p class="text-sm font-semibold" x-text="stats.invitations_period_start_display || '—'"></p>
            <p class="text-sm" x-text="stats.invitations_period_end_display ? '→ ' + stats.invitations_period_end_display : ''"></p>
          </div>
          <div class="bg-white/10 rounded-xl p-3">
            <p class="text-xs uppercase tracking-widest text-white/70">Couverture PAP ↔ PV</p>
            <p class="text-sm font-semibold" x-text="stats.pap_pv_overlap_percent != null ? stats.pap_pv_overlap_percent.toLocaleString('fr-FR') + ' %' : '—'"></p>
          </div>
        </div>
      </div>
    </div>
  </header>

  <nav class="section-nav flex flex-wrap items-center gap-3 justify-center" aria-label="Navigation des sections statistiques">
    <a href="#vue-generale"><i class="fas fa-layer-group"></i>Vue générale</a>
    <a href="#graphiques"><i class="fas fa-chart-bar"></i>Graphiques</a>
    <a href="#statuts"><i class="fas fa-circle-info"></i>Statuts PAP</a>
  </nav>

  <div x-cloak x-show="loading" x-transition.opacity.duration.300ms class="fixed inset-0 z-20 flex items-center justify-center bg-white/80">
    <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md space-y-6 text-center border border-gray-200">
      <div class="flex justify-center">
        <span class="w-16 h-16 border-4 border-cgt-red border-t-transparent rounded-full animate-spin"></span>
      </div>
      <div>
        <p class="text-lg font-semibold text-gray-800">Chargement des données…</p>
        <p class="text-sm text-gray-500">Merci de patienter, les indicateurs se préparent.</p>
      </div>
      <div class="space-y-2">
        <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
          <div class="bg-cgt-red h-2 transition-all duration-200 ease-out" :style="`width: ${loadingProgress}%`"></div>
        </div>
        <p class="text-sm font-medium text-gray-600" x-text="`${loadingProgress}%`"></p>
      </div>
    </div>
  </div>

  <section id="vue-generale" class="space-y-6" :class="{ 'pointer-events-none select-none opacity-60': loading }">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.4em] text-gray-500">Statistiques consolidées</p>
        <p class="text-sm text-gray-600">Indicateurs issus du module d'administration</p>
      </div>
      <p class="text-xs text-gray-500">Seuil cible : <span class="font-semibold" x-text="stats.audience_threshold || 1000"></span> inscrit·es</p>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
      <div class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-blue-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-blue-600">PV enregistrés</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.pv_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xl"><i class="fas fa-poll"></i></span>
        </div>
        <p class="text-xs text-gray-600">SIRET distincts : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.pv_sirets || 0).toLocaleString('fr-FR') : '0'"></span></p>
      </div>
      <div class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-green-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-green-600">Résumé SIRET</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.summary_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-green-100 text-green-600 flex items-center justify-center text-xl"><i class="fas fa-database"></i></span>
        </div>
        <p class="text-xs text-gray-600">Dernier PV enregistré : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.last_summary || '—') : '—'"></span></p>
      </div>
      <div class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-red-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-cgt-red">Invitations PAP C5</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.invit_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-red-100 text-cgt-red flex items-center justify-center text-xl"><i class="fas fa-envelope-open-text"></i></span>
        </div>
        <p class="text-xs text-gray-600">Dernière invitation : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.last_invitation || '—') : '—'"></span></p>
      </div>
      <div class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-purple-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-purple-600">Élections C5 ≥ <span x-text="stats.global_stats ? (stats.global_stats.upcoming_threshold || 1000).toLocaleString('fr-FR') : 1000"></span></p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.global_stats ? (stats.global_stats.upcoming_total || 0).toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-xl"><i class="fas fa-calendar-day"></i></span>
        </div>
        <p class="text-xs text-gray-600">Prochaine échéance : <span class="font-semibold" x-text="stats.global_stats ? (stats.global_stats.upcoming_next || '—') : '—'"></span></p>
        <p class="text-xs text-gray-600">Période cycle 5 : <span class="font-semibold" x-text="formatUpcomingPeriod(stats.audience_upcoming_period_start_display, stats.audience_upcoming_period_end_display)"></span></p>
        <p class="text-xs text-gray-600">Fenêtre déclarée : <span class="font-semibold" x-text="formatUpcomingPeriod(stats.audience_upcoming_coverage_start_display, stats.audience_upcoming_coverage_end_display)"></span></p>
        <p class="text-xs text-gray-600">Part de la cible : <span class="font-semibold" x-text="stats.audience_upcoming_declared_percent != null ? stats.audience_upcoming_declared_percent.toLocaleString('fr-FR') + ' %' : '—'"></span></p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
      <div x-show="stats.taux_reponse_pap > 0" x-cloak class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-orange-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-orange-600">Taux de réponse PAP</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.taux_reponse_pap != null ? stats.taux_reponse_pap.toLocaleString('fr-FR') + ' %' : '0 %'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center text-xl"><i class="fas fa-reply"></i></span>
        </div>
        <p class="text-xs text-gray-600">Réponses reçues : <span class="font-semibold" x-text="stats.invitations_avec_reponse != null ? stats.invitations_avec_reponse.toLocaleString('fr-FR') : '0'"></span></p>
      </div>

      <div x-show="stats.audience_cgt_implantee_percent > 0" x-cloak class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-emerald-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-emerald-600">Couverture CGT cible</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.audience_cgt_implantee_percent != null ? stats.audience_cgt_implantee_percent.toLocaleString('fr-FR') + ' %' : '0 %'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center text-xl"><i class="fas fa-users"></i></span>
        </div>
        <p class="text-xs text-gray-600">CGT implantée : <span class="font-semibold" x-text="stats.audience_cgt_implantee != null ? stats.audience_cgt_implantee.toLocaleString('fr-FR') : '0'"></span> SIRET</p>
      </div>

      <div x-show="stats.elections_next_30_days > 0" x-cloak class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-amber-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-amber-600">Élections imminentes</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.elections_next_30_days != null ? stats.elections_next_30_days.toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center text-xl"><i class="fas fa-bell"></i></span>
        </div>
        <p class="text-xs text-gray-600">À venir dans 30 jours</p>
      </div>

      <div x-show="stats.taux_programmation_elections > 0" x-cloak class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-indigo-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-indigo-600">Programmation élections</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.taux_programmation_elections != null ? stats.taux_programmation_elections.toLocaleString('fr-FR') + ' %' : '0 %'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center text-xl"><i class="fas fa-calendar-check"></i></span>
        </div>
        <p class="text-xs text-gray-600">Élections programmées : <span class="font-semibold" x-text="stats.invitations_election_programmee != null ? stats.invitations_election_programmee.toLocaleString('fr-FR') : '0'"></span></p>
      </div>

      <div x-show="stats.invitations_sans_reponse_30j > 0" x-cloak class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-rose-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-rose-600">Alertes sans réponse</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.invitations_sans_reponse_30j != null ? stats.invitations_sans_reponse_30j.toLocaleString('fr-FR') : '0'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-rose-100 text-rose-600 flex items-center justify-center text-xl"><i class="fas fa-exclamation-triangle"></i></span>
        </div>
        <p class="text-xs text-gray-600">Sans réponse &gt; 30 jours</p>
      </div>

      <div x-show="stats.taux_enrichissement_sirene > 0" x-cloak class="stat-card bg-white rounded-2xl shadow-lg p-6 border border-cyan-100">
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-widest text-cyan-600">Enrichissement SIRENE</p>
            <p class="text-2xl font-bold text-gray-900" x-text="stats.taux_enrichissement_sirene != null ? stats.taux_enrichissement_sirene.toLocaleString('fr-FR') + ' %' : '0 %'"></p>
          </div>
          <span class="w-11 h-11 rounded-full bg-cyan-100 text-cyan-600 flex items-center justify-center text-xl"><i class="fas fa-database"></i></span>
        </div>
        <p class="text-xs text-gray-600">Invitations enrichies : <span class="font-semibold" x-text="stats.invitations_enrichies != null ? stats.invitations_enrichies.toLocaleString('fr-FR') : '0'"></span></p>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-sm font-semibold uppercase tracking-widest text-gray-500 mb-3">Autres indicateurs</h3>
        <dl class="space-y-3 text-sm text-gray-600">
          <div class="flex items-center justify-between">
            <dt>Total invitations sur la période</dt>
            <dd class="font-semibold" x-text="stats.invitations_period_total != null ? stats.invitations_period_total.toLocaleString('fr-FR') : '—'"></dd>
          </div>
          <div class="flex items-center justify-between">
            <dt>Correspondances PAP ↔ PV</dt>
            <dd class="font-semibold" x-text="stats.pap_pv_overlap != null ? stats.pap_pv_overlap.toLocaleString('fr-FR') : '—'"></dd>
          </div>
          <div class="flex items-center justify-between">
            <dt>Historique C3</dt>
            <dd class="font-semibold" x-text="stats.autres_possessions_c3 != null ? stats.autres_possessions_c3.toLocaleString('fr-FR') : '—'"></dd>
          </div>
          <div class="flex items-center justify-between">
            <dt>Historique C4</dt>
            <dd class="font-semibold" x-text="stats.autres_possessions_c4 != null ? stats.autres_possessions_c4.toLocaleString('fr-FR') : '—'"></dd>
          </div>
        </dl>
      </div>
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
        <h3 class="text-sm font-semibold uppercase tracking-widest text-gray-500 mb-3">Actions rapides</h3>
        <div class="space-y-3">
          <a href="/invitations" class="flex items-center justify-between px-4 py-3 rounded-xl border border-gray-200 hover:border-cgt-red hover:text-cgt-red transition">
            <span><i class="fas fa-envelope-open-text mr-2"></i> Consulter les invitations</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </a>
          <a href="/recherche-siret" class="flex items-center justify-between px-4 py-3 rounded-xl border border-gray-200 hover:border-cgt-red hover:text-cgt-red transition">
            <span><i class="fas fa-search mr-2"></i> Recherche SIRET</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </a>
          <a href="/calendrier" class="flex items-center justify-between px-4 py-3 rounded-xl border border-gray-200 hover:border-cgt-red hover:text-cgt-red transition">
            <span><i class="fas fa-calendar-check mr-2"></i> Calendrier +1000</span>
            <i class="fas fa-chevron-right text-sm"></i>
          </a>
        </div>
      </div>
    </div>
  </section>

  <section id="graphiques" class="space-y-6" :class="{ 'pointer-events-none select-none opacity-60': loading }">
    <header class="flex items-center justify-between flex-wrap gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.4em] text-gray-500">Visualisations</p>
        <p class="text-sm text-gray-600">Comparer les départements, les invitations mensuelles et les échéances déclarées</p>
      </div>
      <button type="button" @click="loadStats()" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-200 text-gray-700 hover:border-cgt-red hover:text-cgt-red transition text-sm font-semibold">
        <i class="fas fa-rotate"></i> Rafraîchir les données
      </button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="mb-4 flex items-start justify-between gap-3">
          <div>
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-map-marked-alt text-cgt-red mr-2"></i>
              Top 10 départements (C4 ≥ <span x-text="stats.audience_threshold || 1000"></span> inscrit·es)
            </h3>
            <p class="text-xs text-gray-600 mt-1">
              <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 • SIRET prioritaires par département
            </p>
          </div>
          <button
            type="button"
            class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 hover:text-cgt-red hover:border-cgt-red transition disabled:opacity-40 disabled:cursor-not-allowed"
            @click="openChartModal('departments')"
            :disabled="!stats.departments || !stats.departments.length"
            title="Agrandir le graphique"
            aria-label="Agrandir le graphique des départements"
            aria-haspopup="dialog"
          >
            <i class="fas fa-up-right-and-down-left-from-center"></i>
          </button>
        </div>
        <div style="height: 300px; position: relative;">
          <canvas id="departmentsChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="mb-4 flex items-start justify-between gap-3">
          <div>
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-calendar-alt text-cgt-red mr-2"></i>
              Invitations mensuelles (cible)
            </h3>
            <p class="text-xs text-gray-600 mt-1">
              <i class="fas fa-envelope mr-1"></i><strong>Source :</strong> Invitations C5 (toutes entrées)
            </p>
          </div>
          <button
            type="button"
            class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 hover:text-cgt-red hover:border-cgt-red transition disabled:opacity-40 disabled:cursor-not-allowed"
            @click="openChartModal('monthly')"
            :disabled="!stats.monthly_invitations || !stats.monthly_invitations.length"
            title="Agrandir le graphique"
            aria-label="Agrandir le graphique des invitations mensuelles"
            aria-haspopup="dialog"
          >
            <i class="fas fa-up-right-and-down-left-from-center"></i>
          </button>
        </div>
        <div style="height: 300px; position: relative;">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6">
        <div class="mb-4 flex items-start justify-between gap-3">
          <div>
            <h3 class="text-xl font-bold text-gray-800">
              <i class="fas fa-hourglass-half text-cgt-red mr-2"></i>
              Prochaines élections C5 (2025-2028 · par trimestre)
            </h3>
            <p class="text-xs text-gray-600 mt-1">
              <i class="fas fa-calendar-day mr-1"></i><strong>Source :</strong> Dates prévisionnelles C5 (tous effectifs)
            </p>
          </div>
          <button
            type="button"
            class="inline-flex items-center justify-center w-9 h-9 rounded-lg border border-gray-200 text-gray-600 hover:text-cgt-red hover:border-cgt-red transition disabled:opacity-40 disabled:cursor-not-allowed"
            @click="openChartModal('quarters')"
            :disabled="!stats.upcoming_quarters || !stats.upcoming_quarters.length"
            title="Agrandir le graphique"
            aria-label="Agrandir le graphique des élections C5"
            aria-haspopup="dialog"
          >
            <i class="fas fa-up-right-and-down-left-from-center"></i>
          </button>
        </div>
        <div style="height: 300px; position: relative;">
          <canvas id="quartersChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <section id="statuts" class="space-y-6" :class="{ 'pointer-events-none select-none opacity-60': loading }">
    <header>
      <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
        <i class="fas fa-circle-info text-cgt-red"></i>
        Statut PAP des SIRET C4 ≥ <span x-text="stats.audience_threshold || 1000"></span>
      </h2>
      <p class="text-xs text-gray-600 mt-2">
        <i class="fas fa-database mr-1"></i><strong>Source :</strong> PV C4 • SIRET ≥ <span x-text="stats.audience_threshold || 1000"></span> par statut
      </p>
    </header>

    <div class="mb-4 rounded-xl border border-blue-200 bg-blue-50/70 p-4">
      <p class="text-xs text-blue-900 font-semibold flex items-center gap-2">
        <i class="fas fa-lightbulb"></i>
        Comprendre les statuts PAP
      </p>
      <ul class="mt-2 text-xs text-blue-900/80 space-y-1">
        <li><strong>C4</strong> : PV tenu ou carence enregistrée (2021-2024)</li>
        <li><strong>C3+C4</strong> : Historique C3 mais C4 prioritaire</li>
        <li><strong>Aucun</strong> : Aucun PV consolidé</li>
      </ul>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <template x-for="stat in stats.statut_stats || []" :key="stat.statut">
        <div class="text-center p-4 bg-white rounded-lg border border-gray-200 hover:shadow-md transition">
          <p class="text-2xl font-bold text-cgt-red" x-text="stat.count">0</p>
          <p class="text-sm text-gray-600 mt-1 font-semibold" x-text="stat.statut">-</p>
          <p class="text-xs text-gray-500 mt-1">SIRET</p>
        </div>
      </template>
      <template x-if="!stats.statut_stats || !stats.statut_stats.length">
        <p class="col-span-full text-center text-sm text-gray-500">Les statuts seront affichés dès qu'ils seront disponibles.</p>
      </template>
    </div>
  </section>

  <div
    x-cloak
    x-show="expandedChart"
    x-transition.opacity
    class="fixed inset-0 z-40 flex items-center justify-center bg-black/60 px-4"
    @keydown.escape.window="closeChartModal()"
    role="dialog"
    aria-modal="true"
    aria-labelledby="chartModalTitle"
    aria-describedby="chartModalSource"
  >
    <div class="absolute inset-0" @click="closeChartModal()"></div>
    <div class="relative z-10 w-full max-w-6xl bg-white rounded-2xl shadow-2xl border border-gray-200 p-6 space-y-4">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h2
            id="chartModalTitle"
            class="text-base font-semibold uppercase tracking-widest text-cgt-red"
            x-text="getChartTitle(expandedChart)"
          ></h2>
          <p
            id="chartModalSource"
            class="text-xs text-gray-500 mt-1"
            x-text="getChartSource(expandedChart)"
          ></p>
        </div>
        <button
          type="button"
          class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 text-gray-600 hover:bg-cgt-red hover:text-white transition"
          @click="closeChartModal()"
          title="Fermer"
        >
          <i class="fas fa-xmark text-lg"></i>
        </button>
      </div>
      <div class="h-[70vh]">
        <canvas id="expandedChartCanvas"></canvas>
      </div>
    </div>
  </div>
</section>

<script>
  function dashboardData() {
    return {
      stats: {},
      loading: false,
      loadingProgress: 0,
      progressTimer: null,
      charts: {},
      expandedChart: null,

      beginProgress() {
        this.loadingProgress = 5;
        this.clearProgressTimer();
        this.progressTimer = setInterval(() => {
          if (this.loadingProgress >= 90) {
            return;
          }
          const remaining = 90 - this.loadingProgress;
          const step = Math.max(1, Math.round(remaining * 0.2));
          this.loadingProgress = Math.min(90, this.loadingProgress + step);
        }, 250);
      },

      clearProgressTimer() {
        if (this.progressTimer) {
          clearInterval(this.progressTimer);
          this.progressTimer = null;
        }
      },

      finishProgress() {
        this.clearProgressTimer();
        this.loadingProgress = 100;
        setTimeout(() => {
          this.loading = false;
          this.loadingProgress = 0;
        }, 400);
      },

      async loadStats() {
        if (this.loading) {
          return;
        }
        this.loading = true;
        this.closeChartModal();
        this.beginProgress();
        try {
          const response = await fetch('/api/stats/dashboard');
          if (!response.ok) {
            throw new Error('Réponse invalide du serveur');
          }
          this.stats = await response.json();

          this.$nextTick(() => {
            this.renderDepartmentsChart();
            this.renderMonthlyChart();
            this.renderQuarterChart();
          });
        } catch (error) {
          console.error('Error loading stats:', error);
          showToast('Erreur lors du chargement des statistiques', 'error');
        } finally {
          this.finishProgress();
        }
      },

      formatUpcomingPeriod(start, end) {
        if (start && end) {
          if (start === end) {
            return start;
          }
          return `${start} → ${end}`;
        }
        return start || end || '—';
      },

      renderDepartmentsChart() {
        const canvas = document.getElementById('departmentsChart');
        if (!canvas) return;

        if (!this.stats.departments || !this.stats.departments.length) {
          this.destroyChart('departments');
          return;
        }

        const config = this.getChartConfig('departments');
        this.createOrUpdateChart('departments', canvas, config);
      },

      renderMonthlyChart() {
        const canvas = document.getElementById('monthlyChart');
        if (!canvas) return;

        if (!this.stats.monthly_invitations || !this.stats.monthly_invitations.length) {
          this.destroyChart('monthly');
          return;
        }

        const config = this.getChartConfig('monthly');
        this.createOrUpdateChart('monthly', canvas, config);
      },

      renderQuarterChart() {
        const canvas = document.getElementById('quartersChart');
        if (!canvas) return;

        if (!this.stats.upcoming_quarters || !this.stats.upcoming_quarters.length) {
          this.destroyChart('quarters');
          return;
        }

        const config = this.getChartConfig('quarters');
        this.createOrUpdateChart('quarters', canvas, config);
      },

      createOrUpdateChart(key, canvas, config) {
        if (!canvas || !config) {
          return;
        }

        this.destroyChart(key);
        this.charts[key] = new Chart(canvas, config);
      },

      destroyChart(key) {
        if (this.charts[key]) {
          this.charts[key].destroy();
          delete this.charts[key];
        }
      },

      getSharedChartOptions() {
        return {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                precision: 0
              }
            }
          }
        };
      },

      getChartConfig(key, expanded = false) {
        if (!this.stats) {
          return null;
        }

        const options = this.getSharedChartOptions();

        if (expanded) {
          options.plugins = options.plugins || {};
          options.plugins.title = {
            display: true,
            text: this.getChartTitle(key),
            font: {
              size: 18,
              weight: 'bold'
            }
          };
        }

        switch (key) {
          case 'departments': {
            if (!this.stats.departments || !this.stats.departments.length) {
              return null;
            }
            const threshold = this.stats.audience_threshold || 1000;
            return {
              type: 'bar',
              data: {
                labels: this.stats.departments.map(d => d.dep),
                datasets: [{
                  label: `SIRET ≥ ${threshold} inscrits`,
                  data: this.stats.departments.map(d => d.count),
                  backgroundColor: '#d5001c',
                  borderColor: '#ab0015',
                  borderWidth: 1
                }]
              },
              options
            };
          }
          case 'monthly': {
            if (!this.stats.monthly_invitations || !this.stats.monthly_invitations.length) {
              return null;
            }
            return {
              type: 'line',
              data: {
                labels: this.stats.monthly_invitations.map(m => m.label || m.month),
                datasets: [{
                  label: 'Invitations PAP C5',
                  data: this.stats.monthly_invitations.map(m => m.count),
                  borderColor: '#d5001c',
                  backgroundColor: 'rgba(213, 0, 28, 0.1)',
                  fill: true,
                  tension: 0.4
                }]
              },
              options
            };
          }
          case 'quarters': {
            if (!this.stats.upcoming_quarters || !this.stats.upcoming_quarters.length) {
              return null;
            }
            return {
              type: 'bar',
              data: {
                labels: this.stats.upcoming_quarters.map(q => q.label),
                datasets: [{
                  label: "Nombre d'élections C5 déclarées",
                  data: this.stats.upcoming_quarters.map(q => q.count),
                  backgroundColor: '#f97316',
                  borderColor: '#ea580c',
                  borderWidth: 1
                }]
              },
              options
            };
          }
          default:
            return null;
        }
      },

      openChartModal(key) {
        const config = this.getChartConfig(key, true);
        if (!config) {
          return;
        }

        this.expandedChart = key;
        document.body.classList.add('overflow-hidden');

        this.$nextTick(() => {
          const canvas = document.getElementById('expandedChartCanvas');
          if (!canvas) {
            return;
          }
          this.createOrUpdateChart('expanded', canvas, config);
        });
      },

      closeChartModal() {
        this.destroyChart('expanded');
        this.expandedChart = null;
        document.body.classList.remove('overflow-hidden');
      },

      getChartTitle(key) {
        const threshold = this.stats?.audience_threshold || 1000;
        switch (key) {
          case 'departments':
            return `Top 10 départements (C4 ≥ ${threshold} inscrit·es)`;
          case 'monthly':
            return 'Invitations mensuelles (toutes PAP C5)';
          case 'quarters':
            return "Déclarations d'élections C5 (2025-2028)";
          default:
            return 'Graphique';
        }
      },

      getChartSource(key) {
        const threshold = this.stats?.audience_threshold || 1000;
        switch (key) {
          case 'departments':
            return 'Source : PV C4 — SIRET prioritaires par département';
          case 'monthly':
            return 'Source : Invitations C5 (toutes entrées)';
          case 'quarters':
            return 'Source : Dates prévisionnelles C5 (cycle complet)';
          default:
            return '';
        }
      }
    }
  }
</script>
{% endblock %}
