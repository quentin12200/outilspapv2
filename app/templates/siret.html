{% extends "base.html" %}
{% block title %}{{ row.siret if row else 'SIRET inconnu' }} — PAP/CSE{% endblock %}
{% block content %}
{% if not row %}
  <p>SIRET introuvable.</p>
{% else %}
<article>
  <header>
    <h3 style="margin:0">{{ row.raison_sociale or '(raison manquante)' }}</h3>
    <small>SIRET {{ row.siret }} — IDCC {{ row.idcc or '–' }} — {{ row.ville or '' }} ({{ row.cp or '' }})</small>
  </header>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
    <div>
      <h5>Cycle 3</h5>
      <ul>
        <li>Date PV: <strong>{{ row.date_pv_c3 or '–' }}</strong></li>
        <li>Carence: <strong>{{ 'Oui' if row.carence_c3 else 'Non' }}</strong></li>
        <li>Inscrits: {{ row.inscrits_c3 or '–' }}, Votants: {{ row.votants_c3 or '–' }}</li>
        <li>Voix CGT: {{ row.cgt_voix_c3 or '–' }}</li>
        <li>UD: {{ row.ud_c3 or '–' }}, FD: {{ row.fd_c3 or '–' }}</li>
      </ul>
    </div>
    <div>
      <h5>Cycle 4</h5>
      <ul>
        <li>Date PV: <strong>{{ row.date_pv_c4 or '–' }}</strong></li>
        <li>Carence: <strong>{{ 'Oui' if row.carence_c5 else 'Non' }}</strong></li>
        <li>Inscrits: {{ row.inscrits_c4 or '–' }}, Votants: {{ row.votants_c4 or '–' }}</li>
        <li>Voix CGT: {{ row.cgt_voix_c4 or '–' }}</li>
        <li>UD: {{ row.ud_c4 or '–' }}, FD: {{ row.fd_c4 or '–' }}</li>
      </ul>
    </div>
  </div>

  <p>Statut: <strong>{{ row.statut_pap }}</strong> — Dernier PV: <strong>{{ row.date_pv_max or '–' }}</strong> — Dernier PAP (C5): <strong>{{ row.date_pap_c5 or '–' }}</strong></p>
  <p>Implantation CGT: {% if row.cgt_implantee %}<span class="badge ok">Oui</span>{% else %}<span class="badge">Non</span>{% endif %}</p>
</article>

<article>
  <header><strong>Évolution inscrits / votants / voix CGT</strong></header>
  <div id="ts" style="height:360px"></div>
  <script>
  fetch(`/api/siret/{{ row.siret }}/timeseries`).then(r=>r.json()).then(data=>{
    const fig = [
      {x:data.dates, y:data.inscrits, type:'scatter', mode:'lines+markers', name:'Inscrits'},
      {x:data.dates, y:data.votants,  type:'scatter', mode:'lines+markers', name:'Votants'},
      {x:data.dates, y:data.cgt_voix, type:'scatter', mode:'lines+markers', name:'Voix CGT'}
    ];
    Plotly.newPlot('ts', fig, {margin:{l:30,r:10,t:10,b:30}});
  });
  </script>
</article>
{% endif %}
{% endblock %}
